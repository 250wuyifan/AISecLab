{% extends "base.html" %}

{% block extra_css %}
<style>
.lab-sidebar-list .nav-link.active { background-color: rgba(13,110,253,0.12); border-radius: 0.375rem; color: var(--primary-color); font-weight: 600; }
.chat-container { display: flex; flex-direction: column; height: calc(100vh - 320px); min-height: 180px; max-height: 340px; background: #fff; border: 1px solid #e2e8f0; border-radius: 4px; }
.chat-messages { flex: 1; padding: 8px 10px; overflow-y: auto; border-bottom: 1px solid #e2e8f0; }
.chat-input { padding: 6px 8px; }
.chat-bubble { max-width: 85%; padding: 6px 10px; border-radius: 4px; font-size: 12.5px; margin-bottom: 4px; }
.chat-bubble.user { background: #1e40af; color: #fff; margin-left: auto; }
.chat-bubble.agent, .chat-bubble.agent-html { background: #f8fafc; border: 1px solid #e2e8f0; color: #1f2937; }
html[data-theme="dark"] .chat-container { background: #1e293b; border-color: #334155; }
html[data-theme="dark"] .chat-messages { border-bottom-color: #334155; }
html[data-theme="dark"] .chat-bubble.agent, html[data-theme="dark"] .chat-bubble.agent-html { background: #334155; border-color: #475569; color: #e2e8f0; }
</style>
{% endblock %}

{% block content %}
<main class="lab-detail-main">
    <div class="lab-detail-container">
    {% url 'playground:lab_list' as lab_list_url %}
    {% include "playground/_lab_detail_header.html" with back_url=lab_list_url back_text="è¿”å›é¶åœºåˆ—è¡¨" title="XSSï¼ˆå‰ç«¯æ¸²æŸ“æœªè¿‡æ»¤ï¼‰é¶åœº" subtitle="å‰ç«¯å°† LLM è¿”å›çš„å†…å®¹å½“ä½œ HTML ç›´æ¥æ¸²æŸ“æ—¶ï¼Œæ”»å‡»è€…å¯é€šè¿‡ Prompt Injection è®© LLM è¾“å‡ºæ¶æ„æ ‡ç­¾ï¼Œå¯¼è‡´ XSSã€‚" show_llm_button=False %}

    {% include "playground/_lab_tools.html" with lab_slug="output_security:xss_render" %}

        <div class="card shadow-sm mb-2">
            <div class="card-header py-1 px-2" style="cursor:pointer" onclick="this.nextElementSibling.classList.toggle('d-none')"><strong class="small">ğŸ“‹ æ¼”ç»ƒæ­¥éª¤</strong></div>
            <div class="card-body d-none" style="padding:6px 10px">
                <ol class="small text-muted mb-1">
                    <li>åœ¨ä¸‹æ–¹è¾“å…¥æ¡†å‘é€æ¶ˆæ¯ï¼›æœ¬é¶åœºã€Œæ¨¡æ‹Ÿ AIã€ä¼šåŸæ ·å›æ˜¾ä½ çš„å†…å®¹ï¼ˆæ¨¡æ‹Ÿè¢« Prompt Injection å LLM è¾“å‡ºæ¶æ„ HTMLï¼‰ï¼›</li>
                    <li>å‰ç«¯ä¼š<strong>æ•…æ„</strong>ç”¨ <code>innerHTML</code> æ¸²æŸ“ AI å›å¤ï¼Œä¸åšè½¬ä¹‰ï¼›</li>
                    <li>å°è¯•è¾“å…¥ï¼š<code>&lt;script&gt;alert(1)&lt;/script&gt;</code> æˆ– <code>&lt;img src=x onerror=alert(document.cookie)&gt;</code>ï¼Œè§‚å¯Ÿ XSS æ•ˆæœã€‚</li>
                </ol>
                <p class="small text-warning mb-0">
                    <strong>è¯´æ˜ï¼š</strong>å®é™…æ”»å‡»ä¸­ï¼Œæ”»å‡»è€…é€šè¿‡é—´æ¥æ³¨å…¥ï¼ˆå¦‚é‚®ä»¶ã€æ–‡æ¡£ï¼‰è®© Copilot/Agent åœ¨å¤„ç†æ—¶è¾“å‡ºä¸Šè¿°æ ‡ç­¾ï¼Œå‰ç«¯æ¸²æŸ“å³è§¦å‘ï¼ˆé›¶ç‚¹å‡»ï¼‰ã€‚æ­¤å¤„ç”¨ã€Œæ¨¡æ‹Ÿå›å¤ã€æ¼”ç¤ºã€‚
                </p>
            </div>
        </div>

        <div class="card shadow-sm mb-2">
            <div class="card-body py-2 px-3">
                <p class="small fw-semibold mb-1">æ¨¡æ‹ŸèŠå¤©ï¼ˆAI å›å¤å°†ç”¨ innerHTML æ¸²æŸ“ï¼‰</p>
                <div class="chat-container">
                    <div id="xss-chat-log" class="chat-messages"></div>
                    <div class="chat-input">
                        <form id="xss-chat-form">
                            <div class="input-group">
                                <input type="text" class="form-control" id="xss-message-input" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œå¯å°è¯• XSS payloadâ€¦" autocomplete="off">
                                <button class="btn btn-primary" type="submit">å‘é€</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header py-1 px-2" style="cursor:pointer" onclick="this.nextElementSibling.classList.toggle('d-none')"><strong class="small">ğŸ”§ æ€ä¹ˆä¿®å¤</strong></div>
            <div class="card-body small d-none" style="padding:6px 10px">
                <ul class="mb-0">
                    <li>å‰ç«¯<strong>ç¦æ­¢</strong>ç”¨ <code>innerHTML</code> ç›´æ¥æ¸²æŸ“ LLM è¾“å‡ºï¼›ç”¨ <code>textContent</code> æˆ–å®‰å…¨çš„ Markdown åº“ï¼ˆå¦‚ marked + DOMPurifyï¼‰ï¼›</li>
                    <li>å¯¹ç”Ÿæˆçš„ HTML/Markdown åšä¸¥æ ¼è¿‡æ»¤ï¼šç¦æ­¢ <code>&lt;script&gt;</code>ã€<code>onerror</code>ã€éç™½åå• <code>src</code>ã€<code>data:</code> URI ç­‰ï¼›</li>
                    <li>è¾“å‡ºåå¤„ç†ï¼šæ‰«æ LLM è¾“å‡ºä¸­æ˜¯å¦å«å¯ç–‘æ ‡ç­¾/å±æ€§ï¼Œå‘Šè­¦æˆ–æ‹¦æˆªï¼›é™åˆ¶ Agent å¯è®¿é—®çš„ä¸Šä¸‹æ–‡ä¸å·¥å…·è°ƒç”¨èŒƒå›´ã€‚</li>
                </ul>
            </div>
        </div>
    </div>
</main>

<script>

// è·å– CSRF Token
function getCsrfToken() {
    var c = document.cookie.match(/csrftoken=([^;]+)/);
    if (c) return c[1];
    var el = document.querySelector('[name="csrfmiddlewaretoken"]');
    return el ? el.value : '';
}
(function () {
    var log = document.getElementById('xss-chat-log');
    var form = document.getElementById('xss-chat-form');
    var input = document.getElementById('xss-message-input');
    var url = '{% url "playground:xss_render_demo_api" %}';

    function appendMsg(role, rawHtml) {
        if (!log) return;
        var wrap = document.createElement('div');
        wrap.className = 'chat-bubble ' + (role === 'user' ? 'user' : 'agent-html');
        if (role === 'user') {
            wrap.textContent = rawHtml;
        } else {
            wrap.innerHTML = rawHtml;
        }
        log.appendChild(wrap);
        log.scrollTop = log.scrollHeight;
    }

    if (form && input) {
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            var text = (input.value || '').trim();
            if (!text) return;
            appendMsg('user', text);
            input.value = '';
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                body: JSON.stringify({ message: text })
            })
            .then(function (r) { return r.json(); })
            .then(function (data) {
                var reply = (data.reply || '').replace(/^AI: /, '');
                appendMsg('agent', reply);
            })
            .catch(function () { appendMsg('agent', 'è¯·æ±‚å¤±è´¥'); });
        });
    }
})();
</script>
{% endblock %}
