<!-- 左侧侧栏：靶场演练分类导航 -->
<nav id="sidebarMenu" class="d-md-block sidebar">
  <div class="sidebar-sticky">
    <div class="sidebar-heading text-uppercase mb-3">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
      </svg>
      靶场演练
    </div>

    <ul class="nav flex-column lab-nav">
      {% for group in lab_groups %}
      <li class="nav-item lab-group">
        <!-- 分类标题栏 -->
        <div class="lab-group-header" data-category-id="{{ group.id }}">
          <div class="lab-group-title">
            {% if group.intro_url %}
            <a href="{{ group.intro_url }}" 
               class="lab-group-link {% if request.path == group.intro_url %}active{% endif %}"
               title="进入分类介绍页">
              <span class="lab-group-icon">
                {% if 'memory' in group.id or '记忆' in group.title %}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                {% elif 'tool' in group.id or '工具' in group.title %}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                </svg>
                {% elif 'mcp' in group.id|lower or 'MCP' in group.title %}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                  <line x1="8" y1="21" x2="16" y2="21"></line>
                  <line x1="12" y1="17" x2="12" y2="21"></line>
                </svg>
                {% elif 'output' in group.id or '输出' in group.title %}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                {% else %}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                {% endif %}
              </span>
              {{ group.title }}
            </a>
            {% else %}
            <span class="lab-group-text">
              <span class="lab-group-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
              </span>
              {{ group.title }}
            </span>
            {% endif %}
          </div>
          <button type="button"
                  class="lab-group-toggle"
                  data-category-id="{{ group.id }}"
                  aria-expanded="true"
                  title="展开/收起">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="toggle-icon">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
        </div>

        <!-- 子项列表 -->
        <ul class="nav flex-column lab-items is-open" data-category-id="{{ group.id }}">
          {% for it in group.items %}
          <li class="nav-item">
            <a class="nav-link lab-item {% if request.path == it.url %}active{% endif %}"
               href="{{ it.url }}">
              <span class="lab-item-title">{{ it.title }}</span>
              {% if it.subtitle %}
              <span class="lab-item-subtitle">{{ it.subtitle }}</span>
              {% endif %}
            </a>
          </li>
          {% endfor %}
        </ul>
      </li>
      {% endfor %}
    </ul>
  </div>
</nav>

<div id="sidebar-resize-handle"></div>

<style>
/* 靶场侧栏专用样式 */
.lab-nav {
  gap: 0.5rem;
}

.lab-group {
  margin-bottom: 0.75rem;
}

.lab-group-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.5rem 0.75rem;
  border-radius: 10px;
  transition: all 0.2s ease;
}

.lab-group-header:hover {
  background: var(--primary-glow);
}

html[data-theme="dark"] .lab-group-header:hover {
  background: rgba(0, 245, 255, 0.1);
}

.lab-group-title {
  flex: 1;
  min-width: 0;
}

.lab-group-link,
.lab-group-text {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.8rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-secondary);
  text-decoration: none;
  transition: color 0.15s ease, text-shadow 0.15s ease;
}

.lab-group-link:hover {
  color: var(--primary-color);
}

.lab-group-link.active {
  color: var(--primary-color);
}

html[data-theme="dark"] .lab-group-link:hover,
html[data-theme="dark"] .lab-group-link.active {
  color: var(--neon-cyan);
  text-shadow: 0 0 10px rgba(0, 245, 255, 0.5);
}

.lab-group-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  border-radius: 6px;
  background: var(--primary-glow);
  flex-shrink: 0;
}

.lab-group-icon svg {
  color: var(--primary-color);
}

html[data-theme="dark"] .lab-group-icon {
  background: rgba(0, 245, 255, 0.15);
}

html[data-theme="dark"] .lab-group-icon svg {
  color: var(--neon-cyan);
}

.lab-group-toggle {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  border: none;
  background: transparent;
  border-radius: 6px;
  color: var(--muted);
  cursor: pointer;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.lab-group-toggle:hover {
  background: var(--surface-2);
  color: var(--text);
}

html[data-theme="dark"] .lab-group-toggle:hover {
  background: rgba(99, 102, 241, 0.2);
  color: var(--neon-cyan);
}

.lab-group-toggle .toggle-icon {
  transition: transform 0.2s ease;
}

.lab-group-toggle[aria-expanded="false"] .toggle-icon {
  transform: rotate(-90deg);
}

/* 子项列表 */
.lab-items {
  display: block;
  margin-top: 0.25rem;
  padding-left: 0.5rem;
  margin-left: 0.75rem;
  border-left: 2px solid var(--border-color);
  overflow: hidden;
  transition: all 0.3s ease;
}

.lab-items:not(.is-open) {
  display: none;
}

html[data-theme="dark"] .lab-items {
  border-left-color: rgba(99, 102, 241, 0.2);
}

.lab-item {
  display: flex;
  flex-direction: column;
  padding: 0.6rem 0.75rem !important;
  margin: 0.25rem 0;
  border-radius: 8px;
  border-left: 2px solid transparent;
  transition: background 0.15s ease, border-color 0.15s ease, transform 0.15s ease, box-shadow 0.15s ease;
}

.lab-item:hover {
  background: var(--primary-glow);
  border-left-color: var(--primary-color);
  transform: translateX(2px);
}

.lab-item.active {
  background: linear-gradient(90deg, var(--primary-glow), transparent);
  border-left-color: var(--primary-color);
}

html[data-theme="dark"] .lab-item:hover {
  background: rgba(0, 245, 255, 0.1);
  border-left-color: var(--neon-cyan);
}

html[data-theme="dark"] .lab-item.active {
  background: linear-gradient(90deg, rgba(0, 245, 255, 0.15), transparent);
  border-left-color: var(--neon-cyan);
  box-shadow: 0 0 15px rgba(0, 245, 255, 0.1);
}

.lab-item-title {
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text);
  line-height: 1.4;
  transition: color 0.15s ease;
}

.lab-item.active .lab-item-title {
  color: var(--primary-color);
  font-weight: 600;
}

html[data-theme="dark"] .lab-item.active .lab-item-title {
  color: var(--neon-cyan);
}

.lab-item-subtitle {
  font-size: 0.75rem;
  color: var(--muted);
  margin-top: 0.2rem;
  line-height: 1.3;
}
</style>

<script>
(function() {
  // 立即执行：在 DOM 解析时就应用状态，避免闪烁
  function applyInitialState() {
    try {
      var state = JSON.parse(localStorage.getItem('lab_sidebar_state') || '{}');
      Object.keys(state).forEach(function(catId) {
        var items = document.querySelector('.lab-items[data-category-id="' + catId + '"]');
        var btn = document.querySelector('.lab-group-toggle[data-category-id="' + catId + '"]');
        if (items && btn) {
          if (state[catId]) {
            items.classList.add('is-open');
            btn.setAttribute('aria-expanded', 'true');
          } else {
            items.classList.remove('is-open');
            btn.setAttribute('aria-expanded', 'false');
          }
        }
      });
    } catch(e) {}
    
    // 确保当前激活的项所在分类是展开的
    var activeItem = document.querySelector('.lab-item.active');
    if (activeItem) {
      var parentItems = activeItem.closest('.lab-items');
      if (parentItems) {
        parentItems.classList.add('is-open');
        var catId = parentItems.getAttribute('data-category-id');
        var btn = document.querySelector('.lab-group-toggle[data-category-id="' + catId + '"]');
        if (btn) btn.setAttribute('aria-expanded', 'true');
        
        // 保存当前展开状态
        try {
          var state = JSON.parse(localStorage.getItem('lab_sidebar_state') || '{}');
          state[catId] = true;
          localStorage.setItem('lab_sidebar_state', JSON.stringify(state));
        } catch(e) {}
      }
    }
  }
  
  // 尽早执行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applyInitialState);
  } else {
    applyInitialState();
  }
  
  // 靶场侧栏折叠/展开逻辑
  document.addEventListener('click', function(e) {
    var btn = e.target.closest('.lab-group-toggle');
    if (!btn) return;
    
    e.preventDefault();
    e.stopPropagation();
    
    var catId = btn.getAttribute('data-category-id');
    if (!catId) return;
    
    var items = document.querySelector('.lab-items[data-category-id="' + catId + '"]');
    if (!items) return;
    
    var isOpen = items.classList.contains('is-open');
    items.classList.toggle('is-open', !isOpen);
    btn.setAttribute('aria-expanded', !isOpen ? 'true' : 'false');
    
    // 保存状态到 localStorage
    try {
      var state = JSON.parse(localStorage.getItem('lab_sidebar_state') || '{}');
      state[catId] = !isOpen;
      localStorage.setItem('lab_sidebar_state', JSON.stringify(state));
    } catch(e) {}
  });
  
  // 侧栏链接点击：更新 active 状态（无需等待页面刷新）
  document.addEventListener('click', function(e) {
    var link = e.target.closest('.lab-item');
    if (!link) return;
    
    // 立即更新 active 状态，提供即时反馈
    document.querySelectorAll('.lab-item.active').forEach(function(el) {
      el.classList.remove('active');
    });
    link.classList.add('active');
    
    // 同时更新分类链接的 active 状态
    document.querySelectorAll('.lab-group-link.active').forEach(function(el) {
      el.classList.remove('active');
    });
  });
  
  // 分类链接点击：更新 active 状态
  document.addEventListener('click', function(e) {
    var link = e.target.closest('.lab-group-link');
    if (!link) return;
    
    // 立即更新 active 状态
    document.querySelectorAll('.lab-group-link.active').forEach(function(el) {
      el.classList.remove('active');
    });
    link.classList.add('active');
    
    // 同时清除子项的 active 状态
    document.querySelectorAll('.lab-item.active').forEach(function(el) {
      el.classList.remove('active');
    });
  });
})();
</script>
