{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<style>
/* æœ¬é¡µä¸“å±æ ·å¼ï¼šåœºæ™¯å¡ç‰‡ã€èŠå¤©æ°”æ³¡ã€éªŒè¯é¢æ¿ç­‰ï¼›å¸ƒå±€ä¸å¤´éƒ¨ä½¿ç”¨ lab_detail.css + _lab_detail_header */
/* åœºæ™¯å¡ç‰‡ */
.scenario-card {
    background: #fff;
    border: 1px solid var(--border-color);
    padding: 12px;
    margin-bottom: 8px;
    cursor: pointer;
}
.scenario-card:hover { background: #fafafa; }
.scenario-card.active {
    border-color: var(--primary-color);
    background: #f0f5ff;
}
html[data-theme="dark"] .scenario-card {
    background: var(--surface);
    border-color: var(--border-color);
}
html[data-theme="dark"] .scenario-card:hover { background: var(--surface-2); }
html[data-theme="dark"] .scenario-card.active {
    border-color: var(--primary-color);
    background: var(--surface-2);
}

.scenario-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}
.scenario-icon { font-size: 16px; }
.scenario-title {
    font-size: 14px;
    font-weight: 500;
    flex: 1;
    color: var(--text);
}
html[data-theme="dark"] .scenario-title { color: var(--text); }

.scenario-badge {
    font-size: 12px;
    padding: 2px 6px;
    background: #f0f0f0;
    color: #666;
}
html[data-theme="dark"] .scenario-badge {
    background: var(--border-color);
    color: var(--muted);
}

.scenario-desc {
    font-size: 13px;
    color: #666;
    margin-bottom: 8px;
    line-height: 1.4;
}
html[data-theme="dark"] .scenario-desc { color: var(--muted); }

.scenario-prompt {
    background: var(--surface-2);
    border: 1px solid var(--text);
    padding: 10px;
    font-size: 13px;
    display: none;
    color: #333;
}
.scenario-card.active .scenario-prompt { display: block; }
html[data-theme="dark"] .scenario-prompt {
    background: var(--surface-2);
    border-color: var(--border-color);
    color: #ccc;
}

/* èŠå¤©å®¹å™¨ */
.chat-container {
    display: flex;
    flex-direction: column;
    height: 480px;
    background: #fff;
    border: 1px solid var(--text);
    border-radius: 6px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}

html[data-theme="dark"] .chat-container {
    background: var(--surface);
    border-color: var(--border-color);
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
}

.chat-message {
    display: flex;
    gap: 10px;
    margin-bottom: 14px;
    max-width: 82%;
}

.chat-message.user {
    margin-left: auto;
    flex-direction: row-reverse;
}

.chat-message.agent {
    margin-right: auto;
}

.chat-avatar {
    width: 32px;
    height: 32px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 14px;
    border: 1px solid var(--text);
    background: var(--surface-2);
}

html[data-theme="dark"] .chat-avatar {
    background: var(--surface-2);
    border-color: var(--border-color);
}

.chat-bubble {
    padding: 10px 14px;
    border-radius: 6px;
    font-size: 14px;
    line-height: 1.5;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.chat-message.user .chat-bubble {
    background: var(--primary-color);
    color: #fff;
}

.chat-message.agent .chat-bubble {
    background: var(--surface-2);
    color: var(--text);
    border: 1px solid var(--text);
}

html[data-theme="dark"] .chat-message.user .chat-bubble {
    background: var(--primary-color);
}

html[data-theme="dark"] .chat-message.agent .chat-bubble {
    background: var(--surface-2);
    color: var(--text);
    border-color: var(--border-color);
}

.chat-bubble pre {
    background: rgba(0,0,0,0.06);
    padding: 8px 10px;
    border-radius: 4px;
    overflow-x: auto;
    font-size: 13px;
    margin: 8px 0 0;
    font-family: 'SF Mono', Consolas, monospace;
}

html[data-theme="dark"] .chat-bubble pre {
    background: rgba(0,0,0,0.25);
}

/* è¾“å…¥åŒº */
.chat-input-area {
    display: flex;
    gap: 10px;
    padding: 12px 16px;
    background: var(--surface-2);
    border-top: 1px solid var(--text);
}

html[data-theme="dark"] .chat-input-area {
    background: var(--surface-2);
    border-top-color: var(--border-color);
}

.chat-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: #fff;
    color: var(--text);
    font-size: 14px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
}

.chat-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(37,99,235,0.1);
}

html[data-theme="dark"] .chat-input {
    background: var(--surface);
    border-color: var(--border-color);
    color: var(--text);
}

html[data-theme="dark"] .chat-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(59,130,246,0.15);
}

.chat-send-btn {
    padding: 8px 16px;
    background: var(--primary-color);
    border: 1px solid #1e3a8a;
    border-radius: 4px;
    color: #fff;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: inherit;
}

.chat-send-btn:hover {
    background: #1e3a8a;
}

.chat-send-btn:active {
    transform: scale(0.98);
}

.chat-send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

html[data-theme="dark"] .chat-send-btn {
    background: var(--primary-color);
    border-color: var(--primary-color);
}

html[data-theme="dark"] .chat-send-btn:hover {
    background: var(--primary-color);
}

/* éªŒè¯é¢æ¿ */
.verify-panel {
    background: #fff;
    border: 1px solid var(--border-color);
    padding: 14px;
}
html[data-theme="dark"] .verify-panel {
    background: var(--surface);
    border-color: var(--border-color);
}

.verify-item {
    padding: 10px;
    border: 1px solid var(--text);
    margin-bottom: 8px;
    font-size: 13px;
}
html[data-theme="dark"] .verify-item {
    border-color: var(--border-color);
}

.verify-item.true {
    border-color: #86efac;
    background: #f0fdf4;
}
.verify-item.false {
    border-color: #fca5a5;
    background: #fef2f2;
}
html[data-theme="dark"] .verify-item.true {
    background: #14532d;
    border-color: #22c55e;
}
html[data-theme="dark"] .verify-item.false {
    background: #7f1d1d;
    border-color: #ef4444;
}

.verify-label {
    font-weight: 500;
    margin-bottom: 4px;
}

/* å¹»è§‰æ£€æµ‹ç»“æœ */
.hallucination-result {
    background: #fffbeb;
    border: 1px solid #fcd34d;
    padding: 10px 12px;
    margin-top: 12px;
    display: none;
    font-size: 14px;
}
.hallucination-result.show { display: block; }
.hallucination-result.success {
    background: #f0fdf4;
    border-color: #86efac;
}
.hallucination-result.danger {
    background: #fef2f2;
    border-color: #fca5a5;
}
html[data-theme="dark"] .hallucination-result {
    background: #78350f;
    border-color: #f59e0b;
}
html[data-theme="dark"] .hallucination-result.success {
    background: #14532d;
    border-color: #22c55e;
}
html[data-theme="dark"] .hallucination-result.danger {
    background: #7f1d1d;
    border-color: #ef4444;
}
.hallucination-result.warning {
    background: #fffbeb;
    border-color: #fbbf24;
}
html[data-theme="dark"] .hallucination-result.warning {
    background: #78350f;
    border-color: #f59e0b;
}
.hallucination-result.critical {
    background: #fef2f2;
    border-color: #dc2626;
    border-width: 2px;
    animation: pulse-critical 1s ease-in-out;
}
html[data-theme="dark"] .hallucination-result.critical {
    background: #450a0a;
    border-color: #dc2626;
}
@keyframes pulse-critical {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

</style>
{% endblock %}

{% block content %}
<main class="lab-detail-main">
    <div class="lab-detail-container">
        {% url 'playground:lab_list' as lab_list_url %}
        {% include "playground/_lab_detail_header.html" with back_url=lab_list_url back_text="è¿”å›åˆ—è¡¨" title="å¹»è§‰åˆ©ç”¨é¶åœº" title_icon="ğŸŒ€" subtitle="OWASP LLM09 Â· å¤šä¸ªæ”»å‡»åœºæ™¯ Â· éš¾åº¦ï¼šä¸­ç­‰" show_llm_button=True current_model=current_model %}


        {% include "playground/_llm_not_configured_alert.html" %}


        <!-- åŸç†è®²è§£ -->
        {% include "playground/_principle_panel.html" %}

        <div class="row g-3">
            <!-- å·¦ä¾§ï¼šåœºæ™¯é€‰æ‹© -->
            <div class="col-xl-3 col-lg-4">
                <div class="card">
                    <div class="card-header d-flex align-items-center">
                        <span class="me-2">ğŸ­</span>
                        <strong>æ”»å‡»åœºæ™¯</strong>
                    </div>
                    <div class="card-body" style="max-height: 550px; overflow-y: auto;">
                        {% for scenario in scenarios %}
                        <div class="scenario-card" data-id="{{ scenario.id }}" onclick="selectScenario(this, '{{ scenario.id }}')">
                            <div class="scenario-header">
                                <span class="scenario-icon">{{ scenario.icon }}</span>
                                <span class="scenario-title">{{ scenario.name }}</span>
                                <span class="scenario-badge">{{ scenario.category }}</span>
                            </div>
                            <div class="scenario-desc">{{ scenario.description }}</div>
                            <div class="scenario-prompt">
                                <strong class="small">æµ‹è¯•æç¤ºï¼š</strong><br>
                                {{ scenario.prompt }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´ï¼šå¯¹è¯åŒº -->
            <div class="col-xl-6 col-lg-5">
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <div class="chat-message agent">
                            <div class="chat-avatar">ğŸŒ€</div>
                            <div class="chat-bubble">ä½ å¥½ï¼æˆ‘æ˜¯å¹»è§‰æµ‹è¯•åŠ©æ‰‹ï¼Œå¯ä»¥å¸®ä½ æµ‹è¯• AI çš„å¹»è§‰å€¾å‘ã€‚<br><br><small style="color: var(--muted);">ğŸ’¡ é€‰æ‹©å·¦ä¾§çš„æ”»å‡»åœºæ™¯ï¼Œæˆ–ç›´æ¥è¾“å…¥é—®é¢˜æ¥æµ‹è¯•</small></div>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="user-input" placeholder="è¾“å…¥é—®é¢˜æˆ–ç‚¹å‡»å·¦ä¾§åœºæ™¯..." autocomplete="off" onkeypress="if(event.key==='Enter'){sendMessage();return false;}">
                        <button type="button" class="chat-send-btn" onclick="sendMessage()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                            å‘é€
                        </button>
                    </div>
                </div>

                <div class="hallucination-result" id="hallucination-result">
                    <span style="font-size: 1.25rem;" id="result-icon">âš ï¸</span>
                    <strong id="result-title">æ£€æµ‹åˆ°å¹»è§‰</strong>
                    <p class="small mb-0" id="result-desc">AI çš„å›ç­”åŒ…å«è™šæ„æˆ–ä¸å‡†ç¡®çš„ä¿¡æ¯ã€‚</p>
                </div>
            </div>

            <!-- å³ä¾§ï¼šéªŒè¯åŒº -->
            <div class="col-xl-3 col-lg-3">
                <div class="verify-panel mb-3">
                    <h6 class="mb-3 d-flex align-items-center">
                        <span class="me-2">âœ…</span>
                        äº‹å®æ ¸æŸ¥
                    </h6>
                    <div id="verify-facts">
                        <p class="text-muted small text-center py-3">
                            å‘é€æ¶ˆæ¯åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºäº‹å®æ ¸æŸ¥ç»“æœ
                        </p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex align-items-center">
                        <span class="me-2">ğŸ“Š</span>
                        <strong>ç»Ÿè®¡</strong>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>æµ‹è¯•æ¬¡æ•°</span>
                            <strong id="test-count">0</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>æ£€æµ‹åˆ°å¹»è§‰</span>
                            <strong id="hallucination-count" class="text-warning">0</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>å¹»è§‰ç‡</span>
                            <strong id="hallucination-rate">0%</strong>
                        </div>
                        <hr>
                        <button class="btn btn-sm btn-outline-secondary w-100" onclick="resetChat()">
                            ğŸ”„ é‡ç½®
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- LLM é…ç½®å¼¹çª— -->

<script>
let testCount = 0;
let hallucinationCount = 0;
let chatHistory = [];
let currentScenario = null;

const SCENARIOS = {{ scenarios_json|safe }};

function selectScenario(card, scenarioId) {
    // å–æ¶ˆå…¶ä»–é€‰ä¸­
    document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('active'));
    card.classList.add('active');
    
    // æ‰¾åˆ°åœºæ™¯æ•°æ®
    currentScenario = SCENARIOS.find(s => s.id === scenarioId);
    if (currentScenario) {
        document.getElementById('user-input').value = currentScenario.prompt;
        document.getElementById('user-input').focus();
    }
}

function addMessage(role, content) {
    const messagesDiv = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${role}`;
    const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸŒ€';
    messageDiv.innerHTML = `
        <div class="chat-avatar">${avatar}</div>
        <div class="chat-bubble">${content}</div>
    `;
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function updateStats() {
    document.getElementById('test-count').textContent = testCount;
    document.getElementById('hallucination-count').textContent = hallucinationCount;
    const rate = testCount > 0 ? Math.round((hallucinationCount / testCount) * 100) : 0;
    document.getElementById('hallucination-rate').textContent = rate + '%';
}

function showVerification(facts) {
    const container = document.getElementById('verify-facts');
    container.innerHTML = '';
    
    for (const fact of facts) {
        const div = document.createElement('div');
        div.className = `verify-item ${fact.verified ? 'true' : 'false'}`;
        div.innerHTML = `
            <div class="verify-label">${fact.verified ? 'âœ…' : 'âŒ'} ${fact.claim}</div>
            <div class="small text-muted">${fact.explanation}</div>
        `;
        container.appendChild(div);
    }
}

function showHallucinationResult(isHallucination, description, riskLevel, confidenceScore) {
    const result = document.getElementById('hallucination-result');
    result.classList.add('show');
    
    // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
    result.classList.remove('success', 'danger', 'warning', 'critical');
    
    if (isHallucination) {
        // æ ¹æ®é£é™©ç­‰çº§è®¾ç½®æ ·å¼
        let icon = 'âš ï¸';
        let title = 'æ£€æµ‹åˆ°å¹»è§‰';
        let levelClass = 'danger';
        let levelText = 'ä¸­é£é™©';
        
        switch (riskLevel) {
            case 'critical':
                icon = 'ğŸš¨';
                title = 'ä¸¥é‡å¹»è§‰ï¼';
                levelClass = 'critical';
                levelText = 'æé«˜é£é™©';
                break;
            case 'high':
                icon = 'âš ï¸';
                title = 'é«˜é£é™©å¹»è§‰';
                levelClass = 'danger';
                levelText = 'é«˜é£é™©';
                break;
            case 'medium':
                icon = 'âš¡';
                title = 'æ£€æµ‹åˆ°å¹»è§‰';
                levelClass = 'warning';
                levelText = 'ä¸­é£é™©';
                break;
            case 'low':
                icon = 'ğŸ’¡';
                title = 'å¯èƒ½çš„å¹»è§‰';
                levelClass = 'warning';
                levelText = 'ä½é£é™©';
                break;
        }
        
        result.classList.add(levelClass);
        document.getElementById('result-icon').textContent = icon;
        document.getElementById('result-title').innerHTML = `${title} <span class="badge bg-${levelClass === 'critical' ? 'danger' : levelClass}" style="font-size: 10px; margin-left: 6px;">${levelText}</span>`;
        
        // æ˜¾ç¤ºç½®ä¿¡åº¦
        let descHtml = description || 'AI çš„å›ç­”åŒ…å«è™šæ„æˆ–ä¸å‡†ç¡®çš„ä¿¡æ¯ã€‚';
        if (confidenceScore) {
            descHtml += `<br><small style="color: var(--muted);">æ£€æµ‹ç½®ä¿¡åº¦: ${confidenceScore}%</small>`;
        }
        document.getElementById('result-desc').innerHTML = descHtml;
        
        hallucinationCount++;
    } else {
        result.classList.add('success');
        document.getElementById('result-icon').textContent = 'âœ…';
        document.getElementById('result-title').textContent = 'æœªæ£€æµ‹åˆ°æ˜æ˜¾å¹»è§‰';
        
        let descHtml = description || 'AI çš„å›ç­”çœ‹èµ·æ¥æ˜¯å‡†ç¡®çš„ï¼Œä½†ä»å»ºè®®ç‹¬ç«‹éªŒè¯é‡è¦ä¿¡æ¯ã€‚';
        if (confidenceScore) {
            descHtml += `<br><small style="color: var(--muted);">æ£€æµ‹ç½®ä¿¡åº¦: ${confidenceScore}%</small>`;
        }
        document.getElementById('result-desc').innerHTML = descHtml;
    }
    
    updateStats();
}

async function sendMessage() {
    const input = document.getElementById('user-input');
    const message = input.value.trim();
    if (!message) return;
    
    // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    addMessage('user', message);
    input.value = '';
    testCount++;
    
    // æ·»åŠ åˆ°å†å²
    chatHistory.push({role: 'user', content: message});
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    addMessage('agent', '<div class="spinner-border spinner-border-sm me-2"></div>æ€è€ƒä¸­...');
    
    try {
        const response = await fetch('{% url "playground:hallucination_chat_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                message: message,
                history: chatHistory,
                scenario: currentScenario ? currentScenario.id : null
            })
        });
        
        const data = await response.json();
        
        // ç§»é™¤åŠ è½½çŠ¶æ€
        const messages = document.getElementById('chat-messages');
        messages.removeChild(messages.lastChild);
        
        if (data.success) {
            addMessage('agent', data.response);
            chatHistory.push({role: 'assistant', content: data.response});
            
            // æ˜¾ç¤ºéªŒè¯ç»“æœ
            if (data.facts) {
                showVerification(data.facts);
            }
            
            // æ˜¾ç¤ºå¹»è§‰æ£€æµ‹ç»“æœ
            showHallucinationResult(data.is_hallucination, data.hallucination_reason, data.risk_level, data.confidence_score);
        } else {
            addMessage('agent', 'âŒ ' + (data.error || 'è¯·æ±‚å¤±è´¥'));
        }
    } catch (error) {
        const messages = document.getElementById('chat-messages');
        messages.removeChild(messages.lastChild);
        addMessage('agent', 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message);
    }
    
    updateStats();
}

function resetChat() {
    chatHistory = [];
    testCount = 0;
    hallucinationCount = 0;
    currentScenario = null;
    
    document.getElementById('chat-messages').innerHTML = `<div class="chat-message agent"><div class="chat-avatar">ğŸŒ€</div><div class="chat-bubble">ä½ å¥½ï¼æˆ‘æ˜¯å¹»è§‰æµ‹è¯•åŠ©æ‰‹ï¼Œå¯ä»¥å¸®ä½ æµ‹è¯• AI çš„å¹»è§‰å€¾å‘ã€‚<br><br><small style="color: var(--muted);">ğŸ’¡ é€‰æ‹©å·¦ä¾§çš„æ”»å‡»åœºæ™¯ï¼Œæˆ–ç›´æ¥è¾“å…¥é—®é¢˜æ¥æµ‹è¯•</small></div></div>`;
    document.getElementById('verify-facts').innerHTML = `<p class="text-muted small text-center py-3">å‘é€æ¶ˆæ¯åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºäº‹å®æ ¸æŸ¥ç»“æœ</p>`;
    document.getElementById('hallucination-result').classList.remove('show');
    document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('active'));
    
    updateStats();
}
</script>
{% endblock %}
