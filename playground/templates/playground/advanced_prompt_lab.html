{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'playground/css/lab_detail.css' %}">
<style>
/* â”€â”€ æœ¬é¡µå†…è”è¦†ç›–ï¼šç´§å‡‘å¸ƒå±€ â”€â”€ */
.adv-chat-messages { height:calc(100vh - 340px); min-height:200px; max-height:420px; overflow-y:auto; padding:8px 10px; background:var(--bg-2); border:1px solid var(--border-color); border-radius:4px; }
html[data-theme="dark"] .adv-chat-messages { background:var(--surface); }
.chat-msg { margin-bottom:6px; display:flex; }
.chat-msg.user { justify-content:flex-end; }
.chat-msg.ai { justify-content:flex-start; }
.chat-msg .chat-bubble { max-width:82%; padding:6px 10px; border-radius:8px; font-size:12.5px; line-height:1.5; white-space:pre-wrap; word-break:break-word; }
.chat-msg.user .chat-bubble { background:var(--primary-color); color:#fff; border-bottom-right-radius:3px; }
.chat-msg.ai .chat-bubble { background:var(--surface); border:1px solid var(--border-color); color:var(--text); border-bottom-left-radius:3px; }
html[data-theme="dark"] .chat-msg.user .chat-bubble { background:#1d4ed8; }
/* ç³»ç»Ÿæç¤ºç¼–è¾‘å™¨ */
.prompt-editor { font-family:Consolas,'SF Mono',monospace; font-size:11px; min-height:120px; resize:vertical; }
/* URL é¢„è§ˆ */
.url-preview { background:#fef3c7; border:1px solid #fbbf24; padding:4px 8px; font-family:monospace; font-size:11px; border-radius:3px; word-break:break-all; }
html[data-theme="dark"] .url-preview { background:#78350f; border-color:#f59e0b; color:#fef3c7; }
/* Token bar */
.token-bar { height:14px; background:#e2e8f0; border-radius:7px; overflow:hidden; }
.token-bar-fill { height:100%; border-radius:7px; transition:width .5s ease; }
.token-bar-fill.low { background:#22c55e; } .token-bar-fill.mid { background:#f59e0b; } .token-bar-fill.high { background:#ef4444; }
/* æ³„éœ²é«˜äº® */
.leak-highlight { background:#fef08a; color:#92400e; padding:0 3px; border-radius:2px; font-weight:600; }
html[data-theme="dark"] .leak-highlight { background:#854d0e; color:#fef08a; }
/* ç»Ÿè®¡æ•°å­— */
.stat-number { font-size:20px; font-weight:700; color:var(--primary-color); line-height:1.2; }
.stat-label { font-size:11px; color:var(--muted); }
/* ç³»ç»Ÿæç¤ºæ˜¾ç¤º */
.system-prompt-display { background:#fefce8; border:1px solid #fde68a; padding:6px 8px; font-family:monospace; font-size:10px; white-space:pre-wrap; border-radius:3px; max-height:120px; overflow-y:auto; display:none; }
html[data-theme="dark"] .system-prompt-display { background:#422006; border-color:#92400e; color:#fef3c7; }
</style>
{% endblock %}

{% block content %}
<main class="lab-detail-main"><div class="lab-detail-container">
    {% url 'playground:lab_list' as lab_list_url %}
    {% include "playground/_lab_detail_header.html" with back_url=lab_list_url back_text="è¿”å›é¶åœºåˆ—è¡¨" title=config.title title_icon=config.title_icon subtitle=config.subtitle show_llm_button=True current_model=current_model %}
    {% include "playground/_llm_not_configured_alert.html" %}

    <div class="row g-3">
        <!-- â•â•â• å·¦æ ï¼šæ”»å‡»åŒº â•â•â• -->
        <div class="col-lg-9">
            <div class="row g-2">
                <!-- æ”»å‡»åŸç†ï¼ˆæŠ˜å ï¼‰ -->
                <div class="col-12">
                    <div class="card principle-card">
                        <div class="card-header d-flex justify-content-between align-items-center py-1 px-2" style="cursor:pointer" onclick="this.nextElementSibling.classList.toggle('d-none')">
                            <strong class="small">ğŸ”¬ æ”»å‡»åŸç†</strong>
                            <small class="text-muted" style="font-size:10px">å±•å¼€/æ”¶èµ·</small>
                        </div>
                        <div class="card-body d-none" style="font-size:12px;padding:6px 10px">
                            {{ config.attack_principle|safe }}
                            {% if config.vuln_root_cause %}
                            <div class="mt-1 p-1 bg-opacity-10 bg-danger rounded" style="font-size:11px">
                                <strong>ğŸ¯ æ¼æ´æ ¹å› ï¼š</strong>{{ config.vuln_root_cause }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if variant == 'system-prompt-poison' %}
                <!-- ç³»ç»Ÿæç¤ºç¼–è¾‘å™¨ -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header py-1 px-2 d-flex justify-content-between align-items-center">
                            <strong class="small">â˜ ï¸ ç³»ç»Ÿæç¤ºæ¨¡æ¿ç¼–è¾‘å™¨</strong>
                            <span class="badge bg-warning text-dark" style="font-size:10px">ä¾›åº”é“¾æ”»å‡»é¢</span>
                        </div>
                        <div class="card-body" style="padding:6px 10px">
                            <p class="text-muted mb-1" style="font-size:11px">æ¨¡æ‹Ÿåœºæ™¯ï¼šä½ å·²è·å–è¿è¥åå°æƒé™ï¼Œä¿®æ”¹ç³»ç»Ÿæç¤ºåæ‰€æœ‰ AI ä¼šè¯å°†å—å½±å“ã€‚</p>
                            <div class="mb-1">
                                {% for ex in config.poisoned_examples %}
                                <button class="btn btn-outline-warning payload-btn" onclick="loadPoisonedPrompt({{ forloop.counter0 }})">{{ ex.label }}</button>
                                {% endfor %}
                                <button class="btn btn-outline-success payload-btn" onclick="resetCleanPrompt()">ğŸ”„ è¿˜åŸ</button>
                            </div>
                            <textarea class="form-control prompt-editor" id="system-prompt-editor">{{ default_clean_prompt }}</textarea>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if variant == 'prompt-url' %}
                <!-- URL é¢„è§ˆ -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header py-1 px-2"><strong class="small">ğŸ”— URL å‚æ•°æ„é€ å™¨</strong></div>
                        <div class="card-body" style="padding:6px 10px">
                            <div class="url-preview" id="url-preview">
                                https://ai-search.example.com/search?q=<span id="url-query-display" class="fw-bold">Pythonæ•™ç¨‹</span>
                            </div>
                            <small class="text-muted" style="font-size:10px">è¾“å…¥å†…å®¹å°†ä½œä¸º <code>?q=</code> å‚æ•°æ³¨å…¥ system prompt</small>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- â•â•â• æ”»å‡»æ¼”ç¤ºåŒº â•â•â• -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header py-1 px-2 d-flex justify-content-between align-items-center">
                            <strong class="small">ğŸ¯ æ”»å‡»æ¼”ç¤º</strong>
                            <span class="badge bg-danger" style="font-size:10px">äº¤äº’å¼</span>
                        </div>
                        <div class="card-body" style="padding:6px 10px">
                            <!-- Payload æŒ‰é’® -->
                            <div class="mb-2">
                                <label class="fw-semibold" style="font-size:11px">å¿«é€Ÿ Payloadï¼š</label>
                                <div id="payload-buttons">
                                    {% for p in config.payloads %}
                                    <button class="btn btn-outline-danger payload-btn" onclick="setPayload({{ forloop.counter0 }})">{{ p.label }}</button>
                                    {% endfor %}
                                </div>
                            </div>
                            <!-- èŠå¤©åŒº -->
                            <div class="adv-chat-messages" id="chat-messages">
                                <div class="chat-msg ai"><div class="chat-bubble">ğŸ‘‹ æ¬¢è¿æ¥åˆ°ã€Œ{{ config.title }}ã€ï¼Œé€‰æ‹© Payload æˆ–è¾“å…¥æ¶ˆæ¯å¼€å§‹ã€‚</div></div>
                            </div>
                            <!-- è¾“å…¥ -->
                            <div class="mt-1 d-flex gap-2">
                                <textarea class="form-control" id="user-input" rows="2" placeholder="è¾“å…¥æ”»å‡» Payload..." style="font-size:12px;min-height:34px;max-height:50px"></textarea>
                                <button class="btn btn-danger btn-sm align-self-end" id="send-btn" style="white-space:nowrap;font-size:12px">
                                    <span class="spinner-border spinner-border-sm d-none me-1" id="loading-spinner"></span>å‘é€
                                </button>
                            </div>
                            <!-- æŒ‡ç¤ºå™¨ -->
                            <div class="attack-indicator" id="attack-indicator">
                                <strong id="indicator-title"></strong>
                                <div id="indicator-details" class="mt-1" style="font-size:11px"></div>
                            </div>
                            {% if variant == 'prompt-url' or variant == 'context-confusion' or variant == 'system-prompt-poison' %}
                            <div class="mt-1">
                                <a href="javascript:void(0)" style="font-size:11px" onclick="document.getElementById('actual-prompt').style.display=document.getElementById('actual-prompt').style.display==='none'?'block':'none'">ğŸ“‹ æŸ¥çœ‹å®é™… System Prompt</a>
                                <div class="system-prompt-display" id="actual-prompt"></div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- â•â•â• å³æ ï¼šç»Ÿè®¡ â•â•â• -->
        <div class="col-lg-3">
            <!-- ç»Ÿè®¡ -->
            <div class="card mb-2">
                <div class="card-header py-1 px-2"><strong class="small">ğŸ“Š ç»Ÿè®¡</strong></div>
                <div class="card-body text-center" style="padding:6px 8px">
                    <div class="d-flex justify-content-around">
                        <div><div class="stat-number" id="stat-total">0</div><div class="stat-label">å°è¯•</div></div>
                        <div><div class="stat-number text-danger" id="stat-success">0</div><div class="stat-label">æˆåŠŸ</div></div>
                        <div><div class="stat-number text-success" id="stat-safe">0</div><div class="stat-label">é˜²å¾¡</div></div>
                    </div>
                </div>
            </div>

            {% if variant == 'cot-dos' %}
            <!-- Token ç›‘æ§ -->
            <div class="card mb-2">
                <div class="card-header py-1 px-2"><strong class="small">ğŸ“ˆ Token æ¶ˆè€—</strong></div>
                <div class="card-body" style="padding:6px 8px;font-size:12px">
                    <div class="d-flex justify-content-between"><span class="text-muted">å½“å‰</span><span class="fw-semibold" id="token-current">0</span></div>
                    <div class="token-bar mt-1 mb-1"><div class="token-bar-fill low" id="token-bar" style="width:0%"></div></div>
                    <div class="d-flex justify-content-between"><span class="text-muted">æœ€é«˜</span><span class="fw-semibold text-danger" id="token-max">0</span></div>
                    <div class="d-flex justify-content-between"><span class="text-muted">ç´¯è®¡</span><span class="fw-semibold" id="token-total">0</span></div>
                    <div class="text-muted mt-1" style="font-size:10px">ğŸ’¡ 50~200æ­£å¸¸ âš ï¸ >500è¿‡å¤š ğŸ”´ >1000 DoS</div>
                </div>
            </div>
            {% endif %}

            {% if variant == 'reasoning-leak' %}
            <!-- æ³„éœ²è¿½è¸ª -->
            <div class="card mb-2">
                <div class="card-header py-1 px-2"><strong class="small">ğŸ” ä¿¡æ¯è¿½è¸ª</strong></div>
                <div class="card-body" style="padding:6px 8px;font-size:11px">
                    <div class="mb-1"><span class="badge bg-secondary" id="track-apikey" style="font-size:10px">ğŸ”’ APIå¯†é’¥</span></div>
                    <div class="mb-1"><span class="badge bg-secondary" id="track-password" style="font-size:10px">ğŸ”’ ç®¡ç†å‘˜å¯†ç </span></div>
                    <div class="mb-1"><span class="badge bg-secondary" id="track-dbconn" style="font-size:10px">ğŸ”’ æ•°æ®åº“è¿æ¥</span></div>
                    <div class="mb-1"><span class="badge bg-secondary" id="track-version" style="font-size:10px">ğŸ”’ ç³»ç»Ÿç‰ˆæœ¬</span></div>
                    <div class="mb-1"><span class="badge bg-secondary" id="track-audit" style="font-size:10px">ğŸ”’ å®¡è®¡ä»¤ç‰Œ</span></div>
                </div>
            </div>
            {% endif %}

            <!-- æœ€è¿‘å“åº” -->
            <div class="card mb-2">
                <div class="card-header py-1 px-2"><strong class="small">â±ï¸ å“åº”</strong></div>
                <div class="card-body" style="padding:6px 8px;font-size:12px">
                    <div class="d-flex justify-content-between"><span class="text-muted">è€—æ—¶</span><span class="fw-semibold" id="last-elapsed">â€”</span></div>
                    <div class="d-flex justify-content-between"><span class="text-muted">é•¿åº¦</span><span class="fw-semibold" id="last-length">â€”</span></div>
                </div>
            </div>

            <!-- é˜²å¾¡ -->
            <div class="card mb-2">
                <div class="card-header py-1 px-2" style="cursor:pointer" onclick="this.nextElementSibling.classList.toggle('d-none')">
                    <strong class="small">ğŸ›¡ï¸ é˜²å¾¡æªæ–½</strong>
                </div>
                <div class="card-body d-none" style="padding:6px 8px;font-size:11px">
                    <ul class="mb-0 ps-3">
                        {% for tip in config.defense_tips %}
                        <li>{{ tip }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- å®‰å…¨æé†’ -->
            <div class="card">
                <div class="card-body" style="padding:6px 8px;font-size:11px;color:var(--muted)">
                    âš ï¸ ä»…ç”¨äºå®‰å…¨ç ”ç©¶ä¸æ•™è‚²ã€‚æ‰€æœ‰æ”»å‡»åœ¨éš”ç¦»ç¯å¢ƒä¸­è¿›è¡Œã€‚
                </div>
            </div>
        </div>
    </div>
</div></main>

{% include "playground/_tool_lab_llm_config_modal.html" %}
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const VARIANT = '{{ variant }}';
    const CONFIG = JSON.parse('{{ config_json|escapejs }}');
    const PAYLOADS = CONFIG.payloads || [];
    {% if variant == 'system-prompt-poison' %}
    const POISONED_EXAMPLES = JSON.parse('{{ poisoned_examples_json|escapejs }}');
    const CLEAN_PROMPT = document.getElementById('system-prompt-editor') ? document.getElementById('system-prompt-editor').defaultValue : '';
    {% endif %}

    const chatBox = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const spinner = document.getElementById('loading-spinner');
    const indicator = document.getElementById('attack-indicator');
    const indicatorTitle = document.getElementById('indicator-title');
    const indicatorDetails = document.getElementById('indicator-details');

    let stats = { total: 0, success: 0, safe: 0 };
    let history = [];
    let tokenMax = 0, tokenTotal = 0;
    let leakedSet = new Set();

    window.setPayload = function(idx) {
        if (PAYLOADS[idx]) {
            userInput.value = PAYLOADS[idx].value || PAYLOADS[idx];
            {% if variant == 'prompt-url' %}updateUrlPreview();{% endif %}
        }
    };

    {% if variant == 'system-prompt-poison' %}
    window.loadPoisonedPrompt = function(idx) {
        if (POISONED_EXAMPLES[idx]) document.getElementById('system-prompt-editor').value = POISONED_EXAMPLES[idx].value;
    };
    window.resetCleanPrompt = function() {
        document.getElementById('system-prompt-editor').value = CLEAN_PROMPT;
    };
    {% endif %}

    {% if variant == 'prompt-url' %}
    function updateUrlPreview() {
        const q = userInput.value.trim();
        const d = document.getElementById('url-query-display');
        if (d) d.textContent = encodeURIComponent(q).substring(0, 80);
    }
    userInput.addEventListener('input', updateUrlPreview);
    {% endif %}

    function sendMessage() {
        const msg = userInput.value.trim();
        if (!msg) return;
        appendMsg('user', msg);
        userInput.value = '';
        const reqBody = { variant: VARIANT, message: msg, history: history.slice(-10) };
        {% if variant == 'system-prompt-poison' %}
        reqBody.custom_system_prompt = document.getElementById('system-prompt-editor').value;
        {% endif %}
        sendBtn.disabled = true;
        spinner.classList.remove('d-none');
        appendMsg('ai', 'â³ æ€è€ƒä¸­...');

        fetch('{% url "playground:advanced_lab_chat_api" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrf() },
            body: JSON.stringify(reqBody),
        })
        .then(r => r.json())
        .then(data => {
            removeLastAiMsg();
            if (!data.success) { appendMsg('ai', 'âŒ ' + (data.error || 'è¯·æ±‚å¤±è´¥')); return; }
            let replyHtml = data.reply;
            {% if variant == 'reasoning-leak' %}
            const secrets = CONFIG.detect_secrets || [];
            secrets.forEach(function(s) {
                if (data.reply.toLowerCase().includes(s.toLowerCase())) {
                    const re = new RegExp(s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                    replyHtml = replyHtml.replace(re, '<span class="leak-highlight">$&</span>');
                    leakedSet.add(s);
                }
            });
            updateLeakTracker();
            {% endif %}
            appendMsg('ai', replyHtml, true);
            history.push({ role: 'user', content: msg });
            history.push({ role: 'assistant', content: data.reply });
            updateIndicator(data.detection);
            stats.total++;
            if (data.detection && data.detection.attacked) stats.success++; else stats.safe++;
            updateStats();
            document.getElementById('last-elapsed').textContent = (data.elapsed_ms || 0) + 'ms';
            document.getElementById('last-length').textContent = (data.reply || '').length + ' å­—';
            {% if variant == 'cot-dos' %}
            const tokens = data.est_tokens || 0;
            tokenTotal += tokens;
            if (tokens > tokenMax) tokenMax = tokens;
            document.getElementById('token-current').textContent = tokens;
            document.getElementById('token-max').textContent = tokenMax;
            document.getElementById('token-total').textContent = tokenTotal;
            const pct = Math.min(tokens / 1500 * 100, 100);
            const bar = document.getElementById('token-bar');
            bar.style.width = pct + '%';
            bar.className = 'token-bar-fill ' + (tokens < 300 ? 'low' : tokens < 800 ? 'mid' : 'high');
            {% endif %}
            {% if variant == 'prompt-url' or variant == 'context-confusion' or variant == 'system-prompt-poison' %}
            if (data.system_prompt_used) {
                const el = document.getElementById('actual-prompt');
                if (el) { el.textContent = data.system_prompt_used; el.style.display = 'block'; }
            }
            {% endif %}
        })
        .catch(err => { removeLastAiMsg(); appendMsg('ai', 'âŒ ç½‘ç»œé”™è¯¯ï¼š' + err.message); })
        .finally(() => { sendBtn.disabled = false; spinner.classList.add('d-none'); });
    }

    function appendMsg(role, content, isHtml) {
        const div = document.createElement('div');
        div.className = 'chat-msg ' + role;
        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble';
        if (isHtml) bubble.innerHTML = content; else bubble.textContent = content;
        div.appendChild(bubble);
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    function removeLastAiMsg() {
        const msgs = chatBox.querySelectorAll('.chat-msg.ai');
        if (msgs.length) msgs[msgs.length - 1].remove();
    }
    function updateIndicator(det) {
        if (!det) return;
        indicator.className = 'attack-indicator show ' + (det.level || 'safe');
        indicatorTitle.innerHTML = (det.attacked ? (det.level === 'critical' ? 'ğŸš¨' : 'âš ï¸') : 'âœ…') + ' ' + det.message;
        indicatorDetails.innerHTML = (det.details || []).map(d => 'â€¢ ' + d).join('<br>');
    }
    function updateStats() {
        document.getElementById('stat-total').textContent = stats.total;
        document.getElementById('stat-success').textContent = stats.success;
        document.getElementById('stat-safe').textContent = stats.safe;
    }
    {% if variant == 'reasoning-leak' %}
    function updateLeakTracker() {
        const mapping = { 'SK-INTERNAL-2024-ABCDEF':'track-apikey','goldfish42':'track-password','s3cret':'track-dbconn','v3.7.2-rc1':'track-version','AUD-TOKEN-XYZ789':'track-audit' };
        for (const [secret, elId] of Object.entries(mapping)) {
            if (leakedSet.has(secret)) { const el = document.getElementById(elId); if (el) { el.className='badge bg-danger'; el.textContent='âš ï¸ å·²æ³„éœ²'; } }
        }
    }
    {% endif %}
    function getCsrf() { const m = document.cookie.match(/csrftoken=([^;]+)/); return m ? m[1] : ''; }
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keydown', function(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
})();
</script>
{% endblock %}
