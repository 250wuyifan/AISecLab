{% extends "base.html" %}
{% block extra_css %}
<style>
.lab-sidebar-list .nav-link.active { background-color: rgba(13,110,253,0.12); border-radius: 0.375rem; color: var(--primary-color); font-weight: 600; }
.code-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; padding: 12px 14px; font-family: Consolas, 'SF Mono', monospace; font-size: 13px; color: #1f2937; white-space: pre-wrap; max-height: 280px; overflow-y: auto; }
html[data-theme="dark"] .code-box { background: #1e293b; border-color: #334155; color: #e2e8f0; }
</style>
{% endblock %}
{% block content %}
<main class="lab-detail-main"><div class="lab-detail-container">
    {% url 'playground:lab_list' as lab_list_url %}
    {% include "playground/_lab_detail_header.html" with back_url=lab_list_url back_text="返回靶场列表" title="Tool·文件解析（反序列化）" subtitle="用户发送「要解析的 YAML」→ LLM 原样输出该内容 → 后端用 yaml.unsafe_load() 解析，可触发 RCE。" show_llm_button=True current_model=current_model %}

    {% include "playground/_lab_tools.html" with lab_slug="tool_security:yaml" %}

    {% include "playground/_llm_not_configured_alert.html" %}

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-2">演练步骤</h5>
            <ol class="small text-muted mb-2">
                <li>下方输入<strong>用户指令</strong>（如「解析这段配置：key: value」）；LLM 原样输出用户给的 YAML，后端 <code>unsafe_load</code>；</li>
                <li>尝试注入恶意 YAML（若模型服从）或直接粘贴恶意 YAML 到「用户指令」观察反序列化 RCE（需 PyYAML）。</li>
            </ol>
        </div>
    </div>
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-2">用户指令（含 YAML 内容，LLM 将原样输出后 backend unsafe_load）</h5>
            <textarea class="form-control font-monospace mb-2" id="tool-yaml-message" rows="3" placeholder="例如：解析这段配置：&#10;key: value">解析这段配置：&#10;key: value</textarea>
            <button type="button" class="btn btn-danger" id="tool-yaml-submit">解析（LLM → unsafe_load）</button>
            <div class="mt-3"><strong>解析结果：</strong><div id="tool-yaml-result" class="code-box mt-1">—</div></div>
        </div>
    </div>
    <div class="card shadow-sm"><div class="card-header"><strong>怎么修复</strong></div>
        <div class="card-body small"><ul class="mb-0"><li>使用 <code>yaml.safe_load()</code>；禁止反序列化不可信 YAML 中的对象类型。</li></ul></div>
    </div>
</div></main>
<script>

// 获取 CSRF Token
function getCsrfToken() {
    var c = document.cookie.match(/csrftoken=([^;]+)/);
    if (c) return c[1];
    var el = document.querySelector('[name="csrfmiddlewaretoken"]');
    return el ? el.value : '';
}
(function(){
    var msgEl=document.getElementById('tool-yaml-message'); var resultEl=document.getElementById('tool-yaml-result'); var btn=document.getElementById('tool-yaml-submit');
    var apiUrl='{% url "playground:tool_yaml_parse_api" %}';
    function setResult(t,e){ if(resultEl){ resultEl.textContent=t||'—'; resultEl.style.color=e?'var(--bs-danger)':''; }}
    if(btn&&msgEl) btn.addEventListener('click',function(){
        var m=(msgEl.value||'').trim(); if(!m){ setResult('请输入用户指令'); return; }
        setResult('调用 LLM 并解析 YAML 中…');
        fetch(apiUrl,{ method:'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() }, body:JSON.stringify({message:m}) })
        .then(function(r){ return r.json(); }).then(function(d){ if(d.error) setResult('错误: '+d.error,true); else setResult(d.result||'—'); })
        .catch(function(e){ setResult('请求失败: '+e.message,true); });
    });
})();
</script>
{% endblock %}
