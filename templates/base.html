<!DOCTYPE html>
{% load static %}
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}AIå®‰å…¨é¶åœº{% endblock %}</title>
    <script>
        // æå‰è®¾ç½®ä¸»é¢˜ï¼Œé¿å…é—ªä¸€ä¸‹ç™½åº•å†åˆ‡æ¢åˆ°æš—è‰²
        (function () {
            try {
                var saved = localStorage.getItem('theme');
                var systemDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                var theme = saved || (systemDark ? 'dark' : 'light');
                document.documentElement.setAttribute('data-theme', theme);
            } catch (e) {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>
    <script>
        // æå‰åº”ç”¨â€œä¾§æ éšè—â€çŠ¶æ€ï¼Œé¿å…é¡µé¢è·³è½¬æ—¶ä¾§æ å…ˆé—ªç°å†éšè—
        (function () {
            try {
                var hidden = localStorage.getItem('sidebar_hidden') === '1';
                if (hidden) document.documentElement.classList.add('sidebar-hidden');
            } catch (e) {}
        })();
    </script>
    <script>
        // æå‰åº”ç”¨é¶åœºä¾§æ å±•å¼€/æŠ˜å çŠ¶æ€ï¼Œé¿å…é¡µé¢åŠ è½½æ—¶é—ªçƒ
        (function () {
            try {
                var state = JSON.parse(localStorage.getItem('lab_sidebar_state') || '{}');
                var css = '';
                Object.keys(state).forEach(function(catId) {
                    if (!state[catId]) {
                        css += '.lab-items[data-category-id="' + catId + '"] { display: none !important; }\n';
                    }
                });
                if (css) {
                    var style = document.createElement('style');
                    style.id = 'lab-sidebar-preload';
                    style.textContent = css;
                    document.head.appendChild(style);
                }
            } catch (e) {}
        })();
    </script>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <link href="{% static 'css/lab_detail.css' %}" rel="stylesheet">
    <!-- Syntax Highlighting (GitHub style) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" rel="stylesheet">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <nav class="navbar navbar-expand-md fixed-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    <path d="M9 12l2 2 4-4"></path>
                </svg>
                AIå®‰å…¨é¶åœº
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav me-auto mb-2 mb-md-0">
                    <li class="nav-item">
                        <a class="nav-link {% if '/playground' in request.path %}active{% endif %}"
                           href="{% url 'playground:lab_list' %}">é¶åœºæ¼”ç»ƒ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'about' %}active{% endif %}"
                           href="{% url 'learning:about' %}">å…³äºé¶åœº</a>
                    </li>
                </ul>
                <button id="sidebarToggle" type="button" class="btn btn-sm btn-outline-secondary me-3 d-none d-md-inline-flex" aria-label="éšè—/æ˜¾ç¤ºä¾§è¾¹æ ">
                    ä¾§æ 
                </button>
                <ul class="navbar-nav mb-2 mb-md-0">
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <button id="themeToggle" type="button" class="nav-link bg-transparent border-0" aria-label="åˆ‡æ¢ä¸»é¢˜">
                                <span class="theme-icon">ğŸŒ™</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <span class="nav-link">{{ user.username }}</span>
                        </li>
                        <li class="nav-item">
                            <form action="{% url 'logout' %}" method="post" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="nav-link bg-transparent border-0">é€€å‡º</button>
                            </form>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'login' %}">ç™»å½•</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    <!-- èƒŒæ™¯ç”»å¸ƒç”± bg.js åŠ¨æ€åˆ›å»º -->

    <div class="container-fluid p-0">
    <!-- æ¶ˆæ¯æç¤º -->
    {% if messages %}
    <div class="container mt-5 pt-4 messages-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    {% block content %}{% endblock %}
</div>

    <!-- å…¨å±€ï¼šé¶åœº LLM é…ç½®å¼¹å±‚ï¼ˆé¶åœºè¯¦æƒ…é¡µã€Œé…ç½® LLMã€ç»Ÿä¸€å…¥å£ï¼‰ -->
    {% include "playground/_tool_lab_llm_config_modal.html" %}

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/js/bootstrap.bundle.min.js"></script>
    <!-- Syntax Highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script>
        (function () {
            function highlightArticle() {
                var blocks = document.querySelectorAll('.markdown-body pre code');
                if (!blocks || !blocks.length) return;
                blocks.forEach(function (block) { try { hljs.highlightElement(block); } catch (e) {} });
            }
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', highlightArticle);
            } else {
                highlightArticle();
            }
        })();
    </script>
    <script>
        // ä¸»é¢˜åˆå§‹åŒ–ï¼šä¼˜å…ˆ localStorageï¼Œå…¶æ¬¡ç³»ç»Ÿä¸»é¢˜
        // ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
        (function () {
            function setIcon(theme) {
                var el = document.querySelector('#themeToggle .theme-icon');
                if (!el) return;
                el.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            }
            function getTheme() {
                return document.documentElement.getAttribute('data-theme') || 'light';
            }
            setIcon(getTheme());
            var btn = document.getElementById('themeToggle');
            if (!btn) return;
            btn.addEventListener('click', function () {
                var cur = getTheme();
                var next = cur === 'dark' ? 'light' : 'dark';
                
                // æ·»åŠ è¿‡æ¸¡ç±»
                document.documentElement.classList.add('theme-transitioning');
                
                // åˆ‡æ¢ä¸»é¢˜
                document.documentElement.setAttribute('data-theme', next);
                try { localStorage.setItem('theme', next); } catch (e) {}
                setIcon(next);
                
                // åŠ¨ç”»ç»“æŸåç§»é™¤è¿‡æ¸¡ç±»
                setTimeout(function() {
                    document.documentElement.classList.remove('theme-transitioning');
                }, 450);
            });
        })();

        // èƒŒæ™¯åŠ¨ç”»å·²å…¨å±€å…³é—­ï¼Œæ­¤å¤„ä¿ç•™ç©ºä½é¿å…æŠ¥é”™ï¼ˆä¸å†æŒ‚è½½å¼€å…³ï¼‰
    </script>
    <script>
        // å…³é—­æœ€åä¸€æ¡æç¤ºåï¼Œç§»é™¤æ•´ä¸ªæ¶ˆæ¯å®¹å™¨ï¼Œé¿å…é¡¶éƒ¨ç•™ç™½
        document.addEventListener('closed.bs.alert', function (event) {
            var container = event.target && event.target.closest
                ? event.target.closest('.messages-container')
                : null;
            if (!container) return;
            if (container.querySelectorAll('.alert').length === 0) {
                container.remove();
            }
        });
    </script>
    <script>
        // å·¦ä¾§åˆ†ç±»æŠ˜å /å±•å¼€ï¼ˆlocalStorage è®°å¿†ï¼‰
        (function () {
            function loadState() {
                try { return JSON.parse(localStorage.getItem('sidebar_categories') || '{}'); } catch (e) { return {}; }
            }
            function saveState(state) {
                try { localStorage.setItem('sidebar_categories', JSON.stringify(state)); } catch (e) {}
            }
            function setOpen(catId, open) {
                var ul = document.querySelector('.category-topics[data-category-id="' + catId + '"]');
                var btn = document.querySelector('.sidebar-toggle[data-category-id="' + catId + '"]');
                if (!ul || !btn) return;
                ul.classList.toggle('is-open', open);
                btn.setAttribute('aria-expanded', open ? 'true' : 'false');
            }

            document.addEventListener('click', function (e) {
                var btn = e.target && e.target.closest ? e.target.closest('.sidebar-toggle') : null;
                if (!btn) return;
                var catId = btn.getAttribute('data-category-id');
                if (!catId) return;
                var isOpen = btn.getAttribute('aria-expanded') === 'true';
                var next = !isOpen;
                setOpen(catId, next);
                var state = loadState();
                state[catId] = next;
                saveState(state);
            });

            // åˆå§‹åŒ–ï¼šåº”ç”¨è®°å¿†çŠ¶æ€ï¼Œä½†ä¸è¦†ç›–æœåŠ¡å™¨ç«¯â€œå½“å‰æ–‡ç« åˆ†ç±»é»˜è®¤å±•å¼€â€
            document.addEventListener('DOMContentLoaded', function () {
                var state = loadState();
                Object.keys(state).forEach(function (catId) {
                    // å¦‚æœæ¨¡æ¿å·²æ‰“å¼€ï¼ˆå½“å‰æ–‡ç« åˆ†ç±»ï¼‰ï¼Œä¿æŒæ‰“å¼€
                    var ul = document.querySelector('.category-topics[data-category-id="' + catId + '"]');
                    if (ul && ul.classList.contains('is-open')) return;
                    setOpen(catId, !!state[catId]);
                });
            });
        })();
    </script>
    <script>
        // å·¦ä¾§ä¾§è¾¹æ æ˜¾ç¤º/éšè—ï¼ˆè®°å¿†çŠ¶æ€ï¼‰
        (function () {
            function apply(hidden) {
                // 1) æ ‡è®°çŠ¶æ€ï¼ˆç»™ CSS ç”¨ï¼‰
                document.documentElement.classList.toggle('sidebar-hidden', hidden);
                document.body.classList.toggle('sidebar-hidden', hidden);

                // 2) ç›´æ¥éšè—/æ˜¾ç¤º DOMï¼ˆé¿å…è¢« bootstrap çš„ .collapse è§„åˆ™æŠ¢ä¼˜å…ˆçº§ï¼‰
                var sidebar = document.getElementById('sidebarMenu');
                if (sidebar) sidebar.classList.toggle('d-none', hidden);

                try { localStorage.setItem('sidebar_hidden', hidden ? '1' : '0'); } catch (e) {}
            }
            function init() {
                var hidden = false;
                try { hidden = localStorage.getItem('sidebar_hidden') === '1'; } catch (e) {}
                apply(hidden);
            }
            init();
            var btn = document.getElementById('sidebarToggle');
            if (!btn) return;
            btn.addEventListener('click', function () {
                var hidden = document.documentElement.classList.contains('sidebar-hidden');
                apply(!hidden);
            });
        })();
    </script>
    <script>
        // ä¾§æ æ»šåŠ¨ä½ç½®è®°å¿†ï¼šé¡µé¢åˆ‡æ¢æ—¶ä¿æŒå·¦ä¾§å½“å‰ä½ç½®
        (function () {
            function getScroller() {
                return document.querySelector('#sidebarMenu .sidebar-sticky');
            }
            function restore() {
                var el = getScroller();
                if (!el) return;
                try {
                    var v = parseInt(localStorage.getItem('sidebar_scroll_top') || '0', 10);
                    if (!Number.isNaN(v)) el.scrollTop = v;
                } catch (e) {}
                el.addEventListener('scroll', function () {
                    try { localStorage.setItem('sidebar_scroll_top', String(el.scrollTop || 0)); } catch (e) {}
                }, { passive: true });
            }
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', restore);
            } else {
                restore();
            }
        })();
    </script>
    <script>
        // ä¾§æ å®½åº¦æ‹–æ‹½è°ƒæ•´
        (function () {
            var handle = document.getElementById('sidebar-resize-handle');
            var sidebar = document.getElementById('sidebarMenu');
            if (!handle || !sidebar) return;

            var dragging = false;
            var startX = 0;
            var startWidth = 0;

            function onMouseMove(e) {
                if (!dragging) return;
                var dx = e.clientX - startX;
                var newWidth = Math.min(Math.max(startWidth + dx, 200), 480); // 200-480 ä¹‹é—´
                document.documentElement.style.setProperty('--sidebar-width', newWidth + 'px');
                try { localStorage.setItem('sidebar_width', String(newWidth)); } catch (err) {}
            }

            function onMouseUp() {
                dragging = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }

            handle.addEventListener('mousedown', function (e) {
                if (e.button !== 0) return;
                dragging = true;
                startX = e.clientX;
                var cs = getComputedStyle(document.documentElement);
                startWidth = parseInt(cs.getPropertyValue('--sidebar-width') || '280', 10) || 280;
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            // åˆå§‹åŒ–å®½åº¦
            try {
                var saved = parseInt(localStorage.getItem('sidebar_width') || '', 10);
                if (!Number.isNaN(saved) && saved >= 200 && saved <= 480) {
                    document.documentElement.style.setProperty('--sidebar-width', saved + 'px');
                }
            } catch (e) {}
        })();
    </script>
    <!-- èµ›åšæœ‹å…‹èƒŒæ™¯åŠ¨ç”»ï¼ˆä»…æš—è‰²ä¸»é¢˜ï¼‰ -->
    <script src="{% static 'js/bg.js' %}"></script>
    
    <!-- TOC æ»šåŠ¨é«˜äº® -->
    <script>
    (function() {
        var tocBody = document.querySelector('.toc-body');
        if (!tocBody) return;
        
        var tocLinks = tocBody.querySelectorAll('a[href^="#"]');
        if (!tocLinks.length) return;
        
        var headings = [];
        tocLinks.forEach(function(link) {
            var id = link.getAttribute('href').slice(1);
            var heading = document.getElementById(id);
            if (heading) {
                headings.push({ id: id, element: heading, link: link });
            }
        });
        
        if (!headings.length) return;
        
        var activeClass = 'toc-active';
        
        function highlightToc() {
            var scrollTop = window.scrollY || document.documentElement.scrollTop;
            var offset = 100; // åç§»é‡
            
            var currentId = null;
            for (var i = headings.length - 1; i >= 0; i--) {
                var h = headings[i];
                if (h.element.offsetTop - offset <= scrollTop) {
                    currentId = h.id;
                    break;
                }
            }
            
            tocLinks.forEach(function(link) {
                link.classList.remove(activeClass);
            });
            
            if (currentId) {
                var activeLink = tocBody.querySelector('a[href="#' + currentId + '"]');
                if (activeLink) {
                    activeLink.classList.add(activeClass);
                }
            }
        }
        
        // èŠ‚æµå‡½æ•°
        var ticking = false;
        window.addEventListener('scroll', function() {
            if (!ticking) {
                window.requestAnimationFrame(function() {
                    highlightToc();
                    ticking = false;
                });
                ticking = true;
            }
        });
        
        // åˆå§‹åŒ–
        highlightToc();
    })();
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
