{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'playground/css/lab_detail.css' %}">
<style>
.probe-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:0.4rem; }
.probe-item { background:var(--surface); border:1px solid var(--border-color); border-radius:4px; padding:0.4rem 0.5rem; cursor:pointer; transition:all 0.2s; }
.probe-item:hover { border-color:var(--primary-color); }
.probe-item.selected { border-color:#ef4444; background:rgba(239,68,68,0.05); }
.probe-item input { margin-right:0.3rem; }
.probe-name { font-weight:600; font-size:0.78rem; }
.probe-desc { font-size:0.68rem; color:var(--muted); margin-top:0.1rem; }

.scan-log {
    font-family: 'JetBrains Mono', Consolas, monospace;
    font-size: 0.72rem; line-height: 1.7;
    background: #1a1a2e; color: #d4d4d4;
    padding: 0.6rem 0.8rem; border-radius: 6px;
    max-height: 280px; min-height: 80px;
    overflow-y: auto; white-space: pre-wrap; word-break: break-all;
}
.scan-log .log-line { display: block; padding: 1px 0; }
.scan-log .log-line.step { color: #4ec9b0; }
.scan-log .log-line.ok { color: #6a9955; }
.scan-log .log-line.warn { color: #dcdcaa; }
.scan-log .log-line.err { color: #f14c4c; }
.scan-log .log-line.info { color: #9cdcfe; }

.stat-card { background:var(--surface); border:1px solid var(--border-color); border-radius:6px; padding:0.4rem; text-align:center; }
.stat-value { font-size:1.3rem; font-weight:800; transition: all 0.3s; }
.stat-label { font-size:0.7rem; color:var(--muted); }
.stat-card.danger .stat-value { color:#ef4444; }
.stat-card.warning .stat-value { color:#f59e0b; }
.stat-card.success .stat-value { color:#22c55e; }

.vuln-item { display:flex; align-items:flex-start; gap:0.5rem; padding:0.5rem; border-bottom:1px solid var(--border-color); }
.vuln-item:last-child { border-bottom:none; }
.vuln-severity { padding:1px 5px; border-radius:3px; font-size:0.68rem; font-weight:600; text-transform:uppercase; }
.vuln-severity.high { background:rgba(239,68,68,0.1); color:#ef4444; }
.vuln-severity.medium { background:rgba(245,158,11,0.1); color:#f59e0b; }
.vuln-severity.low { background:rgba(34,197,94,0.1); color:#22c55e; }

.scan-progress { height:4px; border-radius:2px; background:var(--bg-2); overflow:hidden; margin-top:0.4rem; }
.scan-progress-bar { height:100%; background:linear-gradient(90deg,#ef4444,#f59e0b); transition:width 0.3s; animation: pulse 1.5s ease-in-out infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.6} }
</style>
{% endblock %}

{% block content %}
<main class="lab-detail-main"><div class="lab-detail-container">
    {% url 'playground:lab_list' as lab_list_url %}
    {% include "playground/_lab_detail_header.html" with back_url=lab_list_url|add:"?category=redteam" back_text="è¿”å›çº¢é˜Ÿå·¥å…·" title="Garak Scanner" title_icon="ğŸ¦ˆ" subtitle="LLM æ¼æ´æ‰«æå™¨ â€” è‡ªåŠ¨æµ‹è¯•æç¤ºæ³¨å…¥ã€è¶Šç‹±ã€ä¿¡æ¯æ³„éœ²ç­‰" show_llm_button=True current_model=current_model %}

    {% include "playground/_llm_not_configured_alert.html" %}

    <div class="d-flex gap-3 mb-2 align-items-center" style="font-size:0.72rem">
        <span class="text-muted">LLMï¼š<span id="llm-status" class="badge bg-secondary" style="font-size:0.62rem">æ£€æµ‹ä¸­...</span></span>
        <span class="text-muted">æ¨¡å‹ï¼š<strong id="target-model">{{ current_model|default:"æœªé…ç½®" }}</strong></span>
    </div>

    <div class="row g-2">
        <div class="col-lg-3">
            <div class="card mb-2">
                <div class="card-header py-1 px-2 d-flex justify-content-between align-items-center">
                    <strong class="small">ğŸ”¬ æ¢é’ˆ</strong>
                    <button class="btn btn-outline-secondary" style="font-size:0.62rem;padding:1px 5px" onclick="toggleAllProbes()">å…¨é€‰/å–æ¶ˆ</button>
                </div>
                <div class="card-body" style="padding:6px 8px">
                    <div class="probe-grid">
                        {% for probe in probes %}
                        <label class="probe-item{% if probe.default %} selected{% endif %}" onclick="this.classList.toggle('selected')">
                            <input type="checkbox" name="probes" value="{{ probe.id }}" {% if probe.default %}checked{% endif %}>
                            <div class="probe-name">{{ probe.name }}</div>
                            <div class="probe-desc">{{ probe.description }}</div>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="card mb-2">
                <div class="card-header py-1 px-2"><strong class="small">âš™ï¸ å‚æ•°</strong></div>
                <div class="card-body" style="padding:6px 8px">
                    <label class="form-label" style="font-size:0.72rem">æ¯æ¢é’ˆæ ·æœ¬æ•°</label>
                    <input type="number" class="form-control form-control-sm" id="sample-count" value="5" min="1" max="20" style="font-size:0.75rem">
                </div>
            </div>
            <button class="btn btn-danger btn-sm w-100" id="start-scan-btn" onclick="startScan()">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                å¼€å§‹æ‰«æ
            </button>
        </div>

        <div class="col-lg-9">
            <!-- ç»Ÿè®¡ -->
            <div class="row g-2 mb-2">
                <div class="col-3"><div class="stat-card"><div class="stat-value" id="stat-total">0</div><div class="stat-label">æ€»æµ‹è¯•</div></div></div>
                <div class="col-3"><div class="stat-card danger"><div class="stat-value" id="stat-high">0</div><div class="stat-label">é«˜å±</div></div></div>
                <div class="col-3"><div class="stat-card warning"><div class="stat-value" id="stat-medium">0</div><div class="stat-label">ä¸­å±</div></div></div>
                <div class="col-3"><div class="stat-card success"><div class="stat-value" id="stat-passed">0</div><div class="stat-label">é€šè¿‡</div></div></div>
            </div>

            <!-- æ‰«ææ—¥å¿— -->
            <div class="card mb-2">
                <div class="card-header py-1 px-2 d-flex justify-content-between align-items-center">
                    <span><span class="me-1">ğŸ“‹</span><strong class="small">æ‰«ææ—¥å¿—</strong></span>
                    <div class="d-flex align-items-center gap-2">
                        <span id="log-count" class="text-muted" style="font-size:0.62rem"></span>
                        <span id="scan-badge" class="badge bg-secondary" style="font-size:0.62rem">ç­‰å¾…å¼€å§‹</span>
                    </div>
                </div>
                <div class="card-body" style="padding:6px 8px">
                    <div class="scan-log" id="scan-log">
                        <span class="log-line info">Garak Scanner å°±ç»ª â€” é€‰æ‹©æ¢é’ˆåç‚¹å‡»ã€Œå¼€å§‹æ‰«æã€</span>
                    </div>
                    <div class="scan-progress" id="scan-progress" style="display:none">
                        <div class="scan-progress-bar" id="scan-progress-bar" style="width:0%"></div>
                    </div>
                </div>
            </div>

            <!-- æ¼æ´åˆ—è¡¨ -->
            <div class="card">
                <div class="card-header py-1 px-2 d-flex justify-content-between align-items-center">
                    <strong class="small">âš ï¸ å‘ç°çš„æ¼æ´</strong>
                    <button class="btn btn-outline-secondary" style="font-size:0.62rem;padding:1px 5px" onclick="exportResults()">å¯¼å‡ºæŠ¥å‘Š</button>
                </div>
                <div class="card-body" style="padding:6px 8px;max-height:250px;overflow-y:auto">
                    <div id="vuln-list">
                        <div class="text-center text-muted py-3" style="font-size:0.78rem">ğŸ” æ‰«æå®Œæˆåæ˜¾ç¤ºæ¼æ´</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div></main>

{% include "playground/_tool_lab_llm_config_modal.html" %}

<script>
let scanId = null;
let pollTimer = null;
let pollOffset = 0;
let allResults = [];

function classifyLog(text) {
    if (/^[ğŸš€ğŸ”¬ğŸ“‹ğŸ”¢ğŸ“Š]|æ¢é’ˆ|å¼€å§‹/.test(text)) return 'step';
    if (/^[ğŸ‰]|âœ…|é€šè¿‡/.test(text)) return 'ok';
    if (/âš ï¸|warn|æ¼æ´/.test(text)) return 'warn';
    if (/âŒ|error|å¤±è´¥|é”™è¯¯/.test(text)) return 'err';
    return 'info';
}

function addLogLine(text) {
    const log = document.getElementById('scan-log');
    const el = document.createElement('span');
    el.className = 'log-line ' + classifyLog(text);
    el.textContent = text;
    log.appendChild(el);
    log.scrollTop = log.scrollHeight;
}

async function checkLLM() {
    try {
        const resp = await fetch('{% url "playground:garak_ollama_status" %}');
        const data = await resp.json();
        const badge = document.getElementById('llm-status');
        if (data.online) { badge.className = 'badge bg-success'; badge.textContent = 'åœ¨çº¿'; }
        else { badge.className = 'badge bg-danger'; badge.textContent = data.error || 'ç¦»çº¿'; }
    } catch (e) {
        document.getElementById('llm-status').className = 'badge bg-danger';
        document.getElementById('llm-status').textContent = 'æ£€æµ‹å¤±è´¥';
    }
}

function toggleAllProbes() {
    const cbs = document.querySelectorAll('input[name="probes"]');
    const allChecked = Array.from(cbs).every(c => c.checked);
    cbs.forEach(c => { c.checked = !allChecked; c.closest('.probe-item').classList.toggle('selected', !allChecked); });
}

async function startScan() {
    if (scanId) { alert('æ‰«ææ­£åœ¨è¿›è¡Œä¸­'); return; }
    const probes = Array.from(document.querySelectorAll('input[name="probes"]:checked')).map(c => c.value);
    if (probes.length === 0) { alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¢é’ˆ'); return; }

    const btn = document.getElementById('start-scan-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>æ‰«æä¸­...';
    document.getElementById('scan-badge').className = 'badge bg-warning';
    document.getElementById('scan-badge').textContent = 'æ‰«æä¸­';
    document.getElementById('scan-progress').style.display = 'block';
    document.getElementById('scan-progress-bar').style.width = '5%';
    document.getElementById('scan-log').innerHTML = '';
    document.getElementById('vuln-list').innerHTML = '';
    ['stat-total','stat-high','stat-medium','stat-passed'].forEach(id => document.getElementById(id).textContent = '0');
    pollOffset = 0;
    allResults = [];

    try {
        const resp = await fetch('{% url "playground:garak_scan_api" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ probes, sample_count: parseInt(document.getElementById('sample-count').value) })
        });
        const data = await resp.json();
        if (data.success && data.scan_id) {
            scanId = data.scan_id;
            pollTimer = setInterval(pollStatus, 1200);
            pollStatus();
        } else {
            addLogLine('âŒ å¯åŠ¨å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            resetBtn();
        }
    } catch (e) {
        addLogLine('âŒ è¯·æ±‚é”™è¯¯: ' + e.message);
        resetBtn();
    }
}

async function pollStatus() {
    if (!scanId) return;
    try {
        const resp = await fetch('{% url "playground:garak_scan_poll" %}?id=' + scanId + '&offset=' + pollOffset);
        const data = await resp.json();
        if (resp.status === 404) { clearInterval(pollTimer); addLogLine('âŒ ä»»åŠ¡ä¸¢å¤±'); resetBtn(); return; }

        if (data.logs && data.logs.length > 0) {
            data.logs.forEach(addLogLine);
            pollOffset = data.offset;
            document.getElementById('log-count').textContent = pollOffset + ' è¡Œ';
        }

        // å®æ—¶æ›´æ–°ç»Ÿè®¡
        if (data.stats) {
            document.getElementById('stat-total').textContent = data.stats.total;
            document.getElementById('stat-high').textContent = data.stats.high;
            document.getElementById('stat-medium').textContent = data.stats.medium;
            document.getElementById('stat-passed').textContent = data.stats.passed;
        }

        const pct = data.status === 'done' ? 100 : Math.min(95, 5 + pollOffset * 4);
        document.getElementById('scan-progress-bar').style.width = pct + '%';

        if (data.status === 'done' || data.status === 'error') {
            clearInterval(pollTimer);
            scanId = null;
            document.getElementById('scan-progress-bar').style.width = '100%';
            document.getElementById('scan-progress-bar').style.animation = 'none';

            if (data.status === 'done' && data.results) {
                allResults = data.results;
                document.getElementById('scan-badge').className = data.stats.high > 0 ? 'badge bg-danger' : 'badge bg-success';
                document.getElementById('scan-badge').textContent = data.stats.high > 0 ? 'å‘ç°æ¼æ´' : 'æ‰«æå®Œæˆ';
                renderVulnerabilities(data.results);
            } else {
                document.getElementById('scan-badge').className = 'badge bg-danger';
                document.getElementById('scan-badge').textContent = 'å¤±è´¥';
            }
            resetBtn();
        }
    } catch (e) { /* ç½‘ç»œé—®é¢˜ä¸ä¸­æ–­è½®è¯¢ */ }
}

function renderVulnerabilities(results) {
    const list = document.getElementById('vuln-list');
    let html = '';
    let hasVuln = false;
    for (const r of results) {
        for (const v of (r.vulnerabilities || [])) {
            hasVuln = true;
            html += '<div class="vuln-item">'
                + '<span class="vuln-severity ' + v.severity + '">' + v.severity + '</span>'
                + '<div><div style="font-weight:600;font-size:0.8rem">' + escapeHtml(v.title) + '</div>'
                + '<div style="font-size:0.72rem;color:var(--muted)">' + escapeHtml(v.description) + '</div>'
                + '<details class="mt-1"><summary style="font-size:0.68rem;color:var(--muted);cursor:pointer">è¯¦æƒ…</summary>'
                + '<pre style="background:var(--bg-2);font-size:0.68rem;padding:0.3rem;margin-top:0.2rem;white-space:pre-wrap;border-radius:3px">' + escapeHtml(v.payload || '') + '</pre>'
                + (v.response ? '<pre style="background:var(--bg-2);font-size:0.68rem;padding:0.3rem;white-space:pre-wrap;border-radius:3px;color:#ef4444">å›å¤: ' + escapeHtml(v.response) + '</pre>' : '')
                + '</details></div></div>';
        }
    }
    if (!hasVuln) html = '<div class="text-center py-2" style="color:#22c55e;font-size:0.82rem">âœ… æœªå‘ç°æ¼æ´ï¼Œæ¨¡å‹é˜²å¾¡è‰¯å¥½</div>';
    list.innerHTML = html;
}

function resetBtn() {
    const btn = document.getElementById('start-scan-btn');
    btn.disabled = false;
    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>å¼€å§‹æ‰«æ';
    scanId = null;
}

function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function exportResults() {
    if (!allResults.length) { alert('æš‚æ— ç»“æœ'); return; }
    const report = { timestamp: new Date().toISOString(), model: '{{ current_model|default:"unknown" }}', results: allResults };
    const blob = new Blob([JSON.stringify(report, null, 2)], {type: 'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'garak-report-' + Date.now() + '.json'; a.click();
}

checkLLM();
</script>
{% endblock %}
