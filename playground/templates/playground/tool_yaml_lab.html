{% extends "base.html" %}
{% block extra_css %}
<style>
.lab-sidebar-list .nav-link.active { background-color: rgba(13,110,253,0.12); border-radius: 0.375rem; color: var(--primary-color); font-weight: 600; }
.code-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; padding: 12px 14px; font-family: Consolas, 'SF Mono', monospace; font-size: 13px; color: #1f2937; white-space: pre-wrap; word-break: break-all; max-height: 300px; overflow-y: auto; }
html[data-theme="dark"] .code-box { background: #1e293b; border-color: #334155; color: #e2e8f0; }
.attack-success { background: #fef2f2 !important; border-color: #ef4444 !important; }
html[data-theme="dark"] .attack-success { background: #450a0a !important; border-color: #dc2626 !important; }
.yaml-display { background: #fef3c7; border: 1px solid #fbbf24; padding: 8px 12px; font-family: monospace; font-size: 13px; margin-top: 8px; border-radius: 4px; white-space: pre-wrap; max-height: 150px; overflow-y: auto; }
html[data-theme="dark"] .yaml-display { background: #78350f; border-color: #f59e0b; color: #fef3c7; }
.principle-card { background: #f0f9ff; border: 1px solid #bae6fd; }
html[data-theme="dark"] .principle-card { background: #0c4a6e; border-color: #0369a1; }
.payload-btn { font-size: 12px; padding: 4px 8px; margin: 2px; }
.attack-indicator { display: none; padding: 8px 12px; margin-top: 8px; border-radius: 4px; }
.attack-indicator.show { display: block; }
.attack-indicator.success { background: #fef2f2; border: 1px solid #ef4444; color: #dc2626; }
.attack-indicator.safe { background: #f0fdf4; border: 1px solid #86efac; color: #16a34a; }
html[data-theme="dark"] .attack-indicator.success { background: #450a0a; border-color: #dc2626; color: #fca5a5; }
html[data-theme="dark"] .attack-indicator.safe { background: #14532d; border-color: #22c55e; color: #86efac; }
.chat-messages { max-height: 400px; overflow-y: auto; padding: 12px; }
.chat-msg { margin-bottom: 12px; max-width: 85%; }
.chat-msg.user { margin-left: auto; }
.chat-msg .bubble { padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.5; white-space: pre-wrap; }
.chat-msg.user .bubble { background: #3b82f6; color: #fff; border-bottom-right-radius: 4px; }
.chat-msg.bot .bubble { background: #f1f5f9; color: #1e293b; border-bottom-left-radius: 4px; }
html[data-theme="dark"] .chat-msg.bot .bubble { background: #334155; color: #e2e8f0; }
.chat-msg .label { font-size: 11px; color: #94a3b8; margin-bottom: 2px; }
.chat-msg.user .label { text-align: right; }
</style>
{% endblock %}
{% block content %}
<main class="lab-detail-main"><div class="lab-detail-container">
    {% url 'playground:lab_list' as lab_list_url %}
    {% include "playground/_lab_detail_header.html" with back_url=lab_list_url back_text="è¿”å›é¶åœºåˆ—è¡¨" title="ååºåˆ—åŒ–ï¼ˆYAMLï¼‰" title_icon="âš—ï¸" subtitle="ç”¨æˆ·å‘é€ YAML é…ç½® â†’ LLM åŸæ ·è¾“å‡º â†’ åç«¯ yaml.unsafe_load() è§£æï¼Œå¯è§¦å‘ä»»æ„ä»£ç æ‰§è¡Œã€‚" show_llm_button=True current_model=current_model %}

    {% include "playground/_lab_tools.html" with lab_slug="tool_security:yaml" %}
    {% include "playground/_llm_not_configured_alert.html" %}

    <div class="row">
        <div class="col-lg-8">
            <!-- æ”»å‡»åŸç† -->
            <div class="card shadow-sm mb-4 principle-card">
                <div class="card-header"><strong>ğŸ”¬ æ”»å‡»åŸç†</strong></div>
                <div class="card-body">
                    <p class="small mb-2">å½“ Agent å·¥å…·ä½¿ç”¨ <code>yaml.unsafe_load()</code> è§£æç”¨æˆ·æä¾›çš„ YAML æ—¶ï¼Œæ¶æ„ YAML æ ‡ç­¾å¯è§¦å‘ä»»æ„ä»£ç æ‰§è¡Œï¼š</p>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="small">
                                <strong>æ”»å‡»æµç¨‹ï¼š</strong>
                                <ol class="mb-0 ps-3">
                                    <li>ç”¨æˆ·æäº¤æ¶æ„ YAML å†…å®¹</li>
                                    <li>LLM åŸæ ·è½¬å‘ YAML</li>
                                    <li>åç«¯ unsafe_load() ååºåˆ—åŒ–</li>
                                    <li>YAML æ ‡ç­¾è§¦å‘ä»£ç æ‰§è¡Œ</li>
                                </ol>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="small">
                                <strong>å…³é”® YAML æ ‡ç­¾ï¼š</strong>
                                <ul class="mb-0 ps-3">
                                    <li><code>!!python/object/apply:</code></li>
                                    <li><code>!!python/object/new:</code></li>
                                    <li><code>!!python/module:</code></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¯¹è¯å¼æ”»å‡»æ¼”ç¤º -->
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>ğŸ¯ æ”»å‡»æ¼”ç¤º</strong>
                    <span class="badge bg-danger">é«˜å±æ¼æ´</span>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label small fw-semibold">å¿«é€Ÿæ”»å‡» Payloadï¼š</label>
                        <div class="d-flex flex-wrap gap-1">
                            <button class="btn btn-outline-danger payload-btn" id="p1">RCE (os.system)</button>
                            <button class="btn btn-outline-danger payload-btn" id="p2">è¯»å–æ–‡ä»¶</button>
                            <button class="btn btn-outline-danger payload-btn" id="p3">å¯¹è±¡å®ä¾‹åŒ–</button>
                            <button class="btn btn-outline-secondary payload-btn" id="p4">æ­£å¸¸ YAML</button>
                        </div>
                    </div>

                    <div class="border rounded mb-3" style="background:#fafbfc;">
                        <div class="chat-messages" id="chat-messages"></div>
                    </div>

                    <div class="mb-2">
                        <textarea class="form-control font-monospace" id="chat-input" rows="3" placeholder="è¾“å…¥ YAML å†…å®¹æˆ–æŒ‡ä»¤ï¼Œå¦‚ï¼šè§£æè¿™æ®µé…ç½®ï¼š&#10;key: value"></textarea>
                    </div>
                    <button class="btn btn-danger" id="chat-send">
                        <span class="spinner-border spinner-border-sm d-none me-1" id="loading-spinner"></span>
                        è§£æï¼ˆLLM â†’ unsafe_loadï¼‰
                    </button>

                    <div class="attack-indicator" id="attack-indicator">
                        <strong id="indicator-title"></strong>
                        <span id="indicator-desc" class="small ms-2"></span>
                    </div>
                </div>
            </div>

            <!-- é˜²å¾¡æªæ–½ -->
            <div class="card shadow-sm">
                <div class="card-header"><strong>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</strong></div>
                <div class="card-body small">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>ä»£ç å±‚é¢ï¼š</strong>
                            <ul class="mb-2 ps-3">
                                <li>ä½¿ç”¨ <code>yaml.safe_load()</code> æ›¿ä»£ <code>unsafe_load()</code></li>
                                <li>ç¦æ­¢ååºåˆ—åŒ–è‡ªå®šä¹‰å¯¹è±¡ç±»å‹</li>
                                <li>è¾“å…¥å†…å®¹å¤§å°é™åˆ¶</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <strong>æ¶æ„å±‚é¢ï¼š</strong>
                            <ul class="mb-0 ps-3">
                                <li>YAML è§£æåœ¨æ²™ç®±ä¸­æ‰§è¡Œ</li>
                                <li>ä½¿ç”¨ JSON æ›¿ä»£ YAML</li>
                                <li>LLM è¾“å‡ºå†…å®¹æ ¡éªŒ</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- LLM è¾“å‡ºçš„ YAML -->
            <div class="card shadow-sm mb-4">
                <div class="card-header"><strong>ğŸ“‹ LLM è¾“å‡ºçš„ YAML</strong></div>
                <div class="card-body">
                    <div class="yaml-display" id="yaml-input">â€”</div>
                </div>
            </div>

            <!-- è§£æç»“æœ -->
            <div class="card shadow-sm mb-4">
                <div class="card-header"><strong>âš™ï¸ unsafe_load ç»“æœ</strong></div>
                <div class="card-body">
                    <div class="code-box" id="parse-result" style="max-height:200px;">â€”</div>
                </div>
            </div>

            <!-- æ”»å‡»ç»Ÿè®¡ -->
            <div class="card shadow-sm mb-4">
                <div class="card-header"><strong>ğŸ“ˆ æ”»å‡»ç»Ÿè®¡</strong></div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="small">æµ‹è¯•æ¬¡æ•°</span>
                        <span class="fw-semibold" id="test-count">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="small">æ”»å‡»æˆåŠŸ</span>
                        <span class="fw-semibold text-danger" id="success-count">0</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="small">æˆåŠŸç‡</span>
                        <span class="fw-semibold" id="success-rate">0%</span>
                    </div>
                </div>
            </div>

            <!-- æ¼æ´ä»£ç  -->
            <div class="card shadow-sm">
                <div class="card-header"><strong>ğŸ› æ¼æ´ä»£ç </strong></div>
                <div class="card-body">
                    <pre class="small mb-0" style="font-size:11px;background:#1e293b;color:#e2e8f0;padding:10px;border-radius:4px;overflow-x:auto;"><code># æ¼æ´ï¼šä½¿ç”¨ unsafe_load
data = yaml.load(raw, Loader=yaml.UnsafeLoader)

# ä¿®å¤ï¼šä½¿ç”¨ safe_load
data = yaml.safe_load(raw)  # å®‰å…¨ï¼</code></pre>
                </div>
            </div>
        </div>
    </div>
</div></main>
<script>
function getCsrfToken() {
    var c = document.cookie.match(/csrftoken=([^;]+)/);
    if (c) return c[1];
    var el = document.querySelector('[name="csrfmiddlewaretoken"]');
    return el ? el.value : '';
}
(function(){
    var chatMessages = document.getElementById('chat-messages');
    var chatInput = document.getElementById('chat-input');
    var sendBtn = document.getElementById('chat-send');
    var spinner = document.getElementById('loading-spinner');
    var yamlEl = document.getElementById('yaml-input');
    var resultEl = document.getElementById('parse-result');
    var indicator = document.getElementById('attack-indicator');
    var apiUrl = '{% url "playground:tool_yaml_parse_api" %}';

    var testCount = 0, successCount = 0;

    function addMsg(text, role) {
        var d = document.createElement('div');
        d.className = 'chat-msg ' + role;
        var label = role === 'user' ? 'ä½ ' : 'AI Agent';
        d.innerHTML = '<div class="label">' + label + '</div><div class="bubble">' + escapeHtml(text) + '</div>';
        chatMessages.appendChild(d);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function escapeHtml(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    function updateStats() {
        document.getElementById('test-count').textContent = testCount;
        document.getElementById('success-count').textContent = successCount;
        document.getElementById('success-rate').textContent = testCount > 0 ? Math.round(successCount/testCount*100)+'%' : '0%';
    }

    function detectAttack(yaml) {
        yaml = (yaml || '').toLowerCase();
        if (yaml.includes('!!python/object')) return {is:true, desc:'æ£€æµ‹åˆ° Python å¯¹è±¡ååºåˆ—åŒ–æ”»å‡»'};
        if (yaml.includes('!!python/module')) return {is:true, desc:'æ£€æµ‹åˆ° Python æ¨¡å—å¯¼å…¥æ”»å‡»'};
        if (yaml.includes('os.system') || yaml.includes('subprocess')) return {is:true, desc:'æ£€æµ‹åˆ°ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œ'};
        return {is:false, desc:''};
    }

    function showIndicator(isAttack, desc) {
        indicator.classList.add('show');
        indicator.classList.toggle('success', isAttack);
        indicator.classList.toggle('safe', !isAttack);
        document.getElementById('indicator-title').textContent = isAttack ? 'âš ï¸ ååºåˆ—åŒ–æ”»å‡»ï¼' : 'âœ… æ­£å¸¸è§£æ';
        document.getElementById('indicator-desc').textContent = desc || '';
    }

    function doSend() {
        var m = (chatInput.value || '').trim();
        if (!m) return;
        addMsg(m, 'user');
        chatInput.value = '';
        spinner.classList.remove('d-none');
        sendBtn.disabled = true;
        indicator.classList.remove('show');

        fetch(apiUrl, {
            method: 'POST',
            headers: {'Content-Type':'application/json','X-CSRFToken':getCsrfToken()},
            body: JSON.stringify({message: m})
        })
        .then(function(r){ return r.json(); })
        .then(function(d){
            spinner.classList.add('d-none');
            sendBtn.disabled = false;
            testCount++;

            var yamlInput = d.yaml_input || '';
            yamlEl.textContent = yamlInput || 'â€”';

            if (d.llm_raw_reply) addMsg(d.llm_raw_reply, 'bot');

            if (d.error) {
                resultEl.textContent = 'é”™è¯¯: ' + d.error;
                resultEl.style.color = 'var(--bs-danger)';
            } else {
                resultEl.textContent = d.result || '(ç©º)';
                resultEl.style.color = '';
            }

            var det = detectAttack(yamlInput);
            if (det.is) {
                successCount++;
                resultEl.classList.add('attack-success');
            } else {
                resultEl.classList.remove('attack-success');
            }
            showIndicator(det.is, det.desc);
            updateStats();
        })
        .catch(function(e){
            spinner.classList.add('d-none');
            sendBtn.disabled = false;
            addMsg('è¯·æ±‚å¤±è´¥: ' + e.message, 'bot');
        });
    }

    sendBtn.addEventListener('click', doSend);
    chatInput.addEventListener('keypress', function(e){ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); doSend(); }});

    document.getElementById('p1').addEventListener('click', function(){ chatInput.value='è§£æè¿™æ®µé…ç½®ï¼š\n!!python/object/apply:os.system ["echo HACKED"]'; });
    document.getElementById('p2').addEventListener('click', function(){ chatInput.value='è§£æè¿™æ®µé…ç½®ï¼š\n!!python/object/apply:builtins.open ["/etc/passwd"]'; });
    document.getElementById('p3').addEventListener('click', function(){ chatInput.value='è§£æè¿™æ®µé…ç½®ï¼š\n!!python/object/new:subprocess.Popen\nargs: [["id"]]'; });
    document.getElementById('p4').addEventListener('click', function(){ chatInput.value='è§£æè¿™æ®µé…ç½®ï¼š\nname: test\nversion: 1.0\nfeatures:\n  - auth\n  - logging'; });
})();
</script>
{% endblock %}
