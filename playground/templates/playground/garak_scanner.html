{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'playground/css/lab_detail.css' %}">
<style>
/* Garak æ‰«æå™¨é¡µ - ä»…ä¿ç•™æœ¬é¡µä¸“å±æ ·å¼ï¼Œå¸ƒå±€ä¸å¤´éƒ¨ä½¿ç”¨ lab_detail.css + _lab_detail_header */

/* é…ç½®é¢æ¿ â†’ æ ‡å‡† .card ç´§å‡‘æ ·å¼ */
.config-panel {
    background: var(--surface);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 0.5rem;
}

.config-panel .card-header {
    padding: 4px 8px;
    background: var(--surface-2);
    border-bottom: 1px solid var(--border-color);
    border-radius: 8px 8px 0 0;
}

.config-panel .card-body {
    padding: 6px 10px;
}

/* æ¢é’ˆé€‰æ‹© */
.probe-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 0.4rem;
}

.probe-item {
    background: var(--surface);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 0.4rem;
    cursor: pointer;
    transition: all 0.2s;
}

.probe-item:hover {
    border-color: var(--primary-color);
}

.probe-item.selected {
    border-color: #ef4444;
    background: rgba(239, 68, 68, 0.05);
}

.probe-item input {
    margin-right: 0.5rem;
}

.probe-name {
    font-weight: 600;
    font-size: 0.78rem;
}

.probe-desc {
    font-size: 0.68rem;
    color: var(--muted);
    margin-top: 0.15rem;
}

/* ç»“æœé¢æ¿ â†’ æ ‡å‡† .card */
.result-panel {
    background: var(--surface);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
}

.result-header {
    padding: 4px 8px;
    background: var(--surface-2);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.result-body {
    padding: 6px 10px;
    max-height: 300px;
    overflow-y: auto;
}

/* æ—¥å¿—è¾“å‡º */
.scan-log {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.72rem;
    line-height: 1.6;
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 0.5rem;
    border-radius: 4px;
    max-height: 250px;
    overflow-y: auto;
}

.scan-log .log-info { color: #4ec9b0; }
.scan-log .log-warn { color: #dcdcaa; }
.scan-log .log-error { color: #f14c4c; }
.scan-log .log-success { color: #6a9955; }

/* æ¼æ´åˆ—è¡¨ */
.vuln-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.vuln-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.5rem;
    border-bottom: 1px solid var(--border-color);
}

.vuln-item:last-child {
    border-bottom: none;
}

.vuln-severity {
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-size: 0.68rem;
    font-weight: 600;
    text-transform: uppercase;
}

.vuln-severity.high { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
.vuln-severity.medium { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
.vuln-severity.low { background: rgba(34, 197, 94, 0.1); color: #22c55e; }

.vuln-content {
    flex: 1;
}

.vuln-title {
    font-weight: 600;
    font-size: 0.8rem;
    margin-bottom: 0.15rem;
}

.vuln-desc {
    font-size: 0.72rem;
    color: var(--muted);
}

/* è¿›åº¦æ¡ */
.scan-progress {
    height: 6px;
    border-radius: 3px;
    background: var(--bg-2);
    overflow: hidden;
    margin-top: 0.5rem;
}

.scan-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #ef4444, #f59e0b);
    transition: width 0.3s;
}

/* ç»Ÿè®¡å¡ç‰‡ */
.stat-card {
    background: var(--surface);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 0.4rem;
    text-align: center;
}

.stat-value {
    font-size: 1.3rem;
    font-weight: 800;
}

.stat-label {
    font-size: 0.7rem;
    color: var(--muted);
}

.stat-card.danger .stat-value { color: #ef4444; }
.stat-card.warning .stat-value { color: #f59e0b; }
.stat-card.success .stat-value { color: #22c55e; }
</style>
{% endblock %}

{% block content %}
<main class="lab-detail-main">
    <div class="lab-detail-container">
        {% url 'playground:redteam_index' as back_url %}
        {% include "playground/_lab_detail_header.html" with back_url=back_url back_text="è¿”å›çº¢é˜Ÿå·¥å…·ç®±" title="Garak Scanner" title_icon="ğŸ¦ˆ" subtitle="LLM æ¼æ´æ‰«æå™¨ - è‡ªåŠ¨æµ‹è¯•æç¤ºæ³¨å…¥ã€è¶Šç‹±ã€ä¿¡æ¯æ³„éœ²ç­‰æ”»å‡»å‘é‡" %}

        <div class="d-flex align-items-center justify-content-end gap-2 mb-2" style="margin-top:-0.25rem;">
            <span class="small text-muted">
                ç›®æ ‡æ¨¡å‹ï¼š<strong id="target-model">{{ current_model|default:"æœªé…ç½®" }}</strong>
            </span>
            <span class="small text-muted">
                Ollama çŠ¶æ€ï¼š<span id="ollama-status" class="badge bg-secondary" style="font-size:0.7rem;">æ£€æµ‹ä¸­...</span>
            </span>
        </div>

        <div class="row g-2">
            <!-- å·¦ä¾§ï¼šé…ç½® -->
            <div class="col-lg-3">
                <!-- ç›®æ ‡é…ç½® -->
                <div class="config-panel card">
                    <div class="card-header py-1 px-2 d-flex align-items-center">
                        <span class="me-1">ğŸ¯</span>
                        <strong style="font-size:0.82rem;">ç›®æ ‡é…ç½®</strong>
                    </div>
                    <div class="card-body" style="padding:6px 10px;">
                        <div class="mb-2">
                            <label class="form-label small mb-1">Ollama æ¨¡å‹</label>
                            <select class="form-select form-select-sm" id="model-select">
                                {% for model in available_models %}
                                <option value="{{ model }}" {% if model == current_model %}selected{% endif %}>{{ model }}</option>
                                {% empty %}
                                <option value="qwen2.5:7b">qwen2.5:7b</option>
                                <option value="qwen2.5:14b">qwen2.5:14b</option>
                                <option value="qwen2.5:32b">qwen2.5:32b</option>
                                <option value="llama3:8b">llama3:8b</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-1">
                            <label class="form-label small mb-1">æµ‹è¯•æ ·æœ¬æ•°ï¼ˆæ¯ä¸ªæ¢é’ˆï¼‰</label>
                            <input type="number" class="form-control form-control-sm" id="sample-count" value="5" min="1" max="20">
                        </div>
                    </div>
                </div>

                <!-- æ¢é’ˆé€‰æ‹© -->
                <div class="config-panel card">
                    <div class="card-header py-1 px-2 d-flex align-items-center justify-content-between">
                        <span>
                            <span class="me-1">ğŸ”¬</span>
                            <strong style="font-size:0.82rem;">æ¢é’ˆé€‰æ‹©</strong>
                        </span>
                        <button class="btn btn-sm btn-outline-secondary" style="font-size:0.7rem;padding:1px 6px;" onclick="toggleAllProbes()">å…¨é€‰/å–æ¶ˆ</button>
                    </div>
                    <div class="card-body" style="padding:6px 10px;">
                        <div class="probe-grid">
                            {% for probe in probes %}
                            <label class="probe-item" onclick="this.classList.toggle('selected')">
                                <input type="checkbox" name="probes" value="{{ probe.id }}" {% if probe.default %}checked{% endif %}>
                                <div class="probe-name">{{ probe.name }}</div>
                                <div class="probe-desc">{{ probe.description }}</div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- å¼€å§‹æ‰«æ -->
                <button class="btn btn-danger btn-sm w-100" id="start-scan-btn" onclick="startScan()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    å¼€å§‹æ‰«æ
                </button>
            </div>

            <!-- å³ä¾§ï¼šç»“æœ -->
            <div class="col-lg-9">
                <!-- ç»Ÿè®¡ -->
                <div class="row g-2 mb-2">
                    <div class="col-3">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-total">0</div>
                            <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-card danger">
                            <div class="stat-value" id="stat-high">0</div>
                            <div class="stat-label">é«˜å±æ¼æ´</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-card warning">
                            <div class="stat-value" id="stat-medium">0</div>
                            <div class="stat-label">ä¸­å±æ¼æ´</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-card success">
                            <div class="stat-value" id="stat-passed">0</div>
                            <div class="stat-label">é€šè¿‡æµ‹è¯•</div>
                        </div>
                    </div>
                </div>

                <!-- æ‰«ææ—¥å¿— -->
                <div class="result-panel mb-2">
                    <div class="result-header">
                        <span class="d-flex align-items-center">
                            <span class="me-1">ğŸ“‹</span>
                            <strong style="font-size:0.82rem;">æ‰«ææ—¥å¿—</strong>
                        </span>
                        <span id="scan-status" class="badge bg-secondary" style="font-size:0.68rem;">ç­‰å¾…å¼€å§‹</span>
                    </div>
                    <div class="result-body">
                        <div class="scan-log" id="scan-log">
<span class="log-info">[INFO] Garak Scanner å°±ç»ª</span>
<span class="log-info">[INFO] é€‰æ‹©æ¢é’ˆå¹¶ç‚¹å‡»"å¼€å§‹æ‰«æ"</span>
                        </div>
                        <div class="scan-progress" id="scan-progress" style="display: none;">
                            <div class="scan-progress-bar" id="scan-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- æ¼æ´åˆ—è¡¨ -->
                <div class="result-panel">
                    <div class="result-header">
                        <span class="d-flex align-items-center">
                            <span class="me-1">âš ï¸</span>
                            <strong style="font-size:0.82rem;">å‘ç°çš„æ¼æ´</strong>
                        </span>
                        <button class="btn btn-sm btn-outline-secondary" style="font-size:0.7rem;padding:1px 6px;" onclick="exportResults()">å¯¼å‡ºæŠ¥å‘Š</button>
                    </div>
                    <div class="result-body">
                        <ul class="vuln-list" id="vuln-list">
                            <li class="text-center text-muted py-3">
                                <div style="font-size: 2rem;">ğŸ”</div>
                                <p class="mb-0" style="font-size:0.8rem;">æ‰«æå®Œæˆåï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºå‘ç°çš„æ¼æ´</p>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
let isScanning = false;
let scanResults = [];

// æ£€æŸ¥ Ollama çŠ¶æ€
async function checkOllama() {
    try {
        const resp = await fetch('{% url "playground:garak_ollama_status" %}');
        const data = await resp.json();
        const badge = document.getElementById('ollama-status');
        if (data.online) {
            badge.className = 'badge bg-success';
            badge.textContent = 'åœ¨çº¿';
            if (data.models && data.models.length > 0) {
                const select = document.getElementById('model-select');
                select.innerHTML = data.models.map(m => 
                    `<option value="${m}">${m}</option>`
                ).join('');
            }
        } else {
            badge.className = 'badge bg-danger';
            badge.textContent = 'ç¦»çº¿';
        }
    } catch (e) {
        document.getElementById('ollama-status').className = 'badge bg-danger';
        document.getElementById('ollama-status').textContent = 'ç¦»çº¿';
    }
}

// åˆ‡æ¢å…¨é€‰
function toggleAllProbes() {
    const checkboxes = document.querySelectorAll('input[name="probes"]');
    const allChecked = Array.from(checkboxes).every(c => c.checked);
    checkboxes.forEach(c => {
        c.checked = !allChecked;
        c.closest('.probe-item').classList.toggle('selected', !allChecked);
    });
}

// æ·»åŠ æ—¥å¿—
function addLog(message, type = 'info') {
    const log = document.getElementById('scan-log');
    const line = document.createElement('div');
    line.className = `log-${type}`;
    line.textContent = `[${type.toUpperCase()}] ${message}`;
    log.appendChild(line);
    log.scrollTop = log.scrollHeight;
}

// æ›´æ–°ç»Ÿè®¡
function updateStats(total, high, medium, passed) {
    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-high').textContent = high;
    document.getElementById('stat-medium').textContent = medium;
    document.getElementById('stat-passed').textContent = passed;
}

// æ·»åŠ æ¼æ´
function addVulnerability(vuln) {
    const list = document.getElementById('vuln-list');
    if (list.querySelector('.text-center')) {
        list.innerHTML = '';
    }
    
    const li = document.createElement('li');
    li.className = 'vuln-item';
    li.innerHTML = `
        <span class="vuln-severity ${vuln.severity}">${vuln.severity}</span>
        <div class="vuln-content">
            <div class="vuln-title">${vuln.title}</div>
            <div class="vuln-desc">${vuln.description}</div>
            <details class="mt-2">
                <summary class="small text-muted" style="cursor: pointer;">æŸ¥çœ‹è¯¦æƒ…</summary>
                <pre class="mt-2 p-2 rounded" style="background: var(--bg-2); font-size: 0.8rem; white-space: pre-wrap;">${vuln.payload || 'æ— '}</pre>
            </details>
        </div>
    `;
    list.appendChild(li);
    scanResults.push(vuln);
}

// å¼€å§‹æ‰«æ
async function startScan() {
    if (isScanning) return;
    
    const probes = Array.from(document.querySelectorAll('input[name="probes"]:checked')).map(c => c.value);
    if (probes.length === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¢é’ˆ');
        return;
    }
    
    isScanning = true;
    scanResults = [];
    document.getElementById('start-scan-btn').disabled = true;
    document.getElementById('start-scan-btn').innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>æ‰«æä¸­...';
    document.getElementById('scan-status').className = 'badge bg-warning';
    document.getElementById('scan-status').textContent = 'æ‰«æä¸­';
    document.getElementById('scan-progress').style.display = 'block';
    document.getElementById('vuln-list').innerHTML = '';
    
    const model = document.getElementById('model-select').value;
    const sampleCount = parseInt(document.getElementById('sample-count').value);
    
    addLog(`å¼€å§‹æ‰«æï¼Œç›®æ ‡æ¨¡å‹: ${model}`, 'info');
    addLog(`é€‰æ‹©çš„æ¢é’ˆ: ${probes.join(', ')}`, 'info');
    
    try {
        const response = await fetch('{% url "playground:garak_scan_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                model: model,
                probes: probes,
                sample_count: sampleCount
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // å¤„ç†ç»“æœ
            let total = 0, high = 0, medium = 0, passed = 0;
            
            for (const result of data.results) {
                total += result.tests;
                
                for (const vuln of result.vulnerabilities) {
                    addVulnerability(vuln);
                    if (vuln.severity === 'high') high++;
                    else if (vuln.severity === 'medium') medium++;
                }
                
                passed += result.passed;
                addLog(`æ¢é’ˆ ${result.probe}: ${result.tests} æµ‹è¯•, ${result.vulnerabilities.length} æ¼æ´`, 
                    result.vulnerabilities.length > 0 ? 'warn' : 'success');
            }
            
            updateStats(total, high, medium, passed);
            document.getElementById('scan-progress-bar').style.width = '100%';
            
            addLog(`æ‰«æå®Œæˆï¼å‘ç° ${high + medium} ä¸ªæ¼æ´`, high > 0 ? 'error' : 'success');
            document.getElementById('scan-status').className = high > 0 ? 'badge bg-danger' : 'badge bg-success';
            document.getElementById('scan-status').textContent = high > 0 ? 'å‘ç°æ¼æ´' : 'æ‰«æå®Œæˆ';
        } else {
            addLog(`æ‰«æå¤±è´¥: ${data.error}`, 'error');
            document.getElementById('scan-status').className = 'badge bg-danger';
            document.getElementById('scan-status').textContent = 'å¤±è´¥';
        }
    } catch (e) {
        addLog(`é”™è¯¯: ${e.message}`, 'error');
        document.getElementById('scan-status').className = 'badge bg-danger';
        document.getElementById('scan-status').textContent = 'é”™è¯¯';
    }
    
    isScanning = false;
    document.getElementById('start-scan-btn').disabled = false;
    document.getElementById('start-scan-btn').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>å¼€å§‹æ‰«æ';
}

// å¯¼å‡ºç»“æœ
function exportResults() {
    if (scanResults.length === 0) {
        alert('æš‚æ— æ‰«æç»“æœ');
        return;
    }
    
    const report = {
        timestamp: new Date().toISOString(),
        model: document.getElementById('model-select').value,
        vulnerabilities: scanResults
    };
    
    const blob = new Blob([JSON.stringify(report, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `garak-report-${Date.now()}.json`;
    a.click();
}

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ Ollama
checkOllama();
</script>
{% endblock %}
