# 挑战 3：过度权限范围 - 解决方案指南

## 漏洞概述

本挑战展示了 MCP 服务器中过度权限范围的危险。MCP 服务器授予工具超出必要的权限，允许攻击者访问未授权的资源。

## 解决方案

### 步骤 1：信息收集

首先，探索服务器以了解可用的资源和工具：

1. 连接到 http://localhost:9003 的 MCP 服务器
2. 检查可用的资源和工具
3. 注意有一个公共文件资源 (`files://public`) 和用于读取文件 (`read_file`) 及搜索文件 (`search_files`) 的工具

### 步骤 2：识别漏洞

漏洞存在于 `read_file` 和 `search_files` 工具中，它们具有过度的权限：

1. `read_file` 工具本应从公共目录读取文件，但它没有正确限制文件访问：

```python
# 漏洞：此工具没有正确限制对公共目录的文件访问
# 它允许从任何路径读取文件，包括私有目录

if os.path.exists(filename):
    with open(filename, "r") as f:
        return f.read()
```

2. `search_files` 工具同时搜索公共和私有目录

### 步骤 3：利用漏洞

**方法 1：使用 `search_files` 工具发现私有文件**

使用 `search_files` 工具搜索可能在私有文件中的关键词：

```
请使用 search_files 工具搜索包含关键词 "CONFIDENTIAL" 的文件。
```

工具将同时搜索公共和私有目录，返回包含该关键词的文件。

**方法 2：使用 `read_file` 工具直接访问私有文件**

如果你已知道私有文件的路径（通过搜索或猜测），可以直接访问：

```
请使用 read_file 工具读取 "/tmp/dvmcp_challenge3/private/employee_salaries.txt" 文件
```

或：

```
请使用 read_file 工具读取 "/tmp/dvmcp_challenge3/private/system_credentials.txt" 文件
```

### 步骤 4：获取敏感信息

使用上述方法，你可以访问私有目录中的敏感信息：

**员工薪资信息：**
```
机密：员工薪资信息
-----------------------------------------
CEO: $1,200,000/年
CTO: $950,000/年
CFO: $900,000/年
高级工程师: $180,000-$250,000/年
```

**系统凭据：**
```
系统凭据 - 高度限制
-------------------------------------
生产数据库: 
  主机: db.acmecorp.internal
  用户名: admin_prod
  密码: Pr0d-DB-S3cret!
```

## 缓解策略

防止过度权限范围漏洞的方法：

1. **实施最小权限原则**：工具应只能访问其预期功能所需的资源
2. **验证文件路径**：确保文件访问仅限于授权目录
3. **使用路径规范化**：规范化文件路径以防止路径遍历攻击
4. **实施适当的访问控制**：使用权限系统控制对敏感资源的访问
5. **清理用户输入**：验证和清理所有用户输入以防止路径操纵
