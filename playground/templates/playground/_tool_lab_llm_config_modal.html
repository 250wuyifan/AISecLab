<!-- é¶åœºé…ç½®å¼¹å±‚ï¼šAJAX åŠ è½½ & ä¿å­˜ï¼Œä¸ç¦»å¼€å½“å‰é¡µé¢ -->
<div class="modal fade" id="llmConfigModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">âš™ï¸ å¤§æ¨¡å‹é…ç½®</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="llmConfigModalBody">
        <div class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
          <span class="ms-2 text-muted">åŠ è½½é…ç½®...</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
    var modal = document.getElementById('llmConfigModal');
    if (!modal) return;
    var loaded = false;

    modal.addEventListener('show.bs.modal', function() {
        if (loaded) return;
        loadConfigForm();
    });

    function loadConfigForm() {
        var body = document.getElementById('llmConfigModalBody');

        fetch('{% url "playground:llm_config" %}', {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(r) { return r.text(); })
        .then(function(html) {
            var tmp = document.createElement('div');
            tmp.innerHTML = html;
            var card = tmp.querySelector('.card-body') || tmp.querySelector('form') || tmp;

            body.innerHTML =
                '<div id="llmConfigAlert" style="display:none;"></div>' +
                '<form id="llmConfigForm">' +
                '<input type="hidden" name="csrfmiddlewaretoken" value="' + getCsrf() + '">' +
                extractFormFields(card) +
                '<hr class="my-3">' +
                '<div class="d-flex justify-content-between align-items-center">' +
                '  <span class="text-muted small">ğŸ’¡ Ollama æœ¬åœ°å…è´¹æ— éœ€ Key</span>' +
                '  <div class="d-flex gap-2">' +
                '    <button type="button" class="btn btn-outline-success btn-sm" id="modalTestBtn">ğŸ”— æµ‹è¯•</button>' +
                '    <button type="submit" class="btn btn-primary btn-sm px-3" id="modalSaveBtn">ğŸ’¾ ä¿å­˜</button>' +
                '  </div>' +
                '</div>' +
                '</form>';

            // å¿«æ·é¢„è®¾
            body.querySelectorAll('.preset-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var f = body.querySelector('form');
                    var p = f.querySelector('[name="provider"]');
                    var a = f.querySelector('[name="api_base"]');
                    var m = f.querySelector('[name="default_model"]');
                    if (p) p.value = this.dataset.provider;
                    if (a) a.value = this.dataset.apiBase;
                    if (m) m.value = this.dataset.model;

                    body.querySelectorAll('.preset-btn').forEach(function(b) {
                        b.classList.remove('btn-primary');
                        b.classList.add('btn-outline-secondary');
                    });
                    this.classList.remove('btn-outline-secondary');
                    this.classList.add('btn-primary');
                });
            });

            // AJAX ä¿å­˜
            var form = document.getElementById('llmConfigForm');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                saveConfig();
            });

            // æµ‹è¯•è¿æ¥
            var testBtn = document.getElementById('modalTestBtn');
            if (testBtn) {
                testBtn.addEventListener('click', function() { testConnection(); });
            }

            loaded = true;
        })
        .catch(function() {
            body.innerHTML = '<div class="text-center py-4">' +
                '<p class="text-muted">åŠ è½½å¤±è´¥ï¼Œè¯·ç›´æ¥è®¿é—® <a href="{% url "playground:llm_config" %}">é…ç½®é¡µé¢</a></p>' +
                '</div>';
        });
    }

    function saveConfig() {
        var form = document.getElementById('llmConfigForm');
        var btn = document.getElementById('modalSaveBtn');
        var alert = document.getElementById('llmConfigAlert');

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>ä¿å­˜ä¸­...';

        var formData = new FormData(form);

        fetch('{% url "playground:llm_config" %}', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: formData,
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            btn.disabled = false;
            btn.innerHTML = 'ğŸ’¾ ä¿å­˜';

            if (data.success) {
                alert.style.display = 'block';
                alert.className = 'alert alert-success small py-2 mb-3';
                alert.textContent = 'âœ… ' + (data.message || 'é…ç½®å·²ä¿å­˜');

                // æ›´æ–°é¡µé¢ä¸Šæ˜¾ç¤ºçš„æ¨¡å‹å
                var badges = document.querySelectorAll('.lab-detail-model-badge');
                badges.forEach(function(b) {
                    if (data.model) {
                        b.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>' + data.model;
                    }
                });

                // éšè—"æœªé…ç½®"æé†’
                var notConfigured = document.querySelector('.llm-not-configured-alert');
                if (notConfigured && data.enabled) {
                    notConfigured.style.display = 'none';
                }

                // 1.5 ç§’åè‡ªåŠ¨å…³é—­å¼¹å±‚
                setTimeout(function() {
                    var bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) bsModal.hide();
                    alert.style.display = 'none';
                }, 1500);
            } else {
                alert.style.display = 'block';
                alert.className = 'alert alert-danger small py-2 mb-3';
                alert.textContent = 'âŒ ' + (data.error || 'ä¿å­˜å¤±è´¥');
            }
        })
        .catch(function(err) {
            btn.disabled = false;
            btn.innerHTML = 'ğŸ’¾ ä¿å­˜';
            alert.style.display = 'block';
            alert.className = 'alert alert-danger small py-2 mb-3';
            alert.textContent = 'âŒ è¯·æ±‚å¤±è´¥ï¼š' + err.message;
        });
    }

    function testConnection() {
        var btn = document.getElementById('modalTestBtn');
        var alert = document.getElementById('llmConfigAlert');

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>æµ‹è¯•ä¸­...';
        alert.style.display = 'block';
        alert.className = 'alert alert-info small py-2 mb-3';
        alert.textContent = 'â³ æ­£åœ¨è°ƒç”¨å¤§æ¨¡å‹ï¼Œè¯·ç¨å€™...';

        fetch('{% url "playground:llm_test_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrf(),
            }
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            btn.disabled = false;
            btn.innerHTML = 'ğŸ”— æµ‹è¯•';
            if (data.success) {
                alert.className = 'alert alert-success small py-2 mb-3';
                alert.innerHTML = 'âœ… è¿æ¥æˆåŠŸï¼æ¨¡å‹ï¼š<strong>' + (data.model || 'æœªçŸ¥') + '</strong>ï¼Œå›å¤ï¼š<code>' + (data.reply || '(ç©º)') + '</code>';
            } else {
                alert.className = 'alert alert-danger small py-2 mb-3';
                alert.textContent = 'âŒ ' + (data.error || 'è¿æ¥å¤±è´¥');
            }
        })
        .catch(function(err) {
            btn.disabled = false;
            btn.innerHTML = 'ğŸ”— æµ‹è¯•';
            alert.className = 'alert alert-danger small py-2 mb-3';
            alert.textContent = 'âŒ è¯·æ±‚å¤±è´¥ï¼š' + err.message;
        });
    }

    function getCsrf() {
        var c = document.cookie.match(/csrftoken=([^;]+)/);
        if (c) return c[1];
        var el = document.querySelector('[name="csrfmiddlewaretoken"]');
        return el ? el.value : '';
    }

    function extractFormFields(container) {
        var presets = '<div class="mb-3">' +
            '<label class="form-label fw-semibold small text-muted">å¿«æ·é¢„è®¾</label>' +
            '<div class="d-flex gap-2 flex-wrap">' +
            '<button type="button" class="btn btn-sm btn-outline-secondary preset-btn" data-provider="ollama" data-api-base="http://127.0.0.1:11434/v1/chat/completions" data-model="qwen2.5:32b">ğŸ¦™ Ollama</button>' +
            '<button type="button" class="btn btn-sm btn-outline-secondary preset-btn" data-provider="openai" data-api-base="https://api.openai.com/v1/chat/completions" data-model="gpt-4o-mini">ğŸ¤– OpenAI</button>' +
            '<button type="button" class="btn btn-sm btn-outline-secondary preset-btn" data-provider="deepseek" data-api-base="https://api.deepseek.com/v1/chat/completions" data-model="deepseek-chat">ğŸ”® DeepSeek</button>' +
            '<button type="button" class="btn btn-sm btn-outline-secondary preset-btn" data-provider="siliconflow" data-api-base="https://api.siliconflow.cn/v1/chat/completions" data-model="Qwen/Qwen3-8B">âš¡ ç¡…åŸºæµåŠ¨</button>' +
            '</div></div><hr class="my-3">';

        var fields = container.querySelectorAll('.mb-3, .mb-4, .form-check');
        var html = presets;
        fields.forEach(function(f) {
            if (f.querySelector('.preset-btn') || f.querySelector('[type="submit"]')) return;
            html += f.outerHTML;
        });
        return html;
    }
})();
</script>
