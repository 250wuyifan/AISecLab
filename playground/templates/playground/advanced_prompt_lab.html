{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'playground/css/lab_detail.css' %}">
<style>
/* â”€â”€ é€šç”¨æ ·å¼ â”€â”€ */
.code-box { background:#f8fafc; border:1px solid #e2e8f0; border-radius:4px; padding:12px 14px; font-family:Consolas,'SF Mono',monospace; font-size:13px; color:#1f2937; white-space:pre-wrap; word-break:break-all; }
html[data-theme="dark"] .code-box { background:#1e293b; border-color:#334155; color:#e2e8f0; }
.principle-card { background:#f0f9ff; border:1px solid #bae6fd; }
html[data-theme="dark"] .principle-card { background:#0c4a6e; border-color:#0369a1; }
.payload-btn { font-size:12px; padding:4px 10px; margin:2px; }

/* â”€â”€ æ”»å‡»æŒ‡ç¤ºå™¨ â”€â”€ */
.attack-indicator { display:none; padding:10px 14px; margin-top:10px; border-radius:6px; font-size:13px; }
.attack-indicator.show { display:block; }
.attack-indicator.critical { background:#fef2f2; border:1px solid #ef4444; color:#dc2626; }
.attack-indicator.warning { background:#fffbeb; border:1px solid #f59e0b; color:#d97706; }
.attack-indicator.safe { background:#f0fdf4; border:1px solid #86efac; color:#16a34a; }
html[data-theme="dark"] .attack-indicator.critical { background:#450a0a; border-color:#dc2626; color:#fca5a5; }
html[data-theme="dark"] .attack-indicator.warning { background:#451a03; border-color:#f59e0b; color:#fcd34d; }
html[data-theme="dark"] .attack-indicator.safe { background:#14532d; border-color:#22c55e; color:#86efac; }

/* â”€â”€ èŠå¤©åŒºåŸŸ â”€â”€ */
.adv-chat-messages { height:380px; overflow-y:auto; padding:14px; background:#fafbfc; border:1px solid var(--border-color); border-radius:6px; }
html[data-theme="dark"] .adv-chat-messages { background:var(--surface); }
.chat-msg { margin-bottom:12px; display:flex; }
.chat-msg.user { justify-content:flex-end; }
.chat-msg.ai { justify-content:flex-start; }
.chat-bubble { max-width:80%; padding:10px 14px; border-radius:12px; font-size:13px; line-height:1.6; white-space:pre-wrap; word-break:break-word; }
.chat-msg.user .chat-bubble { background:#2563eb; color:#fff; border-bottom-right-radius:4px; }
.chat-msg.ai .chat-bubble { background:#fff; border:1px solid #e5e7eb; color:#1f2937; border-bottom-left-radius:4px; }
html[data-theme="dark"] .chat-msg.user .chat-bubble { background:#1d4ed8; }
html[data-theme="dark"] .chat-msg.ai .chat-bubble { background:var(--surface-2); border-color:var(--border-color); color:var(--text); }

/* â”€â”€ ç³»ç»Ÿæç¤ºç¼–è¾‘å™¨ï¼ˆæŠ•æ¯’ä¸“ç”¨ï¼‰ â”€â”€ */
.prompt-editor { font-family:Consolas,'SF Mono',monospace; font-size:12px; min-height:180px; resize:vertical; }

/* â”€â”€ URL é¢„è§ˆï¼ˆURLæ³¨å…¥ä¸“ç”¨ï¼‰ â”€â”€ */
.url-preview { background:#fef3c7; border:1px solid #fbbf24; padding:8px 12px; font-family:monospace; font-size:12px; border-radius:4px; word-break:break-all; }
html[data-theme="dark"] .url-preview { background:#78350f; border-color:#f59e0b; color:#fef3c7; }

/* â”€â”€ Token ç»Ÿè®¡ï¼ˆCoT DoS ä¸“ç”¨ï¼‰ â”€â”€ */
.token-bar { height:20px; background:#e2e8f0; border-radius:10px; overflow:hidden; }
.token-bar-fill { height:100%; border-radius:10px; transition:width .5s ease; }
.token-bar-fill.low { background:#22c55e; }
.token-bar-fill.mid { background:#f59e0b; }
.token-bar-fill.high { background:#ef4444; }

/* â”€â”€ æ³„éœ²é«˜äº® â”€â”€ */
.leak-highlight { background:#fef08a; color:#92400e; padding:1px 4px; border-radius:2px; font-weight:600; }
html[data-theme="dark"] .leak-highlight { background:#854d0e; color:#fef08a; }

/* â”€â”€ ç»Ÿè®¡æ•°å­— â”€â”€ */
.stat-number { font-size:28px; font-weight:700; color:var(--primary-color); }
.stat-label { font-size:12px; color:var(--muted); }

/* â”€â”€ ç³»ç»Ÿæç¤ºæ˜¾ç¤º â”€â”€ */
.system-prompt-display { background:#fefce8; border:1px solid #fde68a; padding:10px; font-family:monospace; font-size:11px; white-space:pre-wrap; border-radius:4px; max-height:200px; overflow-y:auto; display:none; }
html[data-theme="dark"] .system-prompt-display { background:#422006; border-color:#92400e; color:#fef3c7; }
</style>
{% endblock %}

{% block content %}
<main class="lab-detail-main"><div class="lab-detail-container">
    {% url 'playground:lab_list' as lab_list_url %}
    {% include "playground/_lab_detail_header.html" with back_url=lab_list_url back_text="è¿”å›é¶åœºåˆ—è¡¨" title=config.title title_icon=config.title_icon subtitle=config.subtitle show_llm_button=True current_model=current_model %}

    {% include "playground/_llm_not_configured_alert.html" %}

    <div class="row g-4">
        <!-- â•â•â•â•â•â•â• å·¦æ ï¼šæ”»å‡»æ¼”ç»ƒ â•â•â•â•â•â•â• -->
        <div class="col-lg-8">

            <!-- æ”»å‡»åŸç†ï¼ˆå¯æŠ˜å ï¼‰ -->
            <div class="card shadow-sm mb-3 principle-card">
                <div class="card-header d-flex justify-content-between align-items-center" style="cursor:pointer" onclick="this.parentElement.querySelector('.card-body').classList.toggle('d-none')">
                    <strong>ğŸ”¬ æ”»å‡»åŸç†</strong>
                    <small class="text-muted">ç‚¹å‡»å±•å¼€/æ”¶èµ·</small>
                </div>
                <div class="card-body small">
                    {{ config.attack_principle|safe }}
                    {% if config.vuln_root_cause %}
                    <div class="mt-2 p-2 bg-opacity-10 bg-danger rounded">
                        <strong>ğŸ¯ æ¼æ´æ ¹å› ï¼š</strong>{{ config.vuln_root_cause }}
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if variant == 'system-prompt-poison' %}
            <!-- â•â•â• ç³»ç»Ÿæç¤ºç¼–è¾‘å™¨ï¼ˆæŠ•æ¯’ä¸“ç”¨ï¼‰ â•â•â• -->
            <div class="card shadow-sm mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>â˜ ï¸ ç³»ç»Ÿæç¤ºæ¨¡æ¿ç¼–è¾‘å™¨ï¼ˆæ¨¡æ‹Ÿè¿è¥åå°ï¼‰</strong>
                    <span class="badge bg-warning text-dark">ä¾›åº”é“¾æ”»å‡»é¢</span>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-2">æ¨¡æ‹Ÿåœºæ™¯ï¼šä½ æ˜¯æ”»å‡»è€…ï¼Œå·²è·å–è¿è¥åå°æƒé™ã€‚ä¿®æ”¹ä¸‹æ–¹ç³»ç»Ÿæç¤ºæ¨¡æ¿åï¼Œæ‰€æœ‰ä½¿ç”¨æ­¤æ¨¡æ¿çš„ AI ä¼šè¯éƒ½å°†å—åˆ°å½±å“ã€‚</p>
                    <div class="mb-2">
                        <label class="form-label small fw-semibold">æŠ•æ¯’æ¨¡æ¿ï¼š</label>
                        <div class="mb-1">
                            {% for ex in config.poisoned_examples %}
                            <button class="btn btn-outline-warning btn-sm payload-btn" onclick="loadPoisonedPrompt({{ forloop.counter0 }})">{{ ex.label }}</button>
                            {% endfor %}
                            <button class="btn btn-outline-success btn-sm payload-btn" onclick="resetCleanPrompt()">ğŸ”„ è¿˜åŸå¹²å‡€æ¨¡æ¿</button>
                        </div>
                    </div>
                    <textarea class="form-control prompt-editor" id="system-prompt-editor">{{ default_clean_prompt }}</textarea>
                    <small class="text-muted mt-1 d-block">ç¼–è¾‘åçš„æ¨¡æ¿å°†åœ¨ä¸‹æ–¹å¯¹è¯ä¸­ç”Ÿæ•ˆã€‚ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶ï¼ŒAI å°†ä½¿ç”¨ä½ ä¿®æ”¹åçš„ç³»ç»Ÿæç¤ºã€‚</small>
                </div>
            </div>
            {% endif %}

            {% if variant == 'prompt-url' %}
            <!-- â•â•â• URL é¢„è§ˆï¼ˆURLæ³¨å…¥ä¸“ç”¨ï¼‰ â•â•â• -->
            <div class="card shadow-sm mb-3">
                <div class="card-header">
                    <strong>ğŸ”— URL å‚æ•°æ„é€ å™¨</strong>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-2">æ¨¡æ‹Ÿåœºæ™¯ï¼šæ”»å‡»è€…æ„é€ æ¶æ„ URLï¼Œç”¨æˆ·ç‚¹å‡»åå‚æ•°è¢«æ³¨å…¥ Agent çš„ç³»ç»Ÿæç¤ºã€‚</p>
                    <div class="url-preview" id="url-preview">
                        https://ai-search.example.com/search?q=<span id="url-query-display" class="fw-bold">Pythonæ•™ç¨‹</span>
                    </div>
                    <small class="text-muted mt-1 d-block">è¾“å…¥æ¡†ä¸­çš„å†…å®¹å°†ä½œä¸º <code>?q=</code> å‚æ•°æ³¨å…¥åˆ° Agent çš„ system prompt ä¸­</small>
                </div>
            </div>
            {% endif %}

            <!-- â•â•â• æ”»å‡»æ¼”ç¤ºåŒº â•â•â• -->
            <div class="card shadow-sm mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>ğŸ¯ æ”»å‡»æ¼”ç¤º</strong>
                    <span class="badge bg-danger">äº¤äº’å¼å®éªŒ</span>
                </div>
                <div class="card-body">
                    <!-- å¿«é€Ÿ Payload -->
                    <div class="mb-3">
                        <label class="form-label small fw-semibold">å¿«é€Ÿæ”»å‡» Payloadï¼š</label>
                        <div id="payload-buttons">
                            {% for p in config.payloads %}
                            <button class="btn btn-outline-danger payload-btn" onclick="setPayload({{ forloop.counter0 }})">{{ p.label }}</button>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- èŠå¤©åŒºåŸŸ -->
                    <div class="adv-chat-messages" id="chat-messages">
                        <div class="chat-msg ai">
                            <div class="chat-bubble">ğŸ‘‹ æ¬¢è¿æ¥åˆ°ã€Œ{{ config.title }}ã€é¶åœºã€‚è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¶ˆæ¯æˆ–é€‰æ‹©é¢„è®¾ Payload å¼€å§‹å®éªŒã€‚</div>
                        </div>
                    </div>

                    <!-- è¾“å…¥åŒº -->
                    <div class="mt-2 d-flex gap-2">
                        <textarea class="form-control" id="user-input" rows="3" placeholder="è¾“å…¥æ”»å‡» Payload æˆ–æ­£å¸¸æ¶ˆæ¯..."></textarea>
                        <button class="btn btn-danger align-self-end" id="send-btn" style="white-space:nowrap">
                            <span class="spinner-border spinner-border-sm d-none me-1" id="loading-spinner"></span>
                            å‘é€
                        </button>
                    </div>

                    <!-- æ”»å‡»ç»“æœæŒ‡ç¤ºå™¨ -->
                    <div class="attack-indicator" id="attack-indicator">
                        <strong id="indicator-title"></strong>
                        <div id="indicator-details" class="small mt-1"></div>
                    </div>

                    {% if variant == 'prompt-url' or variant == 'context-confusion' or variant == 'system-prompt-poison' %}
                    <!-- å®é™…ä½¿ç”¨çš„ System Prompt -->
                    <div class="mt-2">
                        <a href="javascript:void(0)" class="small" onclick="document.getElementById('actual-prompt').style.display = document.getElementById('actual-prompt').style.display === 'none' ? 'block' : 'none'">
                            ğŸ“‹ æŸ¥çœ‹å®é™…å‘é€ç»™ LLM çš„ System Prompt
                        </a>
                        <div class="system-prompt-display" id="actual-prompt"></div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- é˜²å¾¡å»ºè®® -->
            <div class="card shadow-sm">
                <div class="card-header"><strong>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</strong></div>
                <div class="card-body small">
                    <ul class="mb-0 ps-3">
                        {% for tip in config.defense_tips %}
                        <li>{{ tip }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â• å³æ ï¼šç»Ÿè®¡ä¸ä¿¡æ¯ â•â•â•â•â•â•â• -->
        <div class="col-lg-4">
            <!-- æ”»å‡»ç»Ÿè®¡ -->
            <div class="card shadow-sm mb-3">
                <div class="card-header"><strong>ğŸ“Š æ”»å‡»ç»Ÿè®¡</strong></div>
                <div class="card-body text-center">
                    <div class="row">
                        <div class="col-4">
                            <div class="stat-number" id="stat-total">0</div>
                            <div class="stat-label">æ€»å°è¯•</div>
                        </div>
                        <div class="col-4">
                            <div class="stat-number text-danger" id="stat-success">0</div>
                            <div class="stat-label">æ”»å‡»æˆåŠŸ</div>
                        </div>
                        <div class="col-4">
                            <div class="stat-number text-success" id="stat-safe">0</div>
                            <div class="stat-label">å·²é˜²å¾¡</div>
                        </div>
                    </div>
                </div>
            </div>

            {% if variant == 'cot-dos' %}
            <!-- Token æ¶ˆè€—ç›‘æ§ -->
            <div class="card shadow-sm mb-3">
                <div class="card-header"><strong>ğŸ“ˆ Token æ¶ˆè€—ç›‘æ§</strong></div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted">å½“å‰å“åº”</small>
                        <div class="d-flex justify-content-between">
                            <span class="fw-semibold" id="token-current">0</span>
                            <span class="text-muted small">Token</span>
                        </div>
                        <div class="token-bar mt-1">
                            <div class="token-bar-fill low" id="token-bar" style="width:0%"></div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">å†å²æœ€é«˜</small>
                        <div class="fw-semibold text-danger" id="token-max">0</div>
                    </div>
                    <div>
                        <small class="text-muted">ç´¯è®¡æ¶ˆè€—</small>
                        <div class="fw-semibold" id="token-total">0</div>
                    </div>
                    <hr>
                    <div class="small text-muted">
                        ğŸ’¡ æ­£å¸¸é—®ç­”çº¦ 50~200 Token<br>
                        âš ï¸ >500 Token è¡¨ç¤ºèµ„æºæ¶ˆè€—è¿‡å¤š<br>
                        ğŸ”´ >1000 Token ä¸º DoS çº§åˆ«
                    </div>
                </div>
            </div>
            {% endif %}

            {% if variant == 'reasoning-leak' %}
            <!-- æ³„éœ²ä¿¡æ¯è¿½è¸ª -->
            <div class="card shadow-sm mb-3">
                <div class="card-header"><strong>ğŸ” æ•æ„Ÿä¿¡æ¯è¿½è¸ª</strong></div>
                <div class="card-body">
                    <div class="small">
                        <div class="mb-1">
                            <span class="badge bg-secondary" id="track-apikey">ğŸ”’ API å¯†é’¥</span>
                        </div>
                        <div class="mb-1">
                            <span class="badge bg-secondary" id="track-password">ğŸ”’ ç®¡ç†å‘˜å¯†ç </span>
                        </div>
                        <div class="mb-1">
                            <span class="badge bg-secondary" id="track-dbconn">ğŸ”’ æ•°æ®åº“è¿æ¥ä¸²</span>
                        </div>
                        <div class="mb-1">
                            <span class="badge bg-secondary" id="track-version">ğŸ”’ ç³»ç»Ÿç‰ˆæœ¬å·</span>
                        </div>
                        <div class="mb-1">
                            <span class="badge bg-secondary" id="track-audit">ğŸ”’ å®¡è®¡ä»¤ç‰Œ</span>
                        </div>
                    </div>
                    <hr>
                    <small class="text-muted">
                        å°è¯•ä½¿ç”¨ä¸åŒæ‰‹æ®µè¯±å¯¼ AI æ³„éœ²è¿™äº›ä¿¡æ¯ã€‚<br>
                        æ³„éœ²çš„ä¿¡æ¯ä¼šå®æ—¶æ ‡è®°ä¸º <span class="badge bg-danger">å·²æ³„éœ²</span>
                    </small>
                </div>
            </div>
            {% endif %}

            <!-- å“åº”æ—¶é—´ -->
            <div class="card shadow-sm mb-3">
                <div class="card-header"><strong>â±ï¸ æœ€è¿‘å“åº”</strong></div>
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <span class="small text-muted">å“åº”æ—¶é—´</span>
                        <span class="fw-semibold" id="last-elapsed">â€”</span>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <span class="small text-muted">å›å¤é•¿åº¦</span>
                        <span class="fw-semibold" id="last-length">â€”</span>
                    </div>
                </div>
            </div>

            <!-- æ³¨æ„äº‹é¡¹ -->
            <div class="card shadow-sm">
                <div class="card-header"><strong>âš ï¸ å®‰å…¨æé†’</strong></div>
                <div class="card-body small text-muted">
                    æœ¬é¶åœºä»…ç”¨äºå®‰å…¨ç ”ç©¶å’Œæ•™è‚²ç›®çš„ã€‚æ‰€æœ‰æ”»å‡»æ¼”ç¤ºå‡åœ¨éš”ç¦»ç¯å¢ƒä¸­è¿›è¡Œï¼Œ
                    ä¸ä¼šå½±å“çœŸå®ç³»ç»Ÿã€‚è¯·å‹¿å°†è¿™äº›æŠ€æœ¯ç”¨äºæœªæˆæƒçš„æ”»å‡»è¡Œä¸ºã€‚
                </div>
            </div>
        </div>
    </div>
</div></main>

{% include "playground/_tool_lab_llm_config_modal.html" %}
{% endblock %}

{% block extra_js %}
<script>
(function() {
    // â”€â”€ é…ç½®æ•°æ® â”€â”€
    const VARIANT = '{{ variant }}';
    const CONFIG = JSON.parse('{{ config_json|escapejs }}');
    const PAYLOADS = CONFIG.payloads || [];
    {% if variant == 'system-prompt-poison' %}
    const POISONED_EXAMPLES = JSON.parse('{{ poisoned_examples_json|escapejs }}');
    const CLEAN_PROMPT = document.getElementById('system-prompt-editor') ? document.getElementById('system-prompt-editor').defaultValue : '';
    {% endif %}

    // â”€â”€ DOM å…ƒç´  â”€â”€
    const chatBox = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const spinner = document.getElementById('loading-spinner');
    const indicator = document.getElementById('attack-indicator');
    const indicatorTitle = document.getElementById('indicator-title');
    const indicatorDetails = document.getElementById('indicator-details');

    // â”€â”€ ç»Ÿè®¡ â”€â”€
    let stats = { total: 0, success: 0, safe: 0 };
    let history = [];
    // CoT DoS ä¸“ç”¨
    let tokenMax = 0, tokenTotal = 0;
    // æ¨ç†æ³„éœ²ä¸“ç”¨
    let leakedSet = new Set();

    // â”€â”€ å¿«é€Ÿ Payload â”€â”€
    window.setPayload = function(idx) {
        if (PAYLOADS[idx]) {
            userInput.value = PAYLOADS[idx].value || PAYLOADS[idx];
            {% if variant == 'prompt-url' %}
            updateUrlPreview();
            {% endif %}
        }
    };

    {% if variant == 'system-prompt-poison' %}
    window.loadPoisonedPrompt = function(idx) {
        if (POISONED_EXAMPLES[idx]) {
            document.getElementById('system-prompt-editor').value = POISONED_EXAMPLES[idx].value;
        }
    };
    window.resetCleanPrompt = function() {
        document.getElementById('system-prompt-editor').value = CLEAN_PROMPT;
    };
    {% endif %}

    {% if variant == 'prompt-url' %}
    function updateUrlPreview() {
        const q = userInput.value.trim();
        const display = document.getElementById('url-query-display');
        if (display) display.textContent = encodeURIComponent(q).substring(0, 80);
    }
    userInput.addEventListener('input', updateUrlPreview);
    {% endif %}

    // â”€â”€ å‘é€æ¶ˆæ¯ â”€â”€
    function sendMessage() {
        const msg = userInput.value.trim();
        if (!msg) return;

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©
        appendMsg('user', msg);
        userInput.value = '';

        // æ„å»ºè¯·æ±‚ä½“
        const reqBody = {
            variant: VARIANT,
            message: msg,
            history: history.slice(-10),
        };

        {% if variant == 'system-prompt-poison' %}
        reqBody.custom_system_prompt = document.getElementById('system-prompt-editor').value;
        {% endif %}

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        sendBtn.disabled = true;
        spinner.classList.remove('d-none');
        appendMsg('ai', 'â³ æ€è€ƒä¸­...');

        fetch('{% url "playground:advanced_lab_chat_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrf(),
            },
            body: JSON.stringify(reqBody),
        })
        .then(r => r.json())
        .then(data => {
            // ç§»é™¤åŠ è½½æ¶ˆæ¯
            removeLastAiMsg();

            if (!data.success) {
                appendMsg('ai', 'âŒ ' + (data.error || 'è¯·æ±‚å¤±è´¥'));
                return;
            }

            // æ·»åŠ  AI å›å¤
            let replyHtml = data.reply;

            // æ¨ç†æ³„éœ²ï¼šé«˜äº®æ³„éœ²å†…å®¹
            {% if variant == 'reasoning-leak' %}
            const secrets = CONFIG.detect_secrets || [];
            secrets.forEach(function(s) {
                if (data.reply.toLowerCase().includes(s.toLowerCase())) {
                    const re = new RegExp(s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                    replyHtml = replyHtml.replace(re, '<span class="leak-highlight">$&</span>');
                    leakedSet.add(s);
                }
            });
            updateLeakTracker();
            {% endif %}

            appendMsg('ai', replyHtml, true);

            // æ›´æ–°å†å²
            history.push({ role: 'user', content: msg });
            history.push({ role: 'assistant', content: data.reply });

            // æ›´æ–°æ£€æµ‹æŒ‡ç¤ºå™¨
            updateIndicator(data.detection);

            // æ›´æ–°ç»Ÿè®¡
            stats.total++;
            if (data.detection && data.detection.attacked) stats.success++;
            else stats.safe++;
            updateStats();

            // æ›´æ–°å“åº”ä¿¡æ¯
            document.getElementById('last-elapsed').textContent = (data.elapsed_ms || 0) + 'ms';
            document.getElementById('last-length').textContent = (data.reply || '').length + ' å­—ç¬¦';

            // CoT DoS Token è¿½è¸ª
            {% if variant == 'cot-dos' %}
            const tokens = data.est_tokens || 0;
            tokenTotal += tokens;
            if (tokens > tokenMax) tokenMax = tokens;
            document.getElementById('token-current').textContent = tokens;
            document.getElementById('token-max').textContent = tokenMax;
            document.getElementById('token-total').textContent = tokenTotal;
            const pct = Math.min(tokens / 1500 * 100, 100);
            const bar = document.getElementById('token-bar');
            bar.style.width = pct + '%';
            bar.className = 'token-bar-fill ' + (tokens < 300 ? 'low' : tokens < 800 ? 'mid' : 'high');
            {% endif %}

            // æ˜¾ç¤ºå®é™… System Prompt
            {% if variant == 'prompt-url' or variant == 'context-confusion' or variant == 'system-prompt-poison' %}
            if (data.system_prompt_used) {
                const el = document.getElementById('actual-prompt');
                if (el) { el.textContent = data.system_prompt_used; el.style.display = 'block'; }
            }
            {% endif %}
        })
        .catch(err => {
            removeLastAiMsg();
            appendMsg('ai', 'âŒ ç½‘ç»œé”™è¯¯ï¼š' + err.message);
        })
        .finally(() => {
            sendBtn.disabled = false;
            spinner.classList.add('d-none');
        });
    }

    // â”€â”€ è¾…åŠ©å‡½æ•° â”€â”€
    function appendMsg(role, content, isHtml) {
        const div = document.createElement('div');
        div.className = 'chat-msg ' + role;
        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble';
        if (isHtml) bubble.innerHTML = content;
        else bubble.textContent = content;
        div.appendChild(bubble);
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function removeLastAiMsg() {
        const msgs = chatBox.querySelectorAll('.chat-msg.ai');
        if (msgs.length) msgs[msgs.length - 1].remove();
    }

    function updateIndicator(det) {
        if (!det) return;
        indicator.className = 'attack-indicator show ' + (det.level || 'safe');
        if (det.attacked) {
            indicatorTitle.innerHTML = (det.level === 'critical' ? 'ğŸš¨' : 'âš ï¸') + ' ' + det.message;
        } else {
            indicatorTitle.innerHTML = 'âœ… ' + det.message;
        }
        indicatorDetails.innerHTML = (det.details || []).map(d => 'â€¢ ' + d).join('<br>');
    }

    function updateStats() {
        document.getElementById('stat-total').textContent = stats.total;
        document.getElementById('stat-success').textContent = stats.success;
        document.getElementById('stat-safe').textContent = stats.safe;
    }

    {% if variant == 'reasoning-leak' %}
    function updateLeakTracker() {
        const mapping = {
            'SK-INTERNAL-2024-ABCDEF': 'track-apikey',
            'goldfish42': 'track-password',
            's3cret': 'track-dbconn',
            'v3.7.2-rc1': 'track-version',
            'AUD-TOKEN-XYZ789': 'track-audit',
        };
        for (const [secret, elId] of Object.entries(mapping)) {
            if (leakedSet.has(secret)) {
                const el = document.getElementById(elId);
                if (el) { el.className = 'badge bg-danger'; el.textContent = 'âš ï¸ å·²æ³„éœ²'; }
            }
        }
    }
    {% endif %}

    function getCsrf() {
        const m = document.cookie.match(/csrftoken=([^;]+)/);
        return m ? m[1] : '';
    }

    // â”€â”€ äº‹ä»¶ç»‘å®š â”€â”€
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
})();
</script>
{% endblock %}
