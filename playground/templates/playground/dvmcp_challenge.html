{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<style>
/* DVMCP æŒ‘æˆ˜è¯¦æƒ…é¡µæ ·å¼ */
.dvmcp-detail-main {
    margin-left: 0 !important;
    max-width: 100% !important;
}

.dvmcp-detail-main ~ .sidebar,
#sidebarMenu {
    display: none !important;
}

/* é¡µé¢å¤´éƒ¨ */
.challenge-header {
    background: linear-gradient(135deg, var(--surface) 0%, var(--bg-2) 100%);
    border-bottom: 1px solid var(--border-color);
    padding: 0.75rem 0;
    margin-bottom: 1rem;
    position: relative;
    overflow: hidden;
}

html[data-theme="dark"] .challenge-header {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(10, 14, 23, 0.98) 100%);
    border-bottom-color: rgba(99, 102, 241, 0.2);
}

.challenge-header::before { display: none; }};
}

/* é¢åŒ…å±‘å¯¼èˆª */
.breadcrumb-nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.25rem;
}

.breadcrumb-link {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.9rem;
    color: var(--muted);
    text-decoration: none;
    transition: color 0.2s;
}

.breadcrumb-link:hover {
    color: var(--primary-color);
}

html[data-theme="dark"] .breadcrumb-link:hover {
    color: var(--neon-cyan);
}

.breadcrumb-sep {
    color: var(--border-color);
}

/* æ ‡é¢˜åŒº */
.challenge-title-row {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.challenge-number {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: var(--primary-glow);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    font-weight: 800;
    color: var(--primary-color);
    flex-shrink: 0;
}

html[data-theme="dark"] .challenge-number {
    background: rgba(0, 245, 255, 0.1);
    color: var(--neon-cyan);
}

.challenge-title-text h1 {
    font-size: 1.15rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    color: var(--text);
}

.challenge-title-en {
    font-size: 1rem;
    color: var(--muted);
    margin-bottom: 0.75rem;
}

.challenge-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.challenge-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.35rem 0.85rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.challenge-badge.difficulty {
    color: white;
    background: {{ difficulty_color }};
}

.challenge-badge.vulnerability {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

html[data-theme="dark"] .challenge-badge.vulnerability {
    background: rgba(239, 68, 68, 0.15);
}

.challenge-badge.status-running {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
}

.challenge-badge.status-stopped {
    background: rgba(148, 163, 184, 0.1);
    color: #94a3b8;
}

html[data-theme="dark"] .challenge-badge.status-running {
    background: rgba(34, 197, 94, 0.15);
}

/* ä¸»ä½“å†…å®¹ - ä¸‰æ å¸ƒå±€ */
.challenge-content {
    display: grid;
    grid-template-columns: 1fr 420px;
    gap: 1rem;
}

@media (max-width: 1200px) {
    .challenge-content {
        grid-template-columns: 1fr 360px;
    }
}

@media (max-width: 1024px) {
    .challenge-content {
        grid-template-columns: 1fr;
    }
}

/* å·¦ä¾§ä¸»è¦å†…å®¹ */
.challenge-main {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

/* å¡ç‰‡æ ·å¼ */
.content-card {
    background: var(--surface);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    overflow: hidden;
}

html[data-theme="dark"] .content-card {
    background: var(--surface);
    border-color: rgba(99, 102, 241, 0.15);
}

.card-header-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    background: var(--bg-2);
    border-bottom: 1px solid var(--border-color);
}

html[data-theme="dark"] .card-header-bar {
    background: rgba(15, 23, 42, 0.5);
    border-bottom-color: rgba(99, 102, 241, 0.1);
}

.card-header-bar h3 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
    margin: 0;
}

.card-header-bar h3 svg {
    width: 18px;
    height: 18px;
    color: var(--primary-color);
}

html[data-theme="dark"] .card-header-bar h3 svg {
    color: var(--neon-cyan);
}

.card-body {
    padding: 1.25rem;
}

/* ç›®æ ‡åŒºåŸŸ */
.objective-text {
    font-size: 1.05rem;
    line-height: 1.6;
    color: var(--text);
    background: var(--primary-glow);
    padding: 1rem 1.25rem;
    border-radius: 8px;
    border-left: 4px solid var(--primary-color);
}

html[data-theme="dark"] .objective-text {
    background: rgba(0, 245, 255, 0.05);
    border-left-color: var(--neon-cyan);
}

/* æè¿°åŒºåŸŸ */
.description-text {
    font-size: 0.95rem;
    line-height: 1.7;
    color: var(--text-secondary);
    white-space: pre-line;
}

/* å·¥å…·åˆ—è¡¨ */
.tools-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.tool-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.4rem 0.75rem;
    background: var(--bg-2);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem;
    color: var(--text);
}

html[data-theme="dark"] .tool-tag {
    background: rgba(15, 23, 42, 0.6);
    border-color: rgba(99, 102, 241, 0.2);
}

.tool-tag svg {
    width: 14px;
    height: 14px;
    color: var(--muted);
}

/* èµ„æºåˆ—è¡¨ */
.resources-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.resource-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--bg-2);
    border-radius: 6px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    color: var(--text);
}

html[data-theme="dark"] .resource-item {
    background: rgba(15, 23, 42, 0.6);
}

.resource-item svg {
    width: 14px;
    height: 14px;
    color: var(--muted);
}

/* æç¤ºæŠ˜å  */
.hints-accordion {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
}

.hint-item {
    border-bottom: 1px solid var(--border-color);
}

.hint-item:last-child {
    border-bottom: none;
}

.hint-toggle {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.85rem 1rem;
    background: var(--bg-2);
    border: none;
    cursor: pointer;
    transition: background 0.2s;
}

.hint-toggle:hover {
    background: var(--bg-1);
}

html[data-theme="dark"] .hint-toggle {
    background: rgba(15, 23, 42, 0.4);
}

html[data-theme="dark"] .hint-toggle:hover {
    background: rgba(15, 23, 42, 0.6);
}

.hint-toggle span {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text);
}

.hint-toggle svg {
    width: 16px;
    height: 16px;
    color: var(--muted);
    transition: transform 0.2s;
}

.hint-toggle[aria-expanded="true"] svg {
    transform: rotate(180deg);
}

.hint-content {
    padding: 1rem;
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--text-secondary);
    background: var(--surface);
}

/* è§£å†³æ–¹æ¡ˆ */
.solution-text {
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--text-secondary);
    padding: 1rem;
    background: rgba(34, 197, 94, 0.05);
    border-radius: 8px;
    border-left: 4px solid #22c55e;
}

/* ç¼“è§£æªæ–½ */
.mitigation-text {
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--text-secondary);
    padding: 1rem;
    background: rgba(59, 130, 246, 0.05);
    border-radius: 8px;
    border-left: 4px solid #3b82f6;
}

/* å³ä¾§è¾¹æ  */
.challenge-sidebar {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

/* è¿æ¥ä¿¡æ¯ */
.connection-box {
    background: var(--surface);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 0.85rem;
}

html[data-theme="dark"] .connection-box {
    background: var(--surface);
    border-color: rgba(99, 102, 241, 0.15);
}

.connection-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text);
}

.connection-title svg {
    width: 18px;
    height: 18px;
    color: var(--primary-color);
}

html[data-theme="dark"] .connection-title svg {
    color: var(--neon-cyan);
}

.connection-item {
    margin-bottom: 1rem;
}

.connection-item:last-child {
    margin-bottom: 0;
}

.connection-label {
    font-size: 0.8rem;
    color: var(--muted);
    margin-bottom: 0.35rem;
}

.connection-value {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 0.85rem;
    background: var(--bg-2);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    color: var(--text);
}

html[data-theme="dark"] .connection-value {
    background: rgba(15, 23, 42, 0.6);
    border-color: rgba(99, 102, 241, 0.2);
}

.connection-value code {
    flex: 1;
    overflow-x: auto;
    white-space: nowrap;
}

.copy-btn-sm {
    flex-shrink: 0;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

/* æ“ä½œæŒ‰é’® */
.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.85rem 1rem;
    border-radius: 10px;
    font-size: 0.9rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
}

.action-btn.primary {
    background: var(--primary-color);
    color: white;
}

.action-btn.primary:hover {
    filter: brightness(1.1);
    box-shadow: none;
}

html[data-theme="dark"] .action-btn.primary {
    background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
}

html[data-theme="dark"] .action-btn.primary:hover {
    box-shadow: none;
}

.action-btn.secondary {
    background: var(--surface);
    border: 1px solid var(--border-color);
    color: var(--text);
}

.action-btn.secondary:hover {
    background: var(--bg-2);
    border-color: var(--primary-color);
}

html[data-theme="dark"] .action-btn.secondary:hover {
    border-color: var(--neon-cyan);
}

.action-btn.success {
    background: #22c55e;
    color: white;
}

.action-btn.completed {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
    border: 1px solid #22c55e;
}

/* å¯¼èˆªæŒ‰é’® */
.nav-buttons {
    display: flex;
    gap: 0.75rem;
}

.nav-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.35rem;
    padding: 0.75rem;
    background: var(--surface);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.85rem;
    color: var(--text);
    text-decoration: none;
    transition: all 0.2s;
}

.nav-btn:hover {
    background: var(--bg-2);
    border-color: var(--primary-color);
}

html[data-theme="dark"] .nav-btn:hover {
    border-color: var(--neon-cyan);
}

.nav-btn.disabled {
    opacity: 0.5;
    pointer-events: none;
}

/* ===== å³ä¾§è¾¹æ å¡ç‰‡æ ·å¼ ===== */
.sidebar-card {
    background: var(--surface);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    margin-bottom: 1rem;
    overflow: hidden;
}

html[data-theme="dark"] .sidebar-card {
    background: var(--surface);
    border-color: rgba(99, 102, 241, 0.15);
}

.sidebar-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.85rem 1rem;
    background: var(--bg-2);
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background 0.2s;
}

html[data-theme="dark"] .sidebar-card-header {
    background: rgba(15, 23, 42, 0.5);
    border-bottom-color: rgba(99, 102, 241, 0.1);
}

.sidebar-card-header:hover {
    background: var(--surface);
}

.sidebar-card-header h4 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
    font-weight: 600;
    margin: 0;
    color: var(--text);
}

.sidebar-card-header h4 svg {
    color: var(--primary-color);
}

html[data-theme="dark"] .sidebar-card-header h4 svg {
    color: var(--neon-cyan);
}

.sidebar-card-header .collapse-icon {
    transition: transform 0.3s;
    color: var(--muted);
}

.sidebar-card-header.collapsed .collapse-icon {
    transform: rotate(-90deg);
}

.sidebar-card-body {
    padding: 1rem;
}

/* æç¤ºå¡ç‰‡ */
.hints-card .hint-count {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 24px;
    height: 24px;
    background: #f59e0b;
    color: white;
    font-size: 0.75rem;
    font-weight: 700;
    border-radius: 12px;
    padding: 0 8px;
}

.hints-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.hint-item-sidebar .hint-reveal-btn {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    padding: 0.65rem 0.85rem;
    background: var(--bg-2);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s;
}

html[data-theme="dark"] .hint-item-sidebar .hint-reveal-btn {
    background: rgba(15, 23, 42, 0.5);
    border-color: rgba(99, 102, 241, 0.1);
}

.hint-item-sidebar .hint-reveal-btn:hover {
    border-color: #f59e0b;
    background: rgba(245, 158, 11, 0.05);
}

.hint-item-sidebar .hint-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    background: #f59e0b;
    color: white;
    font-size: 0.75rem;
    font-weight: 700;
    border-radius: 6px;
    flex-shrink: 0;
}

.hint-item-sidebar .hint-mask {
    font-size: 0.85rem;
    color: var(--muted);
}

.hint-item-sidebar .hint-text {
    font-size: 0.85rem;
    color: var(--text);
    line-height: 1.5;
}

.hint-item-sidebar.revealed .hint-reveal-btn {
    background: rgba(245, 158, 11, 0.1);
    border-color: rgba(245, 158, 11, 0.3);
    cursor: default;
}

/* è§£å†³æ–¹æ¡ˆå¡ç‰‡ */
.solution-hidden {
    text-align: center;
    padding: 1rem 0;
}

.solution-hidden svg {
    color: #f59e0b;
    margin-bottom: 0.5rem;
}

.solution-hidden p {
    font-size: 0.85rem;
    color: var(--muted);
    margin-bottom: 0.75rem;
}

.solution-content {
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--text);
    padding: 0.5rem;
    background: rgba(34, 197, 94, 0.05);
    border-radius: 8px;
    border: 1px solid rgba(34, 197, 94, 0.2);
}

/* ç¼“è§£å¡ç‰‡ */
.mitigation-text-sidebar {
    font-size: 0.85rem;
    line-height: 1.6;
    color: var(--text);
}

/* è¯¦ç»†è§£å†³æ–¹æ¡ˆæ¨¡æ€æ¡† */
.solution-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1200;
    display: none;
}

.solution-modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.solution-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
}

.solution-modal-content {
    position: relative;
    width: 90%;
    max-width: 800px;
    max-height: 85vh;
    background: var(--surface);
    border-radius: 6px;
    overflow: hidden;
    box-shadow: none;
}

html[data-theme="dark"] .solution-modal-content {
    background: var(--bg-2);
    border: 1px solid rgba(99, 102, 241, 0.2);
}

.solution-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.25rem 1.5rem;
    background: var(--bg-2);
    border-bottom: 1px solid var(--border-color);
}

html[data-theme="dark"] .solution-modal-header {
    background: rgba(15, 23, 42, 0.8);
    border-bottom-color: rgba(99, 102, 241, 0.15);
}

.solution-modal-header h3 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.25rem;
    font-weight: 700;
    margin: 0;
    color: var(--text);
}

.solution-modal-header h3 svg {
    color: #22c55e;
}

.solution-modal-close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    background: transparent;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    color: var(--muted);
    transition: all 0.2s;
}

.solution-modal-close:hover {
    background: var(--border-color);
    color: var(--text);
}

.solution-modal-body {
    padding: 1.5rem;
    max-height: calc(85vh - 70px);
    overflow-y: auto;
}

.solution-modal-body .solution-section {
    margin-bottom: 1rem;
}

.solution-modal-body .solution-section:last-child {
    margin-bottom: 0;
}

.solution-modal-body h4 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text);
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border-color);
}

.solution-modal-body h4 svg {
    color: var(--primary-color);
}

html[data-theme="dark"] .solution-modal-body h4 svg {
    color: var(--neon-cyan);
}

.solution-modal-body .step-list {
    padding-left: 0;
    list-style: none;
}

.solution-modal-body .step-item {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.25rem;
    padding: 1rem;
    background: var(--bg-2);
    border-radius: 10px;
    border-left: 3px solid var(--primary-color);
}

html[data-theme="dark"] .solution-modal-body .step-item {
    background: rgba(15, 23, 42, 0.5);
    border-left-color: var(--neon-cyan);
}

.solution-modal-body .step-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: var(--primary-color);
    color: white;
    font-size: 0.85rem;
    font-weight: 700;
    border-radius: 8px;
    flex-shrink: 0;
}

html[data-theme="dark"] .solution-modal-body .step-number {
    background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
}

.solution-modal-body .step-content {
    flex: 1;
}

.solution-modal-body .step-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text);
}

.solution-modal-body .step-desc {
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--muted);
}

.solution-modal-body code {
    display: block;
    margin-top: 0.75rem;
    padding: 0.75rem 1rem;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 8px;
    font-size: 0.85rem;
    white-space: pre-wrap;
    word-break: break-all;
}

html[data-theme="dark"] .solution-modal-body code {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(99, 102, 241, 0.1);
}

.solution-modal-body .warning-box {
    display: flex;
    gap: 0.75rem;
    padding: 1rem;
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 10px;
    margin-top: 1rem;
}

.solution-modal-body .warning-box svg {
    color: #ef4444;
    flex-shrink: 0;
    margin-top: 2px;
}

.solution-modal-body .warning-box p {
    font-size: 0.9rem;
    margin: 0;
    color: var(--text);
}

/* å®Œæˆ Toast */
.completion-toast {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    background: var(--surface);
    border: 1px solid #22c55e;
    border-radius: 16px;
    padding: 2rem;
    text-align: center;
    z-index: 1100;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
    box-shadow: none;
}

.completion-toast.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
    pointer-events: auto;
}

.completion-toast .success-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto 1rem;
    background: rgba(34, 197, 94, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.completion-toast .success-icon svg {
    width: 20px;
    height: 20px;
    color: #22c55e;
}

.completion-toast h4 {
    font-size: 1.25rem;
    margin-bottom: 0.5rem;
    color: var(--text);
}

.completion-toast p {
    color: var(--muted);
    margin-bottom: 1rem;
}

.completion-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1099;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
}

.completion-overlay.show {
    opacity: 1;
    pointer-events: auto;
}

/* ===== èŠå¤©äº¤äº’ç•Œé¢ ===== */
.chat-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 2px solid var(--border-color);
}

/* ä½¿ç”¨è¯´æ˜ */
.usage-note {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 1rem;
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 10px;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: var(--text);
}

.usage-note svg {
    flex-shrink: 0;
    margin-top: 2px;
    color: #3b82f6;
}

html[data-theme="dark"] .usage-note {
    background: rgba(59, 130, 246, 0.1);
    border-color: rgba(59, 130, 246, 0.2);
}

.chat-section-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: var(--text);
}

.chat-section-title svg {
    color: var(--primary-color);
}

html[data-theme="dark"] .chat-section-title svg {
    color: var(--neon-cyan);
}

/* LLM é…ç½® */
.llm-config {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
    padding: 1rem;
    background: var(--bg-2);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    margin-bottom: 1rem;
}

html[data-theme="dark"] .llm-config {
    background: rgba(15, 23, 42, 0.5);
    border-color: rgba(99, 102, 241, 0.15);
}

.llm-config-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.llm-config-item label {
    font-size: 0.85rem;
    color: var(--muted);
    white-space: nowrap;
}

.llm-config-item input,
.llm-config-item select {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--surface);
    color: var(--text);
    font-size: 0.85rem;
}

.llm-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-size: 0.85rem;
}

.llm-status.checking {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
}

.llm-status.connected {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
}

.llm-status.disconnected {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

/* èŠå¤©å®¹å™¨ */
.chat-container {
    display: flex;
    flex-direction: column;
    height: 500px;
    background: var(--surface);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    overflow: hidden;
}

html[data-theme="dark"] .chat-container {
    background: var(--surface);
    border-color: rgba(99, 102, 241, 0.15);
}

/* èŠå¤©æ¶ˆæ¯åŒº */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.chat-message {
    display: flex;
    gap: 0.75rem;
    max-width: 85%;
}

.chat-message.user {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.chat-message.assistant {
    align-self: flex-start;
}

.chat-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 0.9rem;
}

.chat-message.user .chat-avatar {
    background: var(--primary-glow);
    color: var(--primary-color);
}

.chat-message.assistant .chat-avatar {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
}

.chat-bubble {
    padding: 0.85rem 1rem;
    border-radius: 12px;
    font-size: 0.9rem;
    line-height: 1.6;
}

.chat-message.user .chat-bubble {
    background: var(--primary-color);
    color: white;
    border-bottom-right-radius: 4px;
}

html[data-theme="dark"] .chat-message.user .chat-bubble {
    background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
}

.chat-message.assistant .chat-bubble {
    background: var(--bg-2);
    color: var(--text);
    border-bottom-left-radius: 4px;
}

html[data-theme="dark"] .chat-message.assistant .chat-bubble {
    background: rgba(15, 23, 42, 0.6);
}

.chat-bubble pre {
    background: rgba(0, 0, 0, 0.1);
    padding: 0.75rem;
    border-radius: 6px;
    overflow-x: auto;
    font-size: 0.8rem;
    margin: 0.5rem 0;
}

html[data-theme="dark"] .chat-bubble pre {
    background: rgba(0, 0, 0, 0.3);
}

/* å·¥å…·è°ƒç”¨æ˜¾ç¤º */
.tool-call-display {
    margin: 0.5rem 0;
    padding: 0.75rem;
    background: rgba(99, 102, 241, 0.1);
    border-left: 3px solid var(--primary-color);
    border-radius: 0 6px 6px 0;
    font-size: 0.85rem;
}

html[data-theme="dark"] .tool-call-display {
    background: rgba(0, 245, 255, 0.05);
    border-left-color: var(--neon-cyan);
}

.tool-call-display .tool-name {
    font-weight: 600;
    color: var(--primary-color);
}

html[data-theme="dark"] .tool-call-display .tool-name {
    color: var(--neon-cyan);
}

/* è¾“å…¥åŒº */
.chat-input-area {
    display: flex;
    gap: 0.75rem;
    padding: 1rem;
    background: var(--bg-2);
    border-top: 1px solid var(--border-color);
}

html[data-theme="dark"] .chat-input-area {
    background: rgba(15, 23, 42, 0.5);
    border-top-color: rgba(99, 102, 241, 0.1);
}

.chat-input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--surface);
    color: var(--text);
    font-size: 0.9rem;
    resize: none;
    min-height: 44px;
    max-height: 120px;
}

.chat-input:focus {
    outline: none;
    border-color: var(--primary-color);
}

html[data-theme="dark"] .chat-input:focus {
    border-color: var(--neon-cyan);
}

.chat-send-btn {
    padding: 0.75rem 1.25rem;
    background: var(--primary-color);
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.chat-send-btn:hover:not(:disabled) {
    filter: brightness(1.1);
}

.chat-send-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

html[data-theme="dark"] .chat-send-btn {
    background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
}

/* å·¥å…·é¢æ¿ */
.tools-panel {
    margin-top: 1rem;
    padding: 1rem;
    background: var(--surface);
    border: 1px solid var(--border-color);
    border-radius: 12px;
}

html[data-theme="dark"] .tools-panel {
    background: var(--surface);
    border-color: rgba(99, 102, 241, 0.15);
}

.tools-panel-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.tools-panel-title h4 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text);
    margin: 0;
}

.tools-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.75rem;
}

.tool-item {
    padding: 0.75rem;
    background: var(--bg-2);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.tool-item:hover {
    border-color: var(--primary-color);
    background: var(--primary-glow);
}

html[data-theme="dark"] .tool-item {
    background: rgba(15, 23, 42, 0.4);
}

html[data-theme="dark"] .tool-item:hover {
    border-color: var(--neon-cyan);
    background: rgba(0, 245, 255, 0.05);
}

.tool-item-name {
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text);
    margin-bottom: 0.25rem;
}

.tool-item-desc {
    font-size: 0.75rem;
    color: var(--muted);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* åŠ è½½åŠ¨ç”» */
.typing-indicator {
    display: flex;
    gap: 4px;
    padding: 0.5rem;
}

.typing-indicator span {
    width: 8px;
    height: 8px;
    background: var(--muted);
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-8px); }
}
</style>
{% endblock %}

{% block content %}
<main class="dvmcp-detail-main">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="challenge-header">
        <div class="container">
            <!-- é¢åŒ…å±‘å¯¼èˆª -->
            <nav class="breadcrumb-nav">
                <a href="{% url 'playground:lab_list' %}" class="breadcrumb-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    é¶åœºåˆ—è¡¨
                </a>
                <span class="breadcrumb-sep">/</span>
                <a href="{% url 'playground:dvmcp_index' %}" class="breadcrumb-link">DVMCP é¶åœº</a>
                <span class="breadcrumb-sep">/</span>
                <span class="breadcrumb-link" style="color: var(--text);">æŒ‘æˆ˜ {{ challenge.id }}</span>
            </nav>

            <!-- æ ‡é¢˜åŒº -->
            <div class="challenge-title-row">
                <div class="challenge-number">{{ challenge.id }}</div>
                <div class="challenge-title-text">
                    <h1>{{ challenge.title }}</h1>
                    <div class="challenge-title-en">{{ challenge.title_en }}</div>
                    <div class="challenge-meta">
                        <span class="challenge-badge difficulty">{{ difficulty_label }}</span>
                        <span class="challenge-badge vulnerability">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            {{ challenge.vulnerability }}
                        </span>
                        {% if is_running %}
                        <span class="challenge-badge status-running">
                            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                            è¿è¡Œä¸­
                        </span>
                        {% else %}
                        <span class="challenge-badge status-stopped">
                            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                            æœªè¿è¡Œ
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="challenge-content">
            <!-- å·¦ä¾§ä¸»è¦å†…å®¹ -->
            <div class="challenge-main">
                <!-- ç›®æ ‡ -->
                <div class="content-card">
                    <div class="card-header-bar">
                        <h3>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <circle cx="12" cy="12" r="6"></circle>
                                <circle cx="12" cy="12" r="2"></circle>
                            </svg>
                            æŒ‘æˆ˜ç›®æ ‡
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="objective-text">{{ challenge.objective }}</div>
                    </div>
                </div>

                <!-- æè¿° -->
                <div class="content-card">
                    <div class="card-header-bar">
                        <h3>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            æ¼æ´æè¿°
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="description-text">{{ challenge.description }}</div>
                    </div>
                </div>



                <!-- ===== MCP ç›´æ¥æ“ä½œåŒº ===== -->
                <div class="content-card" style="margin-top: 1rem;">
                    <div class="card-header-bar">
                        <h3>
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
                            MCP æ“ä½œå°
                        </h3>
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshTools()">åˆ·æ–°å·¥å…·</button>
                    </div>
                    <div class="card-body">
                        <!-- å¿«é€Ÿæ”»å‡»æŒ‰é’® -->
                        <div style="margin-bottom: 0.75rem;">
                            <label class="small fw-semibold text-muted">å¿«é€Ÿæµ‹è¯•ï¼š</label>
                            <div class="d-flex flex-wrap gap-1 mt-1" id="quick-payloads"></div>
                        </div>

                        <!-- å·¥å…·è°ƒç”¨ -->
                        <div style="border: 1px solid var(--border-color); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem;">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <label class="small fw-semibold" style="white-space:nowrap;">è°ƒç”¨å·¥å…·</label>
                                <select class="form-select form-select-sm" id="mcp-tool-select" onchange="onToolSelect()" style="max-width:200px;">
                                    <option value="">åŠ è½½ä¸­...</option>
                                </select>
                                <button class="btn btn-danger btn-sm" onclick="executeTool()" style="white-space:nowrap;">æ‰§è¡Œ</button>
                            </div>
                            <div id="mcp-tool-desc" class="small text-muted mb-2" style="display:none; background:var(--surface-2); padding:6px 8px; border-radius:4px; font-size:11px; white-space:pre-wrap; max-height:120px; overflow-y:auto; font-family:monospace;"></div>
                            <div id="mcp-tool-params" class="d-flex flex-wrap gap-2 mb-2" style="display:none;"></div>
                        </div>

                        <!-- èµ„æºè¯»å– -->
                        <div style="border: 1px solid var(--border-color); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem;">
                            <div class="d-flex align-items-center gap-2">
                                <label class="small fw-semibold" style="white-space:nowrap;">è¯»å–èµ„æº</label>
                                <input type="text" class="form-control form-control-sm" id="mcp-resource-uri" placeholder="è¾“å…¥èµ„æº URIï¼Œå¦‚ internal://credentials" style="font-family:monospace; font-size:12px;">
                                <button class="btn btn-danger btn-sm" onclick="executeResource()" style="white-space:nowrap;">è¯»å–</button>
                            </div>
                        </div>

                        <!-- ç»“æœå±•ç¤º -->
                        <div id="mcp-result-area" style="display:none;">
                            <label class="small fw-semibold text-muted">MCP Server è¿”å›ï¼š</label>
                            <pre id="mcp-result" class="code-box" style="margin-top:4px; max-height:300px; overflow-y:auto; font-size:12px; white-space:pre-wrap; word-break:break-all;">-</pre>
                        </div>
                    </div>
                </div>

                <!-- ===== LLM è¾…åŠ©èŠå¤©åŒºï¼ˆå¯æŠ˜å ï¼‰ ===== -->
                <details class="content-card" style="margin-top: 1rem;">
                    <summary class="card-header-bar" style="cursor:pointer; list-style:none; user-select:none;">
                        <h3>
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                            AI åˆ†æåŠ©æ‰‹ï¼ˆå¯é€‰ï¼‰
                        </h3>
                        <span class="small text-muted">ç‚¹å‡»å±•å¼€</span>
                    </summary>
                    <div class="card-body" style="padding:0;">
                        <div class="chat-container" style="height:400px; border:none; border-radius:0;">
                            <div class="chat-messages" id="chat-messages">
                                <div class="chat-message assistant">
                                    <div class="chat-avatar">ğŸ¤–</div>
                                    <div class="chat-bubble">
                                        æŒ‘æˆ˜ {{ challenge.id }} - {{ challenge.title }}<br>
                                        ç›®æ ‡ï¼š{{ challenge.objective }}<br><br>
                                        <small>å¯ä»¥é—®æˆ‘æ”»å‡»æ€è·¯ï¼Œæˆ–è®©æˆ‘å¸®ä½ åˆ†æ MCP è¿”å›çš„ç»“æœã€‚</small>
                                    </div>
                                </div>
                            </div>
                            <div class="chat-input-area">
                                <textarea class="chat-input" id="chat-input" placeholder="é—® AI åˆ†ææ€è·¯... (Enter å‘é€)" rows="1"></textarea>
                                <button class="chat-send-btn" id="chat-send-btn" onclick="sendMessage()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                                    å‘é€
                                </button>
                            </div>
                        </div>
                    </div>
                </details>
            </div>

            <!-- å³ä¾§è¾¹æ  - è§£é¢˜å¸®åŠ© -->
            <div class="challenge-sidebar">
                <!-- è¿æ¥ä¿¡æ¯ -->
                <div class="connection-box">
                    <div class="connection-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                        è¿æ¥ä¿¡æ¯
                    </div>
                    <div class="connection-item">
                        <div class="connection-label">SSE ç«¯ç‚¹</div>
                        <div class="connection-value">
                            <code id="sse-url">http://localhost:{{ challenge.port }}/sse</code>
                            <button class="btn btn-outline-primary copy-btn-sm" onclick="copySSE()">å¤åˆ¶</button>
                        </div>
                    </div>
                    <div class="connection-item">
                        <div class="connection-label">ç«¯å£</div>
                        <div class="connection-value">
                            <code>{{ challenge.port }}</code>
                        </div>
                    </div>
                </div>

                <!-- è§£é¢˜æç¤º -->
                <div class="sidebar-card hints-card">
                    <div class="sidebar-card-header">
                        <h4>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            è§£é¢˜æç¤º
                        </h4>
                        <span class="hint-count">{{ challenge.hints|length }}</span>
                    </div>
                    <div class="sidebar-card-body">
                        <div class="hints-list">
                            {% for hint in challenge.hints %}
                            <div class="hint-item-sidebar">
                                <button class="hint-reveal-btn" onclick="revealHint(this)">
                                    <span class="hint-number">{{ forloop.counter }}</span>
                                    <span class="hint-mask">ç‚¹å‡»æ˜¾ç¤ºæç¤º {{ forloop.counter }}</span>
                                    <span class="hint-text" style="display: none;">{{ hint }}</span>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- è§£å†³æ–¹æ¡ˆæ‘˜è¦ -->
                <div class="sidebar-card solution-card">
                    <div class="sidebar-card-header">
                        <h4>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            è§£å†³æ–¹æ¡ˆ
                        </h4>
                    </div>
                    <div class="sidebar-card-body">
                        <div class="solution-brief" id="solution-brief">
                            <div class="solution-hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                <p>è§£å†³æ–¹æ¡ˆå·²éšè—</p>
                                <button class="btn btn-sm btn-outline-warning" onclick="showSolutionBrief()">æ˜¾ç¤ºç®€è¦æ–¹æ¡ˆ</button>
                            </div>
                            <div class="solution-content" style="display: none;">
                                {{ challenge.solution_summary }}
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-success w-100 mt-2" onclick="showDetailedSolution()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                            æŸ¥çœ‹è¯¦ç»†è§£å†³æ–¹æ¡ˆ
                        </button>
                    </div>
                </div>

                <!-- å®‰å…¨ç¼“è§£ -->
                <div class="sidebar-card mitigation-card">
                    <div class="sidebar-card-header collapsed" data-bs-toggle="collapse" data-bs-target="#mitigationBody">
                        <h4>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                            </svg>
                            å®‰å…¨ç¼“è§£
                        </h4>
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="collapse-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </div>
                    <div class="collapse" id="mitigationBody">
                        <div class="sidebar-card-body">
                            <div class="mitigation-text-sidebar">{{ challenge.mitigation }}</div>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="action-buttons">
                    {% if is_completed %}
                    <button class="action-btn completed" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        å·²å®Œæˆ
                    </button>
                    {% else %}
                    <button class="action-btn success" onclick="markComplete()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        æ ‡è®°å®Œæˆ
                    </button>
                    {% endif %}
                    <a href="{% url 'playground:dvmcp_index' %}" class="action-btn secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        è¿”å›åˆ—è¡¨
                    </a>
                </div>

                <!-- å¯¼èˆªæŒ‰é’® -->
                <div class="nav-buttons">
                    {% if prev_challenge %}
                    <a href="{% url 'playground:dvmcp_challenge' prev_challenge.id %}" class="nav-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        ä¸Šä¸€ä¸ª
                    </a>
                    {% else %}
                    <span class="nav-btn disabled">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        ä¸Šä¸€ä¸ª
                    </span>
                    {% endif %}
                    {% if next_challenge %}
                    <a href="{% url 'playground:dvmcp_challenge' next_challenge.id %}" class="nav-btn">
                        ä¸‹ä¸€ä¸ª
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </a>
                    {% else %}
                    <span class="nav-btn disabled">
                        ä¸‹ä¸€ä¸ª
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</main>

<!-- å®Œæˆæç¤º -->
<div class="completion-toast" id="completionToast">
    <div class="success-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
    </div>
    <h4>æŒ‘æˆ˜å®Œæˆï¼</h4>
    <p>æ­å–œä½ å®Œæˆäº†ã€Œ{{ challenge.title }}ã€æŒ‘æˆ˜</p>
    <button class="btn btn-success" onclick="hideToast()">ç»§ç»­</button>
</div>
<div class="completion-overlay" id="completionOverlay" onclick="hideToast()"></div>

<!-- è¯¦ç»†è§£å†³æ–¹æ¡ˆæ¨¡æ€æ¡† -->
<div class="solution-modal" id="solutionModal">
    <div class="solution-modal-overlay" onclick="closeSolutionModal()"></div>
    <div class="solution-modal-content">
        <div class="solution-modal-header">
            <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                æŒ‘æˆ˜ {{ challenge.id }} - {{ challenge.title }} è¯¦ç»†è§£å†³æ–¹æ¡ˆ
            </h3>
            <button class="solution-modal-close" onclick="closeSolutionModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="solution-modal-body">
            <!-- æ¼æ´æ¦‚è¿° -->
            <div class="solution-section">
                <h4>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    æ¼æ´æ¦‚è¿°
                </h4>
                <p>{{ challenge.description }}</p>
            </div>

            <!-- æ”»å‡»æ­¥éª¤ -->
            <div class="solution-section">
                <h4>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    æ”»å‡»æ­¥éª¤
                </h4>
                <ul class="step-list">
                    {% for hint in challenge.hints %}
                    <li class="step-item">
                        <span class="step-number">{{ forloop.counter }}</span>
                        <div class="step-content">
                            <div class="step-desc">{{ hint }}</div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- è§£å†³æ–¹æ¡ˆæ‘˜è¦ -->
            <div class="solution-section">
                <h4>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    æ ¸å¿ƒæ€è·¯
                </h4>
                <div class="step-item">
                    <span class="step-number">â˜…</span>
                    <div class="step-content">
                        <div class="step-desc">{{ challenge.solution_summary }}</div>
                    </div>
                </div>
            </div>

            <!-- å®‰å…¨ç¼“è§£ -->
            <div class="solution-section">
                <h4>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    å®‰å…¨ç¼“è§£æªæ–½
                </h4>
                <p>{{ challenge.mitigation }}</p>
            </div>

            <!-- è­¦å‘Š -->
            <div class="warning-box">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                <p><strong>é‡è¦æç¤ºï¼š</strong>æœ¬é¶åœºä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚è¯·å‹¿å°†è¿™äº›æŠ€æœ¯ç”¨äºæœªç»æˆæƒçš„ç³»ç»Ÿã€‚ç†è§£æ¼æ´åŸç†æœ‰åŠ©äºæ›´å¥½åœ°é˜²æŠ¤è‡ªå·±çš„ç³»ç»Ÿã€‚</p>
            </div>
        </div>
    </div>
</div>

<script>
// ===== åŸºç¡€åŠŸèƒ½ =====

// å¤åˆ¶ SSE URL
function copySSE() {
    var url = document.getElementById('sse-url').textContent;
    navigator.clipboard.writeText(url).then(function() {
        alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
    });
}

// æ ‡è®°å®Œæˆ
function markComplete() {
    fetch('{% url "playground:lab_complete_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            lab_slug: '{{ lab_slug }}'
        })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            showToast();
            setTimeout(function() {
                location.reload();
            }, 2000);
        } else {
            alert('æ ‡è®°å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    });
}

// æ˜¾ç¤º/éšè—å®Œæˆæç¤º
function showToast() {
    document.getElementById('completionToast').classList.add('show');
    document.getElementById('completionOverlay').classList.add('show');
}

function hideToast() {
    document.getElementById('completionToast').classList.remove('show');
    document.getElementById('completionOverlay').classList.remove('show');
}

// ===== èŠå¤©åŠŸèƒ½ =====

var chatHistory = [];
var isWaiting = false;

// æ£€æŸ¥ LLM çŠ¶æ€
function checkLLMStatus() {
    var llmUrl = document.getElementById('llm-url').value;
    var statusEl = document.getElementById('llm-status');
    var modelSelect = document.getElementById('llm-model');
    
    statusEl.className = 'llm-status checking';
    statusEl.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg> æ£€æµ‹ä¸­...';
    
    fetch('{% url "playground:dvmcp_llm_status_api" %}?url=' + encodeURIComponent(llmUrl))
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data && data.available && data.models && data.models.length > 0) {
                statusEl.className = 'llm-status connected';
                statusEl.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> å·²è¿æ¥ (' + data.models.length + ' æ¨¡å‹)';
                
                // æ›´æ–°æ¨¡å‹åˆ—è¡¨
                modelSelect.innerHTML = '';
                data.models.forEach(function(model) {
                    var option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
                
                // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨æ¨¡å‹ï¼ˆå¦‚æœæ²¡æœ‰é¦–é€‰æ¨¡å‹ï¼‰
                var preferredModels = ['qwen2.5:7b', 'qwen2.5:14b', 'qwen2.5:32b', 'llama3.1:8b', 'mistral:7b'];
                var found = false;
                for (var i = 0; i < preferredModels.length; i++) {
                    if (data.models.includes(preferredModels[i])) {
                        modelSelect.value = preferredModels[i];
                        found = true;
                        break;
                    }
                }
                // å¦‚æœæ²¡æ‰¾åˆ°é¦–é€‰æ¨¡å‹ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ª
                if (!found && data.models.length > 0) {
                    modelSelect.value = data.models[0];
                }
            } else if (data && data.available) {
                statusEl.className = 'llm-status disconnected';
                statusEl.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg> æ— æ¨¡å‹';
                modelSelect.innerHTML = '<option value="">è¯·å…ˆ ollama pull æ¨¡å‹</option>';
            } else {
                statusEl.className = 'llm-status disconnected';
                statusEl.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg> æœªè¿æ¥';
                modelSelect.innerHTML = '<option value="">Ollama æœªè¿è¡Œ</option>';
            }
        })
        .catch(function(err) {
            statusEl.className = 'llm-status disconnected';
            statusEl.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg> è¿æ¥å¤±è´¥';
            modelSelect.innerHTML = '<option value="">æ£€æµ‹å¤±è´¥</option>';
            console.error('LLM status check failed:', err);
        });
}

// ===== MCP ç›´æ¥æ“ä½œåŒº =====
var mcpToolsData = []; // ç¼“å­˜å·¥å…·åˆ—è¡¨åŠå‚æ•°

// å¿«é€Ÿæ”»å‡»æŒ‰é’®æ•°æ®
var quickPayloads = {{ quick_payloads_json|safe }};

// åˆå§‹åŒ–å¿«é€Ÿæ”»å‡»æŒ‰é’®
function initQuickPayloads() {
    var container = document.getElementById('quick-payloads');
    if (!container || !quickPayloads.length) return;
    container.innerHTML = '';
    quickPayloads.forEach(function(p) {
        var btn = document.createElement('button');
        btn.className = 'btn btn-sm ' + (p.danger ? 'btn-outline-danger' : 'btn-outline-secondary');
        btn.style.fontSize = '11px';
        btn.textContent = p.label;
        btn.onclick = function() { executeQuickPayload(p); };
        container.appendChild(btn);
    });
}

function executeQuickPayload(p) {
    if (p.action === 'tool') {
        // é€‰ä¸­å·¥å…·å¹¶å¡«å…¥å‚æ•°åæ‰§è¡Œ
        var sel = document.getElementById('mcp-tool-select');
        if (sel) sel.value = p.tool;
        onToolSelect();
        // å¡«å…¥å‚æ•°
        setTimeout(function() {
            var params = document.querySelectorAll('#mcp-tool-params input');
            var keys = Object.keys(p.arguments || {});
            params.forEach(function(inp) {
                var k = inp.dataset.param;
                if (k && p.arguments[k] !== undefined) inp.value = p.arguments[k];
            });
            executeTool();
        }, 50);
    } else if (p.action === 'resource') {
        document.getElementById('mcp-resource-uri').value = p.uri;
        executeResource();
    }
}

// åˆ·æ–°å·¥å…·åˆ—è¡¨ -> å¡«å……ä¸‹æ‹‰æ¡†
function refreshTools() {
    var sel = document.getElementById('mcp-tool-select');
    sel.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

    fetch('{% url "playground:dvmcp_tools_api" %}?challenge_id={{ challenge.id }}')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            sel.innerHTML = '<option value="">-- é€‰æ‹©å·¥å…· --</option>';
            if (data.success) {
                mcpToolsData = data.tools || [];
                mcpToolsData.forEach(function(t) {
                    var opt = document.createElement('option');
                    opt.value = t.name;
                    opt.textContent = t.name;
                    sel.appendChild(opt);
                });
                // å¡«å……èµ„æº URI ä¸‹æ‹‰æç¤º
                (data.resources || []).forEach(function(r) {
                    if (r.uri && !document.getElementById('mcp-resource-uri').value) {
                        document.getElementById('mcp-resource-uri').placeholder = 'å¦‚: ' + r.uri;
                    }
                });
            } else {
                sel.innerHTML = '<option value="">è·å–å¤±è´¥</option>';
            }
        })
        .catch(function() {
            sel.innerHTML = '<option value="">è¿æ¥å¤±è´¥</option>';
        });
}

// é€‰ä¸­å·¥å…·ååŠ¨æ€æ˜¾ç¤ºå‚æ•°è¾“å…¥æ¡†å’Œå®Œæ•´æè¿°
function onToolSelect() {
    var sel = document.getElementById('mcp-tool-select');
    var paramsDiv = document.getElementById('mcp-tool-params');
    var descDiv = document.getElementById('mcp-tool-desc');
    var toolName = sel.value;
    paramsDiv.innerHTML = '';
    if (!toolName) { paramsDiv.style.display = 'none'; descDiv.style.display = 'none'; return; }

    var tool = mcpToolsData.find(function(t) { return t.name === toolName; });
    if (!tool) return;

    // æ˜¾ç¤ºå®Œæ•´å·¥å…·æè¿°ï¼ˆåŒ…å«éšè—æŒ‡ä»¤ç­‰ï¼‰
    if (tool.description) {
        descDiv.textContent = tool.description;
        descDiv.style.display = 'block';
    } else {
        descDiv.style.display = 'none';
    }

    // å…¼å®¹ MCP å®æ—¶è¿”å›çš„ inputSchema å’Œé™æ€å®šä¹‰çš„ parameters
    var schema = tool.inputSchema || tool.parameters || {};
    var props = schema.properties || {};
    var keys = Object.keys(props);
    if (keys.length === 0) {
        paramsDiv.style.display = 'none';
        return;
    }
    paramsDiv.style.display = 'flex';
    keys.forEach(function(k) {
        var wrap = document.createElement('div');
        wrap.innerHTML = '<label class="small text-muted" style="font-size:11px;">' + k + '</label>' +
            '<input type="text" class="form-control form-control-sm" data-param="' + k + '" placeholder="' + (props[k].description || k) + '" style="font-size:12px; font-family:monospace; min-width:120px;">';
        paramsDiv.appendChild(wrap);
    });
}

// æ˜¾ç¤º MCP ç»“æœ
function showMcpResult(data) {
    var area = document.getElementById('mcp-result-area');
    var pre = document.getElementById('mcp-result');
    area.style.display = 'block';
    if (data.success) {
        pre.textContent = typeof data.result === 'object' ? JSON.stringify(data.result, null, 2) : String(data.result);
        pre.style.borderLeft = '3px solid #22c55e';
    } else {
        pre.textContent = 'ERROR: ' + (data.error || 'æœªçŸ¥é”™è¯¯');
        pre.style.borderLeft = '3px solid #ef4444';
    }
}

// æ‰§è¡Œå·¥å…·è°ƒç”¨
function executeTool() {
    var toolName = document.getElementById('mcp-tool-select').value;
    if (!toolName) return;

    var args = {};
    document.querySelectorAll('#mcp-tool-params input').forEach(function(inp) {
        var k = inp.dataset.param;
        if (k && inp.value) args[k] = inp.value;
    });

    var pre = document.getElementById('mcp-result');
    var area = document.getElementById('mcp-result-area');
    area.style.display = 'block';
    pre.textContent = 'æ‰§è¡Œä¸­... tools/call ' + toolName + '(' + JSON.stringify(args) + ')';
    pre.style.borderLeft = '3px solid var(--primary-color)';

    fetch('{% url "playground:dvmcp_tool_call_api" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
        body: JSON.stringify({challenge_id: {{ challenge.id }}, tool: toolName, arguments: args})
    })
    .then(function(r) { return r.json(); })
    .then(showMcpResult)
    .catch(function(e) { showMcpResult({success: false, error: e.message}); });
}

// æ‰§è¡Œèµ„æºè¯»å–
function executeResource() {
    var uri = document.getElementById('mcp-resource-uri').value.trim();
    if (!uri) return;

    var pre = document.getElementById('mcp-result');
    var area = document.getElementById('mcp-result-area');
    area.style.display = 'block';
    pre.textContent = 'è¯»å–ä¸­... resources/read ' + uri;
    pre.style.borderLeft = '3px solid var(--primary-color)';

    fetch('{% url "playground:dvmcp_resource_read_api" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
        body: JSON.stringify({challenge_id: {{ challenge.id }}, uri: uri})
    })
    .then(function(r) { return r.json(); })
    .then(showMcpResult)
    .catch(function(e) { showMcpResult({success: false, error: e.message}); });
}

// æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒº
function addMessage(role, content, toolCalls) {
    var messagesEl = document.getElementById('chat-messages');
    var messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message ' + role;
    
    var avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
    var bubbleContent = escapeHtml(content);
    
    // å¤„ç†ä»£ç å—
    bubbleContent = bubbleContent.replace(/```(\w*)\n?([\s\S]*?)```/g, function(match, lang, code) {
        return '<pre><code>' + code + '</code></pre>';
    });
    
    // å¤„ç†æ¢è¡Œ
    bubbleContent = bubbleContent.replace(/\n/g, '<br>');
    
    // æ·»åŠ å·¥å…·è°ƒç”¨æ˜¾ç¤º
    var toolCallsHtml = '';
    if (toolCalls && toolCalls.length > 0) {
        toolCalls.forEach(function(tc) {
            if (tc.type === 'tool_call' || tc.tool) {
                var toolName = tc.tool || 'æœªçŸ¥å·¥å…·';
                var args = tc.arguments ? JSON.stringify(tc.arguments, null, 2) : '{}';
                
                toolCallsHtml += '<div class="tool-call-display">';
                toolCallsHtml += '<span class="tool-name">ğŸ”§ ' + toolName + '</span>';
                toolCallsHtml += '<br><small>å‚æ•°:</small><pre style="margin: 5px 0; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; font-size: 11px; overflow-x: auto;">' + args + '</pre>';
                
                // æ˜¾ç¤ºæ‰§è¡Œç»“æœ
                if (tc.executed && tc.result) {
                    if (tc.result.success) {
                        var resultStr = typeof tc.result.result === 'object' ? JSON.stringify(tc.result.result, null, 2) : tc.result.result;
                        toolCallsHtml += '<small style="color: #10b981;">âœ… æ‰§è¡ŒæˆåŠŸ</small>';
                        toolCallsHtml += '<pre style="margin: 5px 0; padding: 8px; background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 4px; font-size: 11px; overflow-x: auto; white-space: pre-wrap; word-break: break-all;">' + escapeHtml(resultStr) + '</pre>';
                    } else {
                        toolCallsHtml += '<small style="color: #ef4444;">âŒ æ‰§è¡Œå¤±è´¥: ' + escapeHtml(tc.result.error || 'æœªçŸ¥é”™è¯¯') + '</small>';
                    }
                } else if (tc.note) {
                    toolCallsHtml += '<small style="color: #f59e0b;">ğŸ’¡ ' + tc.note + '</small>';
                }
                toolCallsHtml += '</div>';
                
            } else if (tc.type === 'resource_read' || tc.resource || tc.uri) {
                var uri = tc.uri || tc.resource || 'æœªçŸ¥èµ„æº';
                
                toolCallsHtml += '<div class="tool-call-display">';
                toolCallsHtml += '<span class="tool-name">ğŸ“„ ' + uri + '</span>';
                
                // æ˜¾ç¤ºæ‰§è¡Œç»“æœ
                if (tc.executed && tc.result) {
                    if (tc.result.success) {
                        var resultStr = typeof tc.result.result === 'object' ? JSON.stringify(tc.result.result, null, 2) : tc.result.result;
                        toolCallsHtml += '<br><small style="color: #10b981;">âœ… è¯»å–æˆåŠŸ</small>';
                        toolCallsHtml += '<pre style="margin: 5px 0; padding: 8px; background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 4px; font-size: 11px; overflow-x: auto; white-space: pre-wrap; word-break: break-all;">' + escapeHtml(resultStr) + '</pre>';
                    } else {
                        toolCallsHtml += '<br><small style="color: #ef4444;">âŒ è¯»å–å¤±è´¥: ' + escapeHtml(tc.result.error || 'æœªçŸ¥é”™è¯¯') + '</small>';
                    }
                } else if (tc.note) {
                    toolCallsHtml += '<br><small style="color: #f59e0b;">ğŸ’¡ ' + tc.note + '</small>';
                }
                toolCallsHtml += '</div>';
                
            } else if (tc.error) {
                toolCallsHtml += '<div class="tool-call-display" style="border-color: #ef4444;"><span style="color: #ef4444;">âŒ é”™è¯¯: ' + tc.error + '</span></div>';
            }
        });
    }
    
    messageDiv.innerHTML = '<div class="chat-avatar">' + avatar + '</div><div class="chat-bubble">' + bubbleContent + toolCallsHtml + '</div>';
    messagesEl.appendChild(messageDiv);
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

// æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
function addTypingIndicator() {
    var messagesEl = document.getElementById('chat-messages');
    var indicatorDiv = document.createElement('div');
    indicatorDiv.className = 'chat-message assistant';
    indicatorDiv.id = 'typing-indicator';
    indicatorDiv.innerHTML = '<div class="chat-avatar">ğŸ¤–</div><div class="chat-bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div>';
    messagesEl.appendChild(indicatorDiv);
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

// ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
function removeTypingIndicator() {
    var indicator = document.getElementById('typing-indicator');
    if (indicator) {
        indicator.remove();
    }
}

// HTML è½¬ä¹‰
function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// å‘é€æ¶ˆæ¯
function sendMessage() {
    if (isWaiting) return;
    
    var input = document.getElementById('chat-input');
    var message = input.value.trim();
    if (!message) return;
    
    // ä½¿ç”¨å…¨å±€ LLM é…ç½®ï¼ˆä¸å†éœ€è¦é¡µé¢ä¸Šé€‰æ¨¡å‹ï¼‰
    var llmUrl = '';
    var llmModel = '';
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addMessage('user', message);
    chatHistory.push({ role: 'user', content: message });
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    input.value = '';
    input.style.height = 'auto';
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    isWaiting = true;
    document.getElementById('chat-send-btn').disabled = true;
    addTypingIndicator();
    
    // å‘é€è¯·æ±‚
    var requestBody = {
        challenge_id: {{ challenge.id }},
        message: message,
        history: chatHistory.slice(0, -1),
        model: llmModel,
        llm_url: llmUrl
    };
    
    console.log('å‘é€è¯·æ±‚:', requestBody);
    
    fetch('{% url "playground:dvmcp_chat_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(requestBody)
    })
    .then(function(r) {
        console.log('å“åº”çŠ¶æ€:', r.status, r.statusText);
        if (!r.ok) {
            throw new Error('HTTP ' + r.status + ' ' + r.statusText);
        }
        return r.text();  // å…ˆè·å–æ–‡æœ¬
    })
    .then(function(text) {
        console.log('å“åº”å†…å®¹:', text.substring(0, 200));
        try {
            return JSON.parse(text);
        } catch (e) {
            console.error('JSON è§£æå¤±è´¥:', e);
            throw new Error('JSON è§£æå¤±è´¥: ' + text.substring(0, 100));
        }
    })
    .then(function(data) {
        removeTypingIndicator();
        console.log('è§£æåæ•°æ®:', data);
        
        if (data && data.success) {
            addMessage('assistant', data.response, data.tool_calls);
            chatHistory.push({ role: 'assistant', content: data.response });
        } else if (data && data.error) {
            addMessage('assistant', 'âŒ é”™è¯¯: ' + data.error);
        } else {
            addMessage('assistant', 'âŒ æœªçŸ¥å“åº”æ ¼å¼: ' + JSON.stringify(data).substring(0, 100));
        }
    })
    .catch(function(err) {
        removeTypingIndicator();
        console.error('è¯·æ±‚é”™è¯¯:', err);
        addMessage('assistant', 'âŒ è¯·æ±‚å¤±è´¥: ' + err.message + '\n\nè¯·æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æŸ¥çœ‹è¯¦ç»†é”™è¯¯');
    })
    .finally(function() {
        isWaiting = false;
        document.getElementById('chat-send-btn').disabled = false;
    });
}

// è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
document.getElementById('chat-input').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ
document.getElementById('chat-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// ===== å³ä¾§è¾¹æ åŠŸèƒ½ =====

// æ˜¾ç¤ºæç¤º
function revealHint(btn) {
    var item = btn.closest('.hint-item-sidebar');
    if (item.classList.contains('revealed')) return;
    
    var mask = btn.querySelector('.hint-mask');
    var text = btn.querySelector('.hint-text');
    
    mask.style.display = 'none';
    text.style.display = 'block';
    item.classList.add('revealed');
}

// æ˜¾ç¤ºç®€è¦è§£å†³æ–¹æ¡ˆ
function showSolutionBrief() {
    var hidden = document.querySelector('.solution-hidden');
    var content = document.querySelector('.solution-content');
    
    hidden.style.display = 'none';
    content.style.display = 'block';
}

// æ˜¾ç¤ºè¯¦ç»†è§£å†³æ–¹æ¡ˆ
function showDetailedSolution() {
    var modal = document.getElementById('solutionModal');
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

// å…³é—­è¯¦ç»†è§£å†³æ–¹æ¡ˆ
function closeSolutionModal() {
    var modal = document.getElementById('solutionModal');
    modal.classList.remove('show');
    document.body.style.overflow = '';
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    refreshTools();
    initQuickPayloads();
    
    // ESC å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeSolutionModal();
        }
    });
});
</script>
{% endblock %}
