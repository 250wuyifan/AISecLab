# ============================================
# AI 安全靶场 - Docker Compose 一键部署
# 
# 包含：
#   1. 主平台 (AISecLab) - 端口 8000
#   2. DVMCP 靶场服务 - 端口 9001-9010
#
# 启动方式：docker compose up -d
# 访问地址：http://localhost:8000
# ============================================

services:
  # ========== 主平台 ==========
  web:
    build: .
    container_name: aiseclab
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - DEBUG=True
      - DJANGO_SECRET_KEY=docker-dev-secret-change-in-production
      - ALLOWED_HOSTS=*
      # macOS/Windows Docker Desktop 使用 host.docker.internal 访问宿主机
      - OPENAI_API_BASE=http://host.docker.internal:11434/v1
    volumes:
      - sqlite_data:/app/db
    depends_on:
      dvmcp:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ========== DVMCP 靶场（10 个挑战服务） ==========
  dvmcp:
    build:
      context: .
      dockerfile: dvmcp.Dockerfile
    container_name: dvmcp
    restart: unless-stopped
    ports:
      # 挑战 1-3 (Easy)
      - "9001:9001"
      - "9002:9002"
      - "9003:9003"
      # 挑战 4-7 (Medium)
      - "9004:9004"
      - "9005:9005"
      - "9006:9006"
      - "9007:9007"
      # 挑战 8-10 (Hard)
      - "9008:9008"
      - "9009:9009"
      - "9010:9010"
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.settimeout(2); s.connect(('localhost', 9001)); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

volumes:
  sqlite_data:

# ============================================
# 使用说明：
#
# 1. 启动所有服务：
#    docker compose up -d
#
# 2. 查看日志：
#    docker compose logs -f
#
# 3. 停止服务：
#    docker compose down
#
# 4. 重新构建：
#    docker compose up -d --build
#
# 5. 默认账号：
#    用户名: admin
#    密码: admin
# ============================================
