{% extends "base.html" %}

{% block content %}
<main class="container pt-3 pb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">

            <!-- æ ‡é¢˜æ  -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h5 class="fw-bold mb-1">âš™ï¸ å¤§æ¨¡å‹é…ç½®</h5>
                    <p class="text-muted mb-0 small">é…ç½® LLM æ¥å…¥ä¿¡æ¯ï¼Œé¶åœºéœ€è¦è¿æ¥å¤§æ¨¡å‹æ‰èƒ½è¿›è¡Œäº¤äº’å¼æ”»é˜²</p>
                </div>
                <a href="{% url 'playground:lab_list' %}" class="btn btn-sm btn-outline-secondary" id="backBtn" onclick="event.preventDefault(); if(document.referrer && document.referrer.indexOf('/playground/') !== -1){ history.back(); } else { location.href=this.href; }">â† è¿”å›é¶åœº</a>
            </div>

            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
            {% endif %}

            <div class="card">
                <div class="card-body p-4">
                    <!-- å¿«æ·é¢„è®¾ -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold small text-muted text-uppercase">å¿«æ·é¢„è®¾</label>
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="button" class="btn btn-sm btn-outline-secondary preset-btn"
                                data-provider="ollama"
                                data-api-base="http://127.0.0.1:11434/v1/chat/completions"
                                data-api-key=""
                                data-model="qwen2.5">
                                ğŸ¦™ Ollama æœ¬åœ°
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary preset-btn"
                                data-provider="openai"
                                data-api-base="https://api.openai.com/v1/chat/completions"
                                data-api-key=""
                                data-model="gpt-4o-mini">
                                ğŸ¤– OpenAI
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary preset-btn"
                                data-provider="deepseek"
                                data-api-base="https://api.deepseek.com/v1/chat/completions"
                                data-api-key=""
                                data-model="deepseek-chat">
                                ğŸ”® DeepSeek
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary preset-btn"
                                data-provider="siliconflow"
                                data-api-base="https://api.siliconflow.cn/v1/chat/completions"
                                data-api-key=""
                                data-model="Qwen/Qwen3-8B">
                                âš¡ ç¡…åŸºæµåŠ¨
                            </button>
                        </div>
                    </div>

                    <hr class="mb-4">

                    <form method="post">
                        {% csrf_token %}
                        {{ form.non_field_errors }}

                        <!-- æœåŠ¡æä¾›æ–¹ -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold" for="{{ form.provider.id_for_label }}">
                                æœåŠ¡æä¾›æ–¹
                            </label>
                            {{ form.provider }}
                        </div>

                        <!-- API åœ°å€ -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold" for="{{ form.api_base.id_for_label }}">
                                API åœ°å€
                            </label>
                            {{ form.api_base }}
                            <div class="form-text">å®Œæ•´çš„ Chat Completions æ¥å£åœ°å€</div>
                        </div>

                        <!-- API Key -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold" for="{{ form.api_key.id_for_label }}">
                                API Key
                            </label>
                            <div class="input-group">
                                {{ form.api_key }}
                                <button class="btn btn-outline-secondary" type="button" id="toggleKeyBtn" title="æ˜¾ç¤º/éšè—">
                                    ğŸ‘ï¸
                                </button>
                            </div>
                            <div class="form-text">ä»…ä¿å­˜åœ¨æœ¬æœºæ•°æ®åº“ï¼ŒOllama æœ¬åœ°æ¨¡å¼å¯ç•™ç©º</div>
                        </div>

                        <!-- é»˜è®¤æ¨¡å‹ -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold" for="{{ form.default_model.id_for_label }}">
                                é»˜è®¤æ¨¡å‹
                            </label>
                            {{ form.default_model }}
                            <div class="form-text">å¯åœ¨æ¯ä¸ªé¶åœºé¡µé¢ä¸´æ—¶åˆ‡æ¢å…¶ä»–æ¨¡å‹</div>
                        </div>

                        <!-- å¯ç”¨å¼€å…³ -->
                        <div class="form-check form-switch mb-4">
                            {{ form.enabled }}
                            <label class="form-check-label" for="{{ form.enabled.id_for_label }}">
                                å¯ç”¨å½“å‰é…ç½®
                            </label>
                        </div>

                        <!-- æŒ‰é’® -->
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">ğŸ’¡ æ¨èæ–°æ‰‹ä½¿ç”¨ Ollama æœ¬åœ°éƒ¨ç½²ï¼Œå…è´¹æ— éœ€ API Key</span>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary px-4">
                                    ğŸ’¾ ä¿å­˜é…ç½®
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- æµ‹è¯•è¿æ¥ï¼ˆä¿å­˜åå¯ç”¨ï¼‰ -->
                    <hr class="my-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-semibold small">ğŸ”— è¿æ¥æµ‹è¯•</span>
                            <span class="text-muted small ms-2">ä¿å­˜é…ç½®åï¼Œç‚¹å‡»æµ‹è¯•æ˜¯å¦èƒ½æ­£å¸¸è°ƒç”¨å¤§æ¨¡å‹</span>
                        </div>
                        <button type="button" class="btn btn-outline-success btn-sm px-3" id="testConnBtn">
                            â–¶ æµ‹è¯•è¿æ¥
                        </button>
                    </div>
                    <div id="testResult" class="mt-3" style="display:none;"></div>
                </div>
            </div>

        </div>
    </div>
</main>

<script>
// å¿«æ·é¢„è®¾æŒ‰é’®
document.querySelectorAll('.preset-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var provider = document.getElementById('{{ form.provider.id_for_label }}') || document.querySelector('[name="provider"]');
        var apiBase = document.getElementById('{{ form.api_base.id_for_label }}') || document.querySelector('[name="api_base"]');
        var model = document.getElementById('{{ form.default_model.id_for_label }}') || document.querySelector('[name="default_model"]');

        if (provider) provider.value = this.dataset.provider;
        if (apiBase) apiBase.value = this.dataset.apiBase;
        if (model) model.value = this.dataset.model;

        // é«˜äº®é€‰ä¸­çš„é¢„è®¾
        document.querySelectorAll('.preset-btn').forEach(function(b) {
            b.classList.remove('btn-primary');
            b.classList.add('btn-outline-secondary');
        });
        this.classList.remove('btn-outline-secondary');
        this.classList.add('btn-primary');
    });
});

// æµ‹è¯•è¿æ¥
(function() {
    var btn = document.getElementById('testConnBtn');
    var result = document.getElementById('testResult');
    if (!btn || !result) return;

    btn.addEventListener('click', function() {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>æµ‹è¯•ä¸­...';
        result.style.display = 'block';
        result.innerHTML = '<div class="alert alert-info small mb-0"><span class="spinner-border spinner-border-sm me-1"></span>æ­£åœ¨è°ƒç”¨å¤§æ¨¡å‹ï¼Œè¯·ç¨å€™...</div>';

        fetch('{% url "playground:llm_test_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value
            }
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            btn.disabled = false;
            btn.innerHTML = 'â–¶ æµ‹è¯•è¿æ¥';
            if (data.success) {
                result.innerHTML = '<div class="alert alert-success small mb-0">' +
                    '<strong>âœ… è¿æ¥æˆåŠŸï¼</strong><br>' +
                    '<span class="text-muted">æ¨¡å‹ï¼š</span>' + (data.model || 'æœªçŸ¥') + '<br>' +
                    '<span class="text-muted">å›å¤ï¼š</span><code>' + (data.reply || '(ç©º)') + '</code>' +
                    '</div>';
            } else {
                result.innerHTML = '<div class="alert alert-danger small mb-0">' +
                    '<strong>âŒ è¿æ¥å¤±è´¥</strong><br>' +
                    '<span>' + (data.error || 'æœªçŸ¥é”™è¯¯') + '</span>' +
                    '</div>';
            }
        })
        .catch(function(err) {
            btn.disabled = false;
            btn.innerHTML = 'â–¶ æµ‹è¯•è¿æ¥';
            result.innerHTML = '<div class="alert alert-danger small mb-0"><strong>âŒ è¯·æ±‚å¤±è´¥ï¼š</strong>' + err.message + '</div>';
        });
    });
})();

// API Key æ˜¾ç¤º/éšè—
(function() {
    var btn = document.getElementById('toggleKeyBtn');
    var input = document.querySelector('[name="api_key"]');
    if (!btn || !input) return;

    var hidden = true;
    var originalValue = input.value;

    // é»˜è®¤éšè—ï¼ˆå¦‚æœæœ‰å€¼ï¼‰
    if (originalValue && originalValue.length > 8) {
        input.type = 'password';
    }

    btn.addEventListener('click', function() {
        hidden = !hidden;
        input.type = hidden ? 'password' : 'text';
        btn.textContent = hidden ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
    });
})();
</script>
{% endblock %}
