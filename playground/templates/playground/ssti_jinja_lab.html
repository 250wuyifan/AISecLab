{% extends "base.html" %}

{% block extra_css %}
<style>
.lab-sidebar-list .nav-link.active { background-color: rgba(13,110,253,0.12); border-radius: 0.375rem; color: var(--primary-color); font-weight: 600; }
.code-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; padding: 12px 14px; font-family: Consolas, 'SF Mono', monospace; font-size: 13px; color: #1f2937; white-space: pre-wrap; word-break: break-all; }
html[data-theme="dark"] .code-box { background: #1e293b; border-color: #334155; color: #e2e8f0; }
</style>
{% endblock %}

{% block content %}
<main class="lab-detail-main">
    <div class="lab-detail-container">
    {% url 'playground:lab_list' as lab_list_url %}
    {% include "playground/_lab_detail_header.html" with back_url=lab_list_url back_text="返回靶场列表" title="SSTI（Jinja2 模板注入）靶场" subtitle="当 System Prompt 或配置用 Jinja2 渲染且掺入用户可控内容时，攻击者可注入模板语法，读取配置、执行命令。" show_llm_button=False %}

    {% include "playground/_lab_tools.html" with lab_slug="output_security:ssti_jinja" %}

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title mb-2">演练步骤</h5>
                <ol class="small text-muted mb-3">
                    <li>下方输入「用户自定义指令」；本靶场会将其放入 Jinja2 模板 <code>System: ... 用户自定义指令：&#123;&#123; user_instruction &#125;&#125; ...</code> 并渲染；</li>
                    <li>尝试输入：<code>&#123;&#123; 7*7 &#125;&#125;</code> 得到 49；或 <code>&#123;&#123; config.SECRET_KEY &#125;&#125;</code> 泄露密钥；或 <code>&#123;&#123; request.META.HTTP_HOST &#125;&#125;</code> 等；</li>
                    <li>观察「渲染后的 System Prompt」中是否出现注入结果。</li>
                </ol>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title mb-2">用户自定义指令（将进入 Jinja2 模板）</h5>
                <div class="mb-2">
                    <input type="text" class="form-control font-monospace" id="ssti-input" placeholder="例如: &#123;&#123; 7*7 &#125;&#125; 或 &#123;&#123; config.SECRET_KEY &#125;&#125;" value="">
                </div>
                <button type="button" class="btn btn-danger" id="ssti-submit">渲染模板</button>
                <div class="mt-3">
                    <strong>渲染后的 System Prompt：</strong>
                    <div id="ssti-result" class="code-box mt-1 min-h-1">—</div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header"><strong>怎么修复</strong></div>
            <div class="card-body small">
                <ul class="mb-0">
                    <li>用户可控内容<strong>不要</strong>进入 Jinja2 模板字符串；若必须，仅作变量传入（如 <code>&#123;&#123; user_input &#125;&#125;</code>），且模板由开发写死、不由用户提供；</li>
                    <li>禁用危险 filter、关掉不必要的全局（如 <code>config</code>、<code>request</code>）或使用沙箱环境；</li>
                    <li>对「自定义 Prompt 模板」功能做严格校验与白名单。</li>
                </ul>
            </div>
        </div>
    </div>
</main>

<script>

// 获取 CSRF Token
function getCsrfToken() {
    var c = document.cookie.match(/csrftoken=([^;]+)/);
    if (c) return c[1];
    var el = document.querySelector('[name="csrfmiddlewaretoken"]');
    return el ? el.value : '';
}
(function () {
    var inputEl = document.getElementById('ssti-input');
    var resultEl = document.getElementById('ssti-result');
    var btn = document.getElementById('ssti-submit');
    var url = '{% url "playground:ssti_jinja_demo_api" %}';

    function setResult(text, isError) {
        if (!resultEl) return;
        resultEl.textContent = text || '—';
        resultEl.style.color = isError ? 'var(--bs-danger)' : '';
    }

    if (btn && inputEl) {
        btn.addEventListener('click', function () {
            var instruction = (inputEl.value || '').trim();
            setResult('渲染中…');
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                body: JSON.stringify({ user_instruction: instruction })
            })
            .then(function (r) { return r.json(); })
            .then(function (data) {
                if (data.error) setResult('错误: ' + data.error, true);
                else setResult(data.rendered || '—');
            })
            .catch(function (e) { setResult('请求失败: ' + e.message, true); });
        });
    }
})();
</script>
{% endblock %}
