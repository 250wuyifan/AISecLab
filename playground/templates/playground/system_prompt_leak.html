{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<style>
* { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif; }

/* æœ¬é¡µä¸“å±ï¼šæŠ€å·§åˆ—è¡¨ã€èŠå¤©æ°”æ³¡ã€æ³„éœ²æˆåŠŸæç¤ºç­‰ï¼›å¸ƒå±€ä¸å¤´éƒ¨ä½¿ç”¨ lab_detail.css + _lab_detail_header */
/* æŠ€å·§åˆ—è¡¨ */
.technique-card {
    background: #fff;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.15s;
}
.technique-card:hover { background: #fafafa; }
.technique-card.active {
    border-color: var(--primary-color);
    background: #f0f5ff;
}
html[data-theme="dark"] .technique-card {
    background: var(--surface);
    border-color: var(--border-color);
}
html[data-theme="dark"] .technique-card:hover { background: var(--surface-2); }
html[data-theme="dark"] .technique-card.active {
    border-color: var(--primary-color);
    background: var(--surface-2);
}

.technique-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}
.technique-icon { font-size: 16px; }
.technique-name {
    font-size: 14px;
    font-weight: 500;
    flex: 1;
    color: var(--text);
}
html[data-theme="dark"] .technique-name { color: var(--text); }

.technique-difficulty {
    font-size: 12px;
    padding: 2px 6px;
    background: #f0f0f0;
    color: #666;
}
html[data-theme="dark"] .technique-difficulty {
    background: var(--border-color);
    color: var(--muted);
}

.technique-description {
    font-size: 13px;
    color: #666;
    margin-bottom: 8px;
    line-height: 1.4;
}
html[data-theme="dark"] .technique-description { color: var(--muted); }

.technique-payload {
    background: var(--surface-2);
    border: 1px solid var(--text);
    border-radius: 6px;
    padding: 10px;
    font-family: Consolas, 'SF Mono', monospace;
    font-size: 12px;
    white-space: pre-wrap;
    word-break: break-all;
    display: none;
    color: #333;
    margin-top: 6px;
}
.technique-card.active .technique-payload { display: block; }
html[data-theme="dark"] .technique-payload {
    background: var(--surface-2);
    border-color: var(--border-color);
    color: #ccc;
}

/* èŠå¤©å®¹å™¨ */
.chat-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 320px);
    min-height: 200px;
    max-height: 380px;
    background: #fff;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
}

html[data-theme="dark"] .chat-container {
    background: var(--surface);
    border-color: var(--border-color);
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    scroll-behavior: smooth;
}

.chat-messages::-webkit-scrollbar { width: 4px; }
.chat-messages::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
html[data-theme="dark"] .chat-messages::-webkit-scrollbar-thumb { background: #444; }

.chat-message-wrap {
    display: flex;
    margin-bottom: 16px;
    animation: msgFadeIn 0.25s ease;
}
.chat-message-wrap.user {
    justify-content: flex-end;
}
.chat-message-wrap.agent {
    justify-content: flex-start;
}

@keyframes msgFadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

.chat-message {
    display: flex;
    gap: 10px;
    max-width: 80%;
}

.chat-message.user {
    flex-direction: row-reverse;
}

.chat-message.agent {
}

.chat-avatar {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 15px;
}

.chat-message.user .chat-avatar {
    background: #dbeafe;
}
.chat-message.agent .chat-avatar {
    background: var(--surface-2);
}

html[data-theme="dark"] .chat-message.user .chat-avatar { background: #1e3a5f; }
html[data-theme="dark"] .chat-message.agent .chat-avatar { background: var(--surface-2); }

.chat-bubble {
    padding: 6px 10px;
    border-radius: 12px;
    font-size: 12.5px;
    line-height: 1.6;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.chat-message.user .chat-bubble {
    background: var(--primary-color);
    color: #fff;
    border-bottom-right-radius: 4px;
}

.chat-message.agent .chat-bubble {
    background: var(--surface-2);
    color: var(--text);
    border-bottom-left-radius: 4px;
}

html[data-theme="dark"] .chat-message.user .chat-bubble {
    background: var(--primary-color);
}

html[data-theme="dark"] .chat-message.agent .chat-bubble {
    background: var(--surface-2);
    color: var(--text);
}

.chat-bubble pre, .chat-bubble code {
    background: rgba(0,0,0,0.06);
    padding: 8px 10px;
    border-radius: 6px;
    overflow-x: auto;
    font-size: 12px;
    margin: 8px 0 0;
    font-family: 'SF Mono', Consolas, monospace;
    display: block;
    white-space: pre-wrap;
    word-break: break-all;
}

.chat-message.user .chat-bubble pre,
.chat-message.user .chat-bubble code {
    background: rgba(255,255,255,0.15);
}

html[data-theme="dark"] .chat-bubble pre,
html[data-theme="dark"] .chat-bubble code {
    background: rgba(0,0,0,0.3);
}

/* è¾“å…¥åŒº */
.chat-input-area {
    display: flex;
    gap: 8px;
    padding: 12px 14px;
    background: var(--surface-2);
    border-top: 1px solid var(--text);
    align-items: flex-end;
}

html[data-theme="dark"] .chat-input-area {
    background: var(--surface-2);
    border-top-color: var(--border-color);
}

.chat-input {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid var(--border-color);
    border-radius: 20px;
    background: #fff;
    color: var(--text);
    font-size: 13.5px;
    font-family: inherit;
    resize: none;
    min-height: 40px;
    max-height: 80px;
    line-height: 1.4;
}

.chat-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
}

html[data-theme="dark"] .chat-input {
    background: var(--surface);
    border-color: var(--border-color);
    color: var(--text);
}

html[data-theme="dark"] .chat-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
}

.chat-send-btn {
    width: 40px;
    height: 40px;
    background: var(--primary-color);
    border: none;
    border-radius: 50%;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: background 0.15s, transform 0.1s;
}

.chat-send-btn:hover {
    background: var(--primary-color);
}

.chat-send-btn:active {
    transform: scale(0.92);
}

.chat-send-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

html[data-theme="dark"] .chat-send-btn {
    background: var(--primary-color);
}

html[data-theme="dark"] .chat-send-btn:hover {
    background: var(--primary-color);
}

/* System Prompt å±•ç¤ºåŒº */
.system-prompt-content {
    font-family: Consolas, 'SF Mono', monospace;
    font-size: 13px;
    white-space: pre-wrap;
    background: var(--surface-2);
    border: 1px solid var(--text);
    padding: 12px;
    max-height: 180px;
    overflow-y: auto;
    color: #333;
}
html[data-theme="dark"] .system-prompt-content {
    background: var(--surface-2);
    border-color: var(--border-color);
    color: #ccc;
}

/* æˆåŠŸæç¤º */
.leak-success {
    background: #f0fdf4;
    border: 1px solid #86efac;
    border-radius: 8px;
    padding: 12px 14px;
    margin-top: 12px;
    display: none;
    font-size: 14px;
    color: #166534;
}
.leak-success.show {
    display: flex;
    align-items: center;
    gap: 8px;
}
html[data-theme="dark"] .leak-success {
    background: #14532d;
    border-color: #22c55e;
    color: #86efac;
}

/* éš¾åº¦æ ‡ç­¾ */
.difficulty-easy { background: #dcfce7; color: #166534; }
.difficulty-medium { background: #fef3c7; color: #92400e; }
.difficulty-hard { background: #fee2e2; color: #991b1b; }
html[data-theme="dark"] .difficulty-easy { background: #14532d; color: #86efac; }
html[data-theme="dark"] .difficulty-medium { background: #78350f; color: #fcd34d; }
html[data-theme="dark"] .difficulty-hard { background: #7f1d1d; color: #fca5a5; }
.card .card-body { padding: 6px 10px; }

</style>
{% endblock %}

{% block content %}
<main class="lab-detail-main">
    <div class="lab-detail-container">
        {% url 'playground:lab_list' as lab_list_url %}
        {% include "playground/_lab_detail_header.html" with back_url=lab_list_url back_text="è¿”å›åˆ—è¡¨" title="System Prompt æ³„éœ²é¶åœº" title_icon="ğŸ”’" subtitle="OWASP LLM07 Â· æ”»å‡»æŠ€å·§åº“ Â· éš¾åº¦ï¼šå…¥é—¨-è¿›é˜¶" show_llm_button=True %}


        {% include "playground/_llm_not_configured_alert.html" %}


        <!-- åŸç†è®²è§£ -->
        {% include "playground/_principle_panel.html" %}

        <div class="row g-2">
            <!-- å·¦ä¾§ï¼šæ”»å‡»æŠ€å·§ -->
            <div class="col-xl-2 col-lg-3">
                <div class="card">
                    <div class="card-header py-1 px-2 d-flex align-items-center" onclick="this.nextElementSibling.classList.toggle('d-none')" style="cursor:pointer">
                        <span class="me-2">ğŸ¯</span>
                        <strong>æ”»å‡»æŠ€å·§åº“</strong>
                    </div>
                    <div class="card-body" style="max-height: 550px; overflow-y: auto;">
                        {% for tech in techniques %}
                        <div class="technique-card" data-payload="{{ tech.payload|escape }}" onclick="selectTechnique(this)">
                            <div class="technique-header">
                                <span class="technique-icon">{{ tech.icon }}</span>
                                <span class="technique-name">{{ tech.name }}</span>
                                <span class="technique-difficulty difficulty-{{ tech.difficulty }}">{{ tech.difficulty_label }}</span>
                            </div>
                            <div class="technique-description">{{ tech.description }}</div>
                            <div class="technique-payload">{{ tech.payload }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´ï¼šå¯¹è¯åŒº -->
            <div class="col-xl-7 col-lg-6">
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <div class="chat-message-wrap agent">
                            <div class="chat-message agent">
                                <div class="chat-avatar">ğŸ¤–</div>
                                <div class="chat-bubble">ä½ å¥½ï¼æˆ‘æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„ï¼Ÿ<br><br><small style="color:#999;">ğŸ’¡ æç¤ºï¼šå°è¯•ä½¿ç”¨å·¦ä¾§çš„æ”»å‡»æŠ€å·§æ¥æå–æˆ‘çš„ System Prompt</small></div>
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <textarea class="chat-input" id="user-input" rows="1" placeholder="è¾“å…¥æ”»å‡» Payload æˆ–ç‚¹å‡»å·¦ä¾§æŠ€å·§..." autocomplete="off" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage();}"></textarea>
                        <button type="button" class="chat-send-btn" id="sendBtn" onclick="sendMessage()" title="å‘é€">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </div>
                </div>

                <div class="leak-success" id="leak-success">
                    <span style="font-size: 1.5rem;">ğŸ‰</span>
                    <div>
                        <strong>æˆåŠŸæ³„éœ²ï¼</strong><br>
                        <small>ä½ æˆåŠŸæå–äº† System Prompt çš„éƒ¨åˆ†æˆ–å…¨éƒ¨å†…å®¹</small>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šSystem Prompt å±•ç¤º -->
            <div class="col-xl-3 col-lg-3">
                <div class="card mb-1">
                    <div class="card-header py-1 px-2 d-flex align-items-center justify-content-between">
                        <div>
                            <span class="me-2">ğŸ”’</span>
                            <strong>ç›®æ ‡ System Prompt</strong>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleSystemPrompt()">
                            <span id="toggle-text">æ˜¾ç¤º</span>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="system-prompt-hidden" class="text-center text-muted py-4">
                            <div style="font-size: 3rem;">ğŸ”</div>
                            <p class="mb-0">System Prompt å·²éšè—</p>
                            <small>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æŸ¥çœ‹ç­”æ¡ˆ</small>
                        </div>
                        <div id="system-prompt-content" style="display: none;">
                            <pre class="system-prompt-content">{{ system_prompt }}</pre>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header py-1 px-2 d-flex align-items-center">
                        <span class="me-2">ğŸ“Š</span>
                        <strong>æ”»å‡»ç»Ÿè®¡</strong>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-1">
                            <span>å°è¯•æ¬¡æ•°</span>
                            <strong id="attempt-count">0</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span>æˆåŠŸæ³„éœ²</span>
                            <strong id="success-count" class="text-success">0</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>æ³„éœ²ç¨‹åº¦</span>
                            <strong id="leak-percentage">0%</strong>
                        </div>
                        <hr>
                        <button class="btn btn-sm btn-outline-secondary w-100" onclick="resetChat()">
                            ğŸ”„ é‡ç½®å¯¹è¯
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
const SYSTEM_PROMPT = "{{ system_prompt|escapejs }}";
let attemptCount = 0;
let successCount = 0;
let chatHistory = [];

function selectTechnique(card) {
    // å–æ¶ˆå…¶ä»–é€‰ä¸­
    document.querySelectorAll('.technique-card').forEach(c => c.classList.remove('active'));
    card.classList.add('active');
    
    // å¡«å…¥ payload
    const payload = card.dataset.payload;
    document.getElementById('user-input').value = payload;
    document.getElementById('user-input').focus();
}

function toggleSystemPrompt() {
    const hidden = document.getElementById('system-prompt-hidden');
    const content = document.getElementById('system-prompt-content');
    const toggleText = document.getElementById('toggle-text');
    
    if (hidden.style.display !== 'none') {
        hidden.style.display = 'none';
        content.style.display = 'block';
        toggleText.textContent = 'éšè—';
    } else {
        hidden.style.display = 'block';
        content.style.display = 'none';
        toggleText.textContent = 'æ˜¾ç¤º';
    }
}

function addMessage(role, content) {
    const messagesDiv = document.getElementById('chat-messages');
    const wrapDiv = document.createElement('div');
    wrapDiv.className = `chat-message-wrap ${role}`;
    const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
    wrapDiv.innerHTML = `
        <div class="chat-message ${role}">
            <div class="chat-avatar">${avatar}</div>
            <div class="chat-bubble">${content}</div>
        </div>
    `;
    messagesDiv.appendChild(wrapDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function checkLeakage(response, leakDetection) {
    // ä½¿ç”¨åç«¯çš„æ£€æµ‹ç»“æœ
    if (leakDetection && leakDetection.leaked) {
        successCount++;
        document.getElementById('success-count').textContent = successCount;
        document.getElementById('leak-percentage').textContent = leakDetection.leak_percentage + '%';
        
        // æ ¹æ®æ³„éœ²çº§åˆ«æ˜¾ç¤ºä¸åŒçš„æç¤º
        const successDiv = document.getElementById('leak-success');
        successDiv.classList.add('show');
        
        let levelText = '';
        let levelClass = '';
        switch (leakDetection.leak_level) {
            case 'full':
                levelText = 'å®Œå…¨æ³„éœ²ï¼å‘ç°æ•æ„Ÿå‡­æ®';
                levelClass = 'text-danger';
                break;
            case 'significant':
                levelText = 'ä¸¥é‡æ³„éœ²ï¼å¤šä¸ªæ•æ„Ÿä¿¡æ¯æš´éœ²';
                levelClass = 'text-warning';
                break;
            case 'partial':
                levelText = 'éƒ¨åˆ†æ³„éœ²';
                levelClass = 'text-info';
                break;
            default:
                levelText = 'æ£€æµ‹åˆ°æ³„éœ²';
        }
        
        // æ˜¾ç¤ºæ³„éœ²çš„å…·ä½“å†…å®¹
        let detailHtml = `<strong class="${levelClass}">${levelText}</strong><br>`;
        if (leakDetection.leaked_elements && leakDetection.leaked_elements.length > 0) {
            detailHtml += `<small>æ³„éœ²å†…å®¹: ${leakDetection.leaked_elements.join(', ')}</small>`;
        }
        successDiv.querySelector('div').innerHTML = detailHtml;
        
        return true;
    }
    
    document.getElementById('leak-percentage').textContent = (leakDetection?.leak_percentage || 0) + '%';
    return false;
}

async function sendMessage() {
    console.log('sendMessage called');
    const input = document.getElementById('user-input');
    if (!input) {
        console.error('user-input not found');
        return;
    }
    const message = input.value.trim();
    console.log('message:', message);
    if (!message) return;
    
    // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    addMessage('user', message);
    input.value = '';
    attemptCount++;
    document.getElementById('attempt-count').textContent = attemptCount;
    
    // æ·»åŠ åˆ°å†å²
    chatHistory.push({role: 'user', content: message});
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    addMessage('agent', '<div class="spinner-border spinner-border-sm me-2"></div>æ€è€ƒä¸­...');
    
    try {
        const apiUrl = '{% url "playground:system_prompt_leak_api" %}';
        console.log('Fetching:', apiUrl);
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                message: message,
                history: chatHistory
            })
        });
        
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        // ç§»é™¤åŠ è½½çŠ¶æ€
        const messages = document.getElementById('chat-messages');
        messages.removeChild(messages.lastChild);
        
        if (data.success) {
            addMessage('agent', data.response);
            chatHistory.push({role: 'assistant', content: data.response});
            checkLeakage(data.response, data.leak_detection);
        } else {
            addMessage('agent', 'âŒ ' + (data.error || 'è¯·æ±‚å¤±è´¥'));
        }
    } catch (error) {
        console.error('Fetch error:', error);
        const messages = document.getElementById('chat-messages');
        messages.removeChild(messages.lastChild);
        addMessage('agent', 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message);
    }
}

// textarea è‡ªåŠ¨é«˜åº¦
(function() {
    var ta = document.getElementById('user-input');
    if (!ta) return;
    ta.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 80) + 'px';
    });
})();

function resetChat() {
    chatHistory = [];
    document.getElementById('chat-messages').innerHTML = `<div class="chat-message-wrap agent"><div class="chat-message agent"><div class="chat-avatar">ğŸ¤–</div><div class="chat-bubble">ä½ å¥½ï¼æˆ‘æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„ï¼Ÿ<br><br><small style="color:#999;">ğŸ’¡ æç¤ºï¼šå°è¯•ä½¿ç”¨å·¦ä¾§çš„æ”»å‡»æŠ€å·§æ¥æå–æˆ‘çš„ System Prompt</small></div></div></div>`;
    document.getElementById('leak-success').classList.remove('show');
}
</script>
{% endblock %}
