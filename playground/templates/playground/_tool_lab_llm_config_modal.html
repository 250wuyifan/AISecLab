<!-- é¶åœºé…ç½®å¼¹å±‚ï¼šAJAX åŠ è½½é…ç½®ï¼Œæ— éœ€æ¯ä¸ªè§†å›¾ä¼  config_form -->
<div class="modal fade" id="llmConfigModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">âš™ï¸ å¤§æ¨¡å‹é…ç½®</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="llmConfigModalBody">
        <div class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
          <span class="ms-2 text-muted">åŠ è½½é…ç½®...</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
    var modal = document.getElementById('llmConfigModal');
    if (!modal) return;
    var loaded = false;

    modal.addEventListener('show.bs.modal', function() {
        if (loaded) return;
        var body = document.getElementById('llmConfigModalBody');

        fetch('{% url "playground:llm_config" %}', {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(r) { return r.text(); })
        .then(function(html) {
            // ä»è¿”å›çš„ HTML ä¸­æå–è¡¨å•éƒ¨åˆ†
            var tmp = document.createElement('div');
            tmp.innerHTML = html;
            var card = tmp.querySelector('.card-body') || tmp.querySelector('form') || tmp;

            body.innerHTML = '<form method="post" action="{% url "playground:llm_config" %}">' +
                '<input type="hidden" name="csrfmiddlewaretoken" value="' + getCsrf() + '">' +
                extractFormFields(card) +
                '<div class="d-flex justify-content-between align-items-center mt-3">' +
                '  <span class="text-muted small">ğŸ’¡ Ollama æœ¬åœ°å…è´¹æ— éœ€ Key</span>' +
                '  <button type="submit" class="btn btn-primary btn-sm px-3">ğŸ’¾ ä¿å­˜</button>' +
                '</div>' +
                '</form>';

            // å¿«æ·é¢„è®¾
            body.querySelectorAll('.preset-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var f = body.querySelector('form');
                    var p = f.querySelector('[name="provider"]');
                    var a = f.querySelector('[name="api_base"]');
                    var m = f.querySelector('[name="default_model"]');
                    if (p) p.value = this.dataset.provider;
                    if (a) a.value = this.dataset.apiBase;
                    if (m) m.value = this.dataset.model;
                });
            });

            loaded = true;
        })
        .catch(function() {
            body.innerHTML = '<div class="text-center py-4">' +
                '<p class="text-muted">åŠ è½½å¤±è´¥ï¼Œè¯·ç›´æ¥è®¿é—® <a href="{% url "playground:llm_config" %}">é…ç½®é¡µé¢</a></p>' +
                '</div>';
        });
    });

    function getCsrf() {
        var c = document.cookie.match(/csrftoken=([^;]+)/);
        if (c) return c[1];
        var el = document.querySelector('[name="csrfmiddlewaretoken"]');
        return el ? el.value : '';
    }

    function extractFormFields(container) {
        // æå–å¿«æ·é¢„è®¾å’Œè¡¨å•å­—æ®µ
        var presets = '<div class="mb-3">' +
            '<label class="form-label fw-semibold small text-muted">å¿«æ·é¢„è®¾</label>' +
            '<div class="d-flex gap-2 flex-wrap">' +
            '<button type="button" class="btn btn-sm btn-outline-secondary preset-btn" data-provider="ollama" data-api-base="http://127.0.0.1:11434/v1/chat/completions" data-model="qwen2.5">ğŸ¦™ Ollama</button>' +
            '<button type="button" class="btn btn-sm btn-outline-secondary preset-btn" data-provider="openai" data-api-base="https://api.openai.com/v1/chat/completions" data-model="gpt-4o-mini">ğŸ¤– OpenAI</button>' +
            '<button type="button" class="btn btn-sm btn-outline-secondary preset-btn" data-provider="deepseek" data-api-base="https://api.deepseek.com/v1/chat/completions" data-model="deepseek-chat">ğŸ”® DeepSeek</button>' +
            '<button type="button" class="btn btn-sm btn-outline-secondary preset-btn" data-provider="siliconflow" data-api-base="https://api.siliconflow.cn/v1/chat/completions" data-model="Qwen/Qwen3-8B">âš¡ ç¡…åŸºæµåŠ¨</button>' +
            '</div></div><hr class="my-3">';

        // æå–è¡¨å•å†…çš„æ‰€æœ‰ .mb-3 å’Œ .form-check å…ƒç´ 
        var fields = container.querySelectorAll('.mb-3, .mb-4, .form-check');
        var html = presets;
        fields.forEach(function(f) {
            // è·³è¿‡å¿«æ·é¢„è®¾å’ŒæŒ‰é’®åŒºåŸŸ
            if (f.querySelector('.preset-btn') || f.querySelector('[type="submit"]')) return;
            html += f.outerHTML;
        });
        return html;
    }
})();
</script>
