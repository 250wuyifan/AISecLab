{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'vendor/simplemde/simplemde.min.css' %}">
<link rel="stylesheet" href="{% static 'vendor/fontawesome/font-awesome.min.css' %}">
<style>
/* 知识面板使用全宽布局 */
    main.panel-main {
        margin-left: 0 !important;
        max-width: 100% !important;
    }

    #sidebarMenu {
        display: none !important;
    }

/* 页面头部 */
.panel-header {
    background: var(--surface);
    border-bottom: 1px solid var(--border-color);
    padding: 1.5rem 0;
    margin-bottom: 2rem;
}

html[data-theme="dark"] .panel-header {
    background: var(--surface);
    border-bottom-color: rgba(99, 102, 241, 0.15);
}

.panel-title {
    font-size: 1.75rem;
    font-weight: 800;
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: var(--text);
}

.panel-title-icon {
    width: 42px;
    height: 42px;
    border-radius: 10px;
    background: var(--primary-glow);
    display: flex;
    align-items: center;
    justify-content: center;
}

.panel-title-icon svg {
    width: 22px;
    height: 22px;
    color: var(--primary-color);
}

html[data-theme="dark"] .panel-title-icon {
    background: rgba(0, 245, 255, 0.15);
}

html[data-theme="dark"] .panel-title-icon svg {
    color: var(--neon-cyan);
}

.panel-subtitle {
    color: var(--muted);
    font-size: 0.9rem;
}

/* 大纲树容器 */
.outline-container {
    background: var(--surface);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    overflow: hidden;
}

html[data-theme="dark"] .outline-container {
    background: var(--surface);
    border-color: rgba(99, 102, 241, 0.15);
}

.outline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border-color);
    background: var(--surface-2);
}

html[data-theme="dark"] .outline-header {
    background: rgba(99, 102, 241, 0.05);
    border-bottom-color: rgba(99, 102, 241, 0.1);
}

.outline-header-title {
    font-weight: 700;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.outline-header-title svg {
    width: 18px;
    height: 18px;
    color: var(--primary-color);
}

html[data-theme="dark"] .outline-header-title svg {
    color: var(--neon-cyan);
}

.outline-stats {
    font-size: 0.8rem;
    color: var(--muted);
    background: var(--surface);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    border: 1px solid var(--border-color);
}

html[data-theme="dark"] .outline-stats {
    background: rgba(99, 102, 241, 0.1);
    border-color: rgba(99, 102, 241, 0.2);
}

.outline-body {
    padding: 1rem;
}

/* 大纲树 */
.outline-tree {
    list-style: none;
    margin: 0;
    padding: 0;
}

/* 分类节点 */
.category-node {
    margin-bottom: 0.75rem;
}

.category-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-radius: 10px;
    background: var(--surface-2);
    border: 1px solid var(--border-color);
    transition: all 0.2s ease;
}

.category-header:hover {
    border-color: var(--primary-color);
    background: var(--primary-glow);
}

html[data-theme="dark"] .category-header {
    background: rgba(99, 102, 241, 0.05);
    border-color: rgba(99, 102, 241, 0.15);
}

html[data-theme="dark"] .category-header:hover {
    background: rgba(0, 245, 255, 0.1);
    border-color: var(--neon-cyan);
}

.category-toggle {
    background: transparent;
    border: none;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.category-toggle:hover {
    background: var(--surface);
    color: var(--text);
}

.category-toggle svg {
    width: 16px;
    height: 16px;
    transition: transform 0.2s ease;
}

.category-toggle.collapsed svg {
    transform: rotate(-90deg);
}

.category-icon {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    background: var(--primary-glow);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.category-icon svg {
    width: 14px;
    height: 14px;
    color: var(--primary-color);
}

html[data-theme="dark"] .category-icon {
    background: rgba(0, 245, 255, 0.15);
}

html[data-theme="dark"] .category-icon svg {
    color: var(--neon-cyan);
}

.category-info {
    flex: 1;
    min-width: 0;
}

.category-name {
    font-weight: 600;
    color: var(--text);
    font-size: 0.95rem;
}

.category-count {
    font-size: 0.75rem;
    color: var(--muted);
    margin-left: 0.5rem;
}

.category-actions {
    display: flex;
    gap: 0.5rem;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.category-header:hover .category-actions {
    opacity: 1;
}

/* 文章列表 */
.topic-list {
    list-style: none;
    margin: 0.5rem 0 0 2.5rem;
    padding: 0;
    border-left: 2px solid var(--border-color);
}

html[data-theme="dark"] .topic-list {
    border-left-color: rgba(99, 102, 241, 0.2);
}

.topic-list.collapsed {
    display: none;
}

.topic-item {
    position: relative;
    margin: 0.25rem 0;
}

.topic-item::before {
    content: '';
    position: absolute;
    left: -2px;
    top: 50%;
    width: 12px;
    height: 2px;
    background: var(--border-color);
}

html[data-theme="dark"] .topic-item::before {
    background: rgba(99, 102, 241, 0.2);
}

.topic-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    margin-left: 0.75rem;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.topic-row:hover {
    background: var(--primary-glow);
}

html[data-theme="dark"] .topic-row:hover {
    background: rgba(0, 245, 255, 0.1);
}

.topic-icon {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--primary-color);
    flex-shrink: 0;
}

html[data-theme="dark"] .topic-icon {
    background: var(--neon-cyan);
}

.topic-link {
    flex: 1;
    color: var(--text);
    text-decoration: none;
    font-size: 0.9rem;
    transition: color 0.2s ease;
}

.topic-link:hover {
    color: var(--primary-color);
}

html[data-theme="dark"] .topic-link:hover {
    color: var(--neon-cyan);
}

.topic-level {
    font-size: 0.7rem;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    background: var(--surface-2);
    color: var(--muted);
}

.topic-actions {
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.topic-row:hover .topic-actions {
    opacity: 1;
}

.topic-actions .btn {
    padding: 0.2rem 0.5rem;
    font-size: 0.75rem;
}

/* 空状态 */
.empty-topics {
    padding: 0.5rem 0.75rem;
    margin-left: 1.5rem;
    color: var(--muted);
    font-size: 0.85rem;
    font-style: italic;
}

/* 空分类状态 */
.empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--muted);
}

.empty-state svg {
    width: 48px;
    height: 48px;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* 弹窗内的 SimpleMDE 编辑器 */
#createTopicModal .CodeMirror, 
#createTopicModal .CodeMirror-scroll {
    min-height: 200px;
    max-height: 300px;
}

#createTopicModal .editor-toolbar {
    border-top: 1px solid var(--border-color);
    border-left: 1px solid var(--border-color);
    border-right: 1px solid var(--border-color);
    border-radius: 4px 4px 0 0;
}

#createTopicModal .CodeMirror {
    border-radius: 0 0 4px 4px;
}

/* 按钮样式优化 */
.btn-icon {
    padding: 0.25rem 0.5rem;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.btn-icon svg {
    width: 14px;
    height: 14px;
}
</style>
{% endblock %}

{% block content %}
<main class="panel-main">
    <!-- 页面头部 -->
    <div class="panel-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
            <div>
                    <h1 class="panel-title">
                        <span class="panel-title-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                        </span>
                        知识面板
                    </h1>
                    <p class="panel-subtitle">管理 AI 安全知识库的分类与文章</p>
            </div>
            <div class="d-flex gap-2">
                    <a class="btn btn-outline-secondary btn-sm" href="{% url 'learning:index' %}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        返回学习
                    </a>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createCategoryModal">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        新建分类
                    </button>
                </div>
            </div>
            </div>
        </div>

    <div class="container">
        <!-- 大纲树 -->
        <div class="outline-container">
            <div class="outline-header">
                <div class="outline-header-title">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    知识库大纲
                </div>
                <span class="outline-stats">{{ categories|length }} 个分类</span>
                    </div>
            <div class="outline-body">
                {% if categories %}
                        <ul class="outline-tree">
                            {% for c in categories %}
                    <li class="category-node">
                        <div class="category-header">
                            <button type="button" class="category-toggle" data-target="cat-{{ c.id }}" aria-expanded="true">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <span class="category-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </span>
                            <div class="category-info">
                                <span class="category-name">{{ c.name }}</span>
                                <span class="category-count">{{ c.topics.all|length }} 篇</span>
                                    </div>
                            <div class="category-actions">
                                <button type="button" class="btn btn-sm btn-outline-success btn-icon"
                                        data-bs-toggle="modal" data-bs-target="#createTopicModal" data-cat-id="{{ c.id }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                    新增
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary btn-icon"
                                        data-bs-toggle="modal" data-bs-target="#editCategoryModal"
                                        data-cat-id="{{ c.id }}" data-cat-name="{{ c.name }}" data-cat-desc="{{ c.description }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                    编辑
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger btn-icon"
                                        data-bs-toggle="modal" data-bs-target="#deleteCategoryModal"
                                        data-cat-id="{{ c.id }}" data-cat-name="{{ c.name }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                    删除
                                </button>
                                    </div>
                                </div>

                        <ul class="topic-list" id="cat-{{ c.id }}">
                                    {% for t in c.topics.all %}
                            <li class="topic-item">
                                <div class="topic-row">
                                    <span class="topic-icon"></span>
                                    <a class="topic-link" href="{% url 'learning:topic_detail' t.id %}">{{ t.title }}</a>
                                    <span class="topic-level">{{ t.get_level_display }}</span>
                                    <div class="topic-actions">
                                        <a class="btn btn-sm btn-outline-primary btn-icon" href="{% url 'learning:topic_update' t.id %}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                            </svg>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-danger btn-icon"
                                                data-bs-toggle="modal" data-bs-target="#deleteTopicModal"
                                                data-topic-id="{{ t.id }}" data-topic-title="{{ t.title|escape }}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            </svg>
                                                </button>
                                            </div>
                                        </div>
                            </li>
                            {% empty %}
                            <li class="empty-topics">暂无文章，点击上方"新增"添加</li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% endfor %}
                        </ul>
                {% else %}
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                        <line x1="12" y1="11" x2="12" y2="17"></line>
                        <line x1="9" y1="14" x2="15" y2="14"></line>
                    </svg>
                    <p class="mb-2">暂无分类</p>
                    <p class="small">点击右上角"新建分类"开始创建知识结构</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</main>

<!-- 删除文章确认弹窗 -->
<div class="modal fade" id="deleteTopicModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post">
        <div class="modal-body">
          {% csrf_token %}
          <input type="hidden" name="action" value="delete_topic">
          <input type="hidden" name="topic_id" id="deleteTopicId">
                    <p class="mb-2">确定要删除文章 <strong id="deleteTopicTitle"></strong> 吗？</p>
          <p class="text-danger small mb-0">此操作不可恢复。</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-danger">确认删除</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 编辑分类弹窗 -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">编辑分类</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post">
        <div class="modal-body">
          {% csrf_token %}
          <input type="hidden" name="action" value="edit_category">
          <input type="hidden" name="category_id" id="editCategoryId">
          <div class="mb-3">
            <label for="editCategoryName" class="form-label">分类名称</label>
            <input type="text" class="form-control" id="editCategoryName" name="name" required>
          </div>
          <div class="mb-3">
            <label for="editCategoryDesc" class="form-label">描述（可选）</label>
            <textarea class="form-control" id="editCategoryDesc" name="description" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 删除分类确认弹窗 -->
<div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">确认删除分类</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post">
        <div class="modal-body">
          {% csrf_token %}
          <input type="hidden" name="action" value="delete_category">
          <input type="hidden" name="category_id" id="deleteCategoryId">
          <p class="mb-2">确定要删除分类 <strong id="deleteCategoryName"></strong> 吗？</p>
          <p class="text-danger small mb-0">该分类下的所有文章也将被删除，此操作不可恢复！</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-danger">确认删除</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 新建分类弹窗 -->
<div class="modal fade" id="createCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">新建分类</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post">
        <div class="modal-body">
          {% csrf_token %}
          <input type="hidden" name="action" value="create_category">
          <div class="mb-3">
            <label class="form-label" for="{{ category_form.name.id_for_label }}">分类名称</label>
            {{ category_form.name }}
          </div>
          <div class="mb-3">
                        <label class="form-label" for="{{ category_form.description.id_for_label }}">描述（可选）</label>
            {{ category_form.description }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">创建</button>
        </div>
      </form>
    </div>
  </div>
  </div>

<!-- 新建文章弹窗 -->
<div class="modal fade" id="createTopicModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
                <h5 class="modal-title">新建文章</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" enctype="multipart/form-data" id="createTopicForm">
        <div class="modal-body">
          {% csrf_token %}
          <input type="hidden" name="action" value="create_topic">
                    <div class="row g-3 mb-3">
            <div class="col-md-6">
                            <label class="form-label">所属分类</label>
              {{ topic_form.category }}
            </div>
            <div class="col-md-6">
                            <label class="form-label">难度等级</label>
              {{ topic_form.level }}
            </div>
          </div>
          <div class="mb-3">
                        <label class="form-label">标题</label>
            {{ topic_form.title }}
          </div>
          <div class="mb-3">
                        <label class="form-label">上传 Markdown（可选）</label>
            {{ topic_form.markdown_file }}
                        <div class="form-text">上传后会自动填充内容</div>
          </div>
          <div class="mb-3">
                        <label class="form-label">内容</label>
            {{ topic_form.content }}
          </div>
          <div class="mb-3">
                        <label class="form-label">作者（可选）</label>
            {{ topic_form.author_name }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">创建</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// 分类折叠/展开
document.addEventListener('click', function(e) {
    var btn = e.target.closest('.category-toggle');
        if (!btn) return;
    
    var targetId = btn.getAttribute('data-target');
    var list = document.getElementById(targetId);
    if (!list) return;
    
    var isExpanded = btn.getAttribute('aria-expanded') === 'true';
    btn.setAttribute('aria-expanded', !isExpanded);
    btn.classList.toggle('collapsed', isExpanded);
    list.classList.toggle('collapsed', isExpanded);
});

// 记录点击"新增"的分类 ID
document.addEventListener('click', function(e) {
    var btn = e.target.closest('[data-cat-id][data-bs-target="#createTopicModal"]');
    if (btn) {
        window.__panelCatId = btn.getAttribute('data-cat-id');
    }
    });

// 弹窗打开时预选分类
    var topicModal = document.getElementById('createTopicModal');
    if (topicModal) {
    topicModal.addEventListener('show.bs.modal', function() {
            var sel = document.getElementById('id_category');
        if (sel && window.__panelCatId) {
            sel.value = window.__panelCatId;
        }
    });
}

    // 删除文章弹窗填充
var deleteModal = document.getElementById('deleteTopicModal');
if (deleteModal) {
    deleteModal.addEventListener('show.bs.modal', function(e) {
        var btn = e.relatedTarget;
        if (!btn) return;
        var id = btn.getAttribute('data-topic-id');
        var title = btn.getAttribute('data-topic-title') || '';
        document.getElementById('deleteTopicId').value = id;
        document.getElementById('deleteTopicTitle').textContent = title;
    });
}

// 编辑分类弹窗填充
var editCatModal = document.getElementById('editCategoryModal');
if (editCatModal) {
    editCatModal.addEventListener('show.bs.modal', function(e) {
        var btn = e.relatedTarget;
        if (!btn) return;
        document.getElementById('editCategoryId').value = btn.getAttribute('data-cat-id') || '';
        document.getElementById('editCategoryName').value = btn.getAttribute('data-cat-name') || '';
        document.getElementById('editCategoryDesc').value = btn.getAttribute('data-cat-desc') || '';
    });
}

// 删除分类弹窗填充
var deleteCatModal = document.getElementById('deleteCategoryModal');
if (deleteCatModal) {
    deleteCatModal.addEventListener('show.bs.modal', function(e) {
        var btn = e.relatedTarget;
        if (!btn) return;
        document.getElementById('deleteCategoryId').value = btn.getAttribute('data-cat-id') || '';
        document.getElementById('deleteCategoryName').textContent = btn.getAttribute('data-cat-name') || '';
    });
}
</script>

<script src="{% static 'vendor/simplemde/simplemde.min.js' %}"></script>
<script>
var topicModalEl = document.getElementById('createTopicModal');
var simplemde = null;

if (topicModalEl) {
    topicModalEl.addEventListener('shown.bs.modal', function() {
        var textareaEl = document.getElementById("id_content");
        if (textareaEl && !simplemde) {
            simplemde = new SimpleMDE({ 
                element: textareaEl,
                spellChecker: false,
                placeholder: "输入 Markdown 内容...",
                status: false,
                forceSync: true,
                autoDownloadFontAwesome: false,
                toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "image", "|", "preview"],
            });
            setTimeout(function() {
                if (simplemde && simplemde.codemirror) simplemde.codemirror.refresh();
            }, 100);
        } else if (simplemde && simplemde.codemirror) {
            simplemde.codemirror.refresh();
        }
    });
    
    topicModalEl.addEventListener('hidden.bs.modal', function() {
        if (simplemde) simplemde.value('');
        var form = document.getElementById('createTopicForm');
        if (form) form.reset();
    });
}

var createForm = document.getElementById('createTopicForm');
if (createForm) {
    createForm.addEventListener('submit', function() {
        if (simplemde && simplemde.codemirror) simplemde.codemirror.save();
    });
}

var fileInput = document.getElementById("id_markdown_file");
if (fileInput) {
    fileInput.addEventListener("change", function() {
        var f = fileInput.files && fileInput.files[0];
        if (!f) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            var text = (e && e.target && e.target.result) ? String(e.target.result) : "";
            if (simplemde) {
                simplemde.value(text);
                simplemde.codemirror.save();
            } else {
                var textareaEl = document.getElementById("id_content");
                if (textareaEl) textareaEl.value = text;
            }
            var titleEl = document.getElementById("id_title");
            if (titleEl && !titleEl.value) {
                var m = text.match(/^#\s+(.+)\s*$/m);
                if (m && m[1]) titleEl.value = m[1].trim();
            }
        };
        reader.readAsText(f, "utf-8");
    });
}
</script>
{% endblock %}
